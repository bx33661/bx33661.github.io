---
import IconMoon from "@/assets/icons/IconMoon.svg";
import IconSearch from "@/assets/icons/IconSearch.svg";
import IconSunHigh from "@/assets/icons/IconSunHigh.svg";
import IconArchive from "@/assets/icons/IconArchive.svg";
import IconGallery from "@/assets/icons/IconGallery.svg";
import { SITE } from "@/config.ts";

const { pathname } = Astro.url;

// Remove trailing slash from current pathname if exists
const currentPath =
  pathname.endsWith("/") && pathname !== "/" ? pathname.slice(0, -1) : pathname;

const isActive = (path: string) => {
  const currentPathArray = currentPath.split("/").filter(p => p.trim());
  const pathArray = path.split("/").filter(p => p.trim());

  return currentPath === path || currentPathArray[0] === pathArray[0];
};

const isArchiveQuickActive =
  currentPath === "/archives" ||
  currentPath.startsWith("/archives/") ||
  currentPath === "/archive" ||
  currentPath.startsWith("/archive/");

const isGalleryQuickActive =
  currentPath === "/galleries" ||
  currentPath.startsWith("/galleries/") ||
  currentPath === "/album" ||
  currentPath.startsWith("/album/");

const siteLogo = "/logonew.jpg";
const brandText = SITE.title.trim();
const brandSplitIndex = Math.max(1, Math.floor(brandText.length / 2));
const brandHead = brandText.slice(0, brandSplitIndex);
const brandTail = brandText.slice(brandSplitIndex);
---

<a
  id="skip-to-content"
  href="#main-content"
  class="absolute start-16 -top-full z-50 rounded-b-lg bg-accent px-4 py-2 font-medium text-background transition-all focus:top-0"
>
  Skip to content
</a>

<header class="header-glass sticky top-0 z-40 w-full">
  <div class="app-layout">
    <div
      id="top-nav-wrap"
      class:list={[
        "py-3 sm:py-4",
        "relative w-full",
        "flex items-center justify-between",
      ]}
    >
      <!-- Logo -->
      <a
        href="/"
        class="group relative z-20 flex items-center gap-2.5 text-xl font-bold tracking-tight sm:text-2xl"
      >
        <img
          src={siteLogo}
          alt={`${SITE.title} logo`}
          class="site-brand-logo size-8 rounded-md border border-border/35 bg-background/90 object-cover p-0.5"
          loading="eager"
          decoding="async"
        />
        <span class="nav-logo-word" aria-label={SITE.title}>
          <span>{brandHead}</span>
          {brandTail && <span class="nav-logo-brace" aria-hidden="true">{`{}`}</span>}
          <span>{brandTail}</span>
        </span>
      </a>

      <!-- Nav area -->
      <nav id="nav-menu" class="flex items-center sm:gap-1">
        <!-- Mobile hamburger (animated lines) -->
        <button
          id="menu-btn"
          class="hamburger-btn sm:hidden"
          aria-label="Open menu"
          aria-expanded="false"
          aria-controls="mobile-menu"
        >
          <div class="hamburger-box">
            <span class="hamburger-line hamburger-line--1"></span>
            <span class="hamburger-line hamburger-line--2"></span>
            <span class="hamburger-line hamburger-line--3"></span>
          </div>
        </button>

        <!-- Desktop links (always visible on sm+) -->
        <ul class="hidden sm:flex sm:flex-row sm:items-center sm:gap-1">
          <li>
            <a
              href="/blog"
              class:list={["nav-link", { "nav-active": isActive("/blog") }]}
              >Posts</a
            >
          </li>
          <li>
            <a
              href="/tags"
              class:list={["nav-link", { "nav-active": isActive("/tags") }]}
              >Tags</a
            >
          </li>
          <li>
            <a
              href="/notes"
              class:list={["nav-link", { "nav-active": isActive("/notes") }]}
              >Notes</a
            >
          </li>
          <li>
            <a
              href="/about"
              class:list={["nav-link", { "nav-active": isActive("/about") }]}
              >About</a
            >
          </li>
          <li>
            <a
              href="/friends"
              class:list={["nav-link", { "nav-active": isActive("/friends") }]}
              >Friends</a
            >
          </li>
          <li>
            <a
              href="/search"
              class:list={["nav-link", { "nav-active": isActive("/search") }]}
              title="Search page">Search</a
            >
          </li>

          {
            (SITE.showArchives || SITE.showGalleries) && (
              <li class="flex items-center">
                <div class="nav-quick-switch" role="group" aria-label="Archive and gallery shortcuts">
                  {
                    SITE.showArchives && (
                      <a
                        href="/archives/"
                        title="Archives"
                        aria-label="Archives"
                        class:list={["nav-quick-btn", { active: isArchiveQuickActive }]}
                      >
                        <IconArchive class="size-4.5" />
                      </a>
                    )
                  }
                  {
                    SITE.showGalleries && (
                      <a
                        href="/galleries/"
                        title="Galleries"
                        aria-label="Galleries"
                        class:list={["nav-quick-btn", { active: isGalleryQuickActive }]}
                      >
                        <IconGallery class="size-4.5" />
                      </a>
                    )
                  }
                </div>
              </li>
            )
          }

          <li class="flex items-center px-1" aria-hidden="true">
            <div class="h-4 w-px bg-border/30"></div>
          </li>

          <li class="flex items-center">
            <button
              data-search-trigger
              class="nav-search-btn"
              title="Search (⌘K)"
              aria-label="Open search"
            >
              <IconSearch class="size-4.5" />
              <kbd class="nav-kbd">⌘K</kbd>
            </button>
          </li>

          {
            SITE.lightAndDarkMode && (
              <li class="flex items-center">
                <button
                  id="theme-btn"
                  class="nav-icon-btn relative"
                  title="Toggle theme"
                  aria-label="auto"
                  aria-live="polite"
                >
                  <IconMoon class="absolute top-1/2 left-1/2 -translate-1/2 scale-100 rotate-0 transition-all duration-300 dark:scale-0 dark:-rotate-90" />
                  <IconSunHigh class="absolute top-1/2 left-1/2 -translate-1/2 scale-0 rotate-90 transition-all duration-300 dark:scale-100 dark:rotate-0" />
                </button>
              </li>
            )
          }
        </ul>
      </nav>
    </div>
  </div>

  <!-- ===================== MOBILE DROPDOWN MENU ===================== -->
  <div id="mobile-menu" class="mobile-menu sm:hidden" aria-hidden="true">
    <!-- Glass inner panel -->
    <div class="mobile-menu-inner app-layout">
      <nav class="mobile-nav-links">
        <a
          href="/blog"
          class:list={["mobile-nav-link", { active: isActive("/blog") }]}
          style="--i:0"
        >
          <span class="mobile-nav-indicator"></span>
          <span>Posts</span>
        </a>
        <a
          href="/tags"
          class:list={["mobile-nav-link", { active: isActive("/tags") }]}
          style="--i:1"
        >
          <span class="mobile-nav-indicator"></span>
          <span>Tags</span>
        </a>
        <a
          href="/notes"
          class:list={["mobile-nav-link", { active: isActive("/notes") }]}
          style="--i:2"
        >
          <span class="mobile-nav-indicator" />
          <span>Notes</span>
        </a>
        <a
          href="/about"
          class:list={["mobile-nav-link", { active: isActive("/about") }]}
          style="--i:3"
        >
          <span class="mobile-nav-indicator" />
          <span>About</span>
        </a>
        <a
          href="/friends"
          class:list={["mobile-nav-link", { active: isActive("/friends") }]}
          style="--i:4"
        >
          <span class="mobile-nav-indicator" />
          <span>Friends</span>
        </a>
        <a
          href="/search"
          class:list={["mobile-nav-link", { active: isActive("/search") }]}
          style="--i:5"
        >
          <span class="mobile-nav-indicator" />
          <span>Search</span>
        </a>
        <a
          href="/archives"
          class:list={["mobile-nav-link", { active: isArchiveQuickActive }]}
          style="--i:6"
        >
          <span class="mobile-nav-indicator" />
          <span>Archives</span>
        </a>
        <a
          href="/galleries"
          class:list={["mobile-nav-link", { active: isGalleryQuickActive }]}
          style="--i:7"
        >
          <span class="mobile-nav-indicator" />
          <span>Galleries</span>
        </a>
      </nav>

      <!-- Divider -->
      <div class="mobile-menu-divider"></div>

      <!-- Bottom action row -->
      <div class="mobile-menu-actions">
        <button
          data-search-trigger
          class="mobile-action-btn"
          title="Search (⌘K)"
          aria-label="Open search"
        >
          <IconSearch class="size-4" />
          <span>Search</span>
        </button>
        {
          SITE.lightAndDarkMode && (
            <button
              id="theme-btn-mobile"
              class="mobile-action-btn"
              title="Toggle theme"
              aria-label="auto"
              aria-live="polite"
            >
              <IconMoon class="block size-4 dark:hidden" />
              <IconSunHigh class="hidden size-4 dark:block" />
              <span class="block dark:hidden">Dark mode</span>
              <span class="hidden dark:block">Light mode</span>
            </button>
          )
        }
      </div>
    </div>
  </div>

  <!-- Bottom border with gradient -->
  <div
    class="header-border-line h-px w-full bg-linear-to-r from-transparent via-border/40 to-transparent"
  >
  </div>
</header>

<style>
  /* ─── Header Glass ─── */
  .header-glass {
    background: color-mix(in srgb, var(--background) 80%, transparent);
    backdrop-filter: blur(16px) saturate(180%);
    -webkit-backdrop-filter: blur(16px) saturate(180%);
  }

  .site-brand-logo {
    box-shadow: 0 0 0 1px color-mix(in srgb, var(--border) 35%, transparent);
  }

  .nav-logo-word {
    display: inline-flex;
    align-items: baseline;
    letter-spacing: 0.01em;
    color: color-mix(in srgb, var(--foreground) 94%, transparent);
  }

  .nav-logo-brace {
    margin: 0 0.08em;
    color: color-mix(in srgb, var(--accent) 72%, #b86167);
  }

  .group:hover .site-brand-logo {
    transform: scale(1.04);
    box-shadow:
      0 0 0 1px color-mix(in srgb, var(--accent) 30%, transparent),
      0 6px 16px -8px color-mix(in srgb, var(--accent) 40%, transparent);
  }

  .group:hover .nav-logo-word {
    color: color-mix(in srgb, var(--foreground) 100%, transparent);
  }

  /* ─── Desktop nav links ─── */
  .nav-link {
    position: relative;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--foreground);
    border-radius: 0.5rem;
    transition: all 0.2s ease;
  }

  .nav-link:hover {
    color: var(--accent);
    background: color-mix(in srgb, var(--accent) 8%, transparent);
  }

  .nav-active {
    color: var(--accent);
    background: color-mix(in srgb, var(--accent) 10%, transparent);
  }

  .nav-active::after {
    content: "";
    position: absolute;
    bottom: 0.125rem;
    left: 50%;
    transform: translateX(-50%);
    width: 1rem;
    height: 2px;
    border-radius: 1px;
    background: var(--accent);
  }

  .nav-icon-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 2rem;
    height: 2rem;
    border-radius: 0.5rem;
    transition: all 0.2s ease;
    color: var(--foreground);
  }

  .nav-icon-btn:hover {
    color: var(--accent);
    background: color-mix(in srgb, var(--accent) 8%, transparent);
  }

  .nav-quick-switch {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
  }

  .nav-quick-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 2rem;
    height: 2rem;
    border-radius: 0.55rem;
    border: 1px solid color-mix(in srgb, var(--border) 44%, transparent);
    background: color-mix(in srgb, var(--muted) 28%, transparent);
    color: color-mix(in srgb, var(--foreground) 78%, transparent);
    transition: all 0.2s ease;
  }

  .nav-quick-btn:hover {
    color: var(--accent);
    background: color-mix(in srgb, var(--accent) 12%, transparent);
  }

  .nav-quick-btn.active {
    color: var(--accent);
    background: color-mix(in srgb, var(--accent) 18%, transparent);
    box-shadow: inset 0 -2px 0 color-mix(in srgb, var(--accent) 80%, transparent);
  }

  /* ─── Desktop Search Button with ⌘K ─── */
  .nav-search-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.3rem 0.5rem 0.3rem 0.5rem;
    font-size: 0.8125rem;
    font-weight: 500;
    color: var(--muted-foreground);
    border: 1px solid color-mix(in srgb, var(--border) 50%, transparent);
    border-radius: 0.5rem;
    background: color-mix(in srgb, var(--muted) 40%, transparent);
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .nav-search-btn:hover {
    color: var(--accent);
    border-color: color-mix(in srgb, var(--accent) 30%, transparent);
    background: color-mix(in srgb, var(--accent) 8%, transparent);
  }

  .nav-kbd {
    display: inline-flex;
    align-items: center;
    font-family: inherit;
    font-size: 0.6875rem;
    font-weight: 600;
    line-height: 1;
    padding: 0.15rem 0.35rem;
    border-radius: 0.25rem;
    border: 1px solid color-mix(in srgb, var(--border) 50%, transparent);
    background: color-mix(in srgb, var(--background) 80%, transparent);
    color: var(--muted-foreground);
    box-shadow: 0 1px 0 color-mix(in srgb, var(--border) 50%, transparent);
  }

  .nav-search-btn:hover .nav-kbd {
    border-color: color-mix(in srgb, var(--accent) 30%, transparent);
    color: var(--accent);
  }

  /* ─── Animated Hamburger Button ─── */
  .hamburger-btn {
    position: relative;
    z-index: 20;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 2.5rem;
    height: 2.5rem;
    border-radius: 0.625rem;
    border: 1px solid transparent;
    background: transparent;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    cursor: pointer;
  }

  @media (min-width: 640px) {
    .hamburger-btn {
      display: none;
    }
  }

  .hamburger-btn:hover,
  .hamburger-btn[aria-expanded="true"] {
    background: color-mix(in srgb, var(--accent) 10%, transparent);
    border-color: color-mix(in srgb, var(--accent) 15%, transparent);
  }

  .hamburger-box {
    position: relative;
    width: 18px;
    height: 14px;
  }

  .hamburger-line {
    position: absolute;
    left: 0;
    display: block;
    width: 100%;
    height: 2px;
    border-radius: 2px;
    background: var(--foreground);
    transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .hamburger-line--1 {
    top: 0;
  }
  .hamburger-line--2 {
    top: 6px;
  }
  .hamburger-line--3 {
    top: 12px;
    width: 60%;
  }

  /* Open state: morph to X */
  .hamburger-btn[aria-expanded="true"] .hamburger-line {
    background: var(--accent);
  }
  .hamburger-btn[aria-expanded="true"] .hamburger-line--1 {
    top: 6px;
    transform: rotate(45deg);
  }
  .hamburger-btn[aria-expanded="true"] .hamburger-line--2 {
    opacity: 0;
    transform: scaleX(0);
  }
  .hamburger-btn[aria-expanded="true"] .hamburger-line--3 {
    top: 6px;
    width: 100%;
    transform: rotate(-45deg);
  }

  /* ─── Mobile Menu Panel ─── */
  .mobile-menu {
    position: relative;
    overflow: hidden;
    max-height: 0;
    opacity: 0;
    background: color-mix(in srgb, var(--background) 80%, transparent);
    backdrop-filter: blur(16px) saturate(180%);
    -webkit-backdrop-filter: blur(16px) saturate(180%);
    transition:
      max-height 0.45s cubic-bezier(0.4, 0, 0.2, 1),
      opacity 0.35s ease;
  }

  .mobile-menu.is-open {
    max-height: 420px;
    opacity: 1;
  }

  /* ─── Mobile Menu Inner (glass card) ─── */
  .mobile-menu-inner {
    position: relative;
    z-index: 2;
    padding-top: 0.5rem;
    padding-bottom: 1.25rem;
  }

  /* ─── Mobile Nav Links ─── */
  .mobile-nav-links {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .mobile-nav-link {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    font-size: 1.05rem;
    font-weight: 500;
    color: var(--foreground);
    border-radius: 0.75rem;
    transition: all 0.25s ease;
    /* Stagger entrance */
    opacity: 0;
    transform: translateY(8px);
  }

  .mobile-menu.is-open .mobile-nav-link {
    opacity: 1;
    transform: translateY(0);
    transition-delay: calc(0.08s * var(--i, 0) + 0.12s);
  }

  .mobile-nav-link:hover {
    color: var(--accent);
    background: color-mix(in srgb, var(--accent) 8%, transparent);
  }

  .mobile-nav-link.active {
    color: var(--accent);
    background: color-mix(in srgb, var(--accent) 10%, transparent);
  }

  .mobile-nav-indicator {
    display: block;
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: color-mix(in srgb, var(--foreground) 20%, transparent);
    transition: all 0.25s ease;
    flex-shrink: 0;
  }

  .mobile-nav-link.active .mobile-nav-indicator {
    background: var(--accent);
    box-shadow: 0 0 8px color-mix(in srgb, var(--accent) 50%, transparent);
  }

  .mobile-nav-link:hover .mobile-nav-indicator {
    background: var(--accent);
  }

  /* ─── Menu Divider ─── */
  .mobile-menu-divider {
    margin: 0.625rem 1rem;
    height: 1px;
    background: linear-gradient(
      90deg,
      transparent,
      color-mix(in srgb, var(--border) 30%, transparent),
      transparent
    );
  }

  /* ─── Mobile Action Buttons ─── */
  .mobile-menu-actions {
    display: flex;
    gap: 0.5rem;
    padding: 0 1rem;
    /* Stagger delay (after nav links) */
    opacity: 0;
    transform: translateY(6px);
    transition: all 0.3s ease;
  }

  .mobile-menu.is-open .mobile-menu-actions {
    opacity: 1;
    transform: translateY(0);
    transition-delay: 0.35s;
  }

  .mobile-action-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    font-size: 0.8125rem;
    font-weight: 500;
    color: var(--foreground);
    border-radius: 0.625rem;
    border: 1px solid color-mix(in srgb, var(--border) 20%, transparent);
    background: color-mix(in srgb, var(--background) 50%, transparent);
    backdrop-filter: blur(8px);
    transition: all 0.2s ease;
    cursor: pointer;
  }

  .mobile-action-btn:hover {
    color: var(--accent);
    border-color: color-mix(in srgb, var(--accent) 30%, transparent);
    background: color-mix(in srgb, var(--accent) 8%, transparent);
  }
</style>

<script>
  let headerCleanup: AbortController | null = null;

  function setupMobileNav() {
    // Cleanup previous listeners
    if (headerCleanup) headerCleanup.abort();
    headerCleanup = new AbortController();
    const { signal } = headerCleanup;

    const menuBtn = document.querySelector("#menu-btn");
    const mobileMenu = document.querySelector("#mobile-menu");

    if (!menuBtn || !mobileMenu) return;

    menuBtn.addEventListener(
      "click",
      () => {
        const isOpen = menuBtn.getAttribute("aria-expanded") === "true";

        menuBtn.setAttribute("aria-expanded", isOpen ? "false" : "true");
        menuBtn.setAttribute("aria-label", isOpen ? "Open menu" : "Close menu");

        mobileMenu.classList.toggle("is-open");
        mobileMenu.setAttribute("aria-hidden", isOpen ? "true" : "false");
      },
      { signal }
    );

    // Close mobile menu on link click
    mobileMenu.querySelectorAll("a").forEach(link => {
      link.addEventListener(
        "click",
        () => {
          menuBtn.setAttribute("aria-expanded", "false");
          menuBtn.setAttribute("aria-label", "Open menu");
          mobileMenu.classList.remove("is-open");
          mobileMenu.setAttribute("aria-hidden", "true");
        },
        { signal }
      );
    });
  }

  // Initial load
  setupMobileNav();

  // Runs on view transitions navigation
  document.addEventListener("astro:after-swap", setupMobileNav);
</script>
