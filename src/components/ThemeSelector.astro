---
import { Icon } from 'astro-icon/components'

const themes = [
  { value: "light", label: "Light" },
  { value: "midnight", label: "Midnight" },
  { value: "retro", label: "Retro" },
];
---

<div class="dropdown dropdown-end">
  <div tabindex="0" role="button" class="btn btn-ghost btn-circle" aria-label="Theme Selector">
    <Icon name="lucide:palette" class="w-5 h-5" />
  </div>
  <ul
    tabindex="0"
    class="dropdown-content menu bg-base-100 rounded-box z-[1] w-52 p-2 shadow-lg"
  >
    {
      themes.map((theme) => (
        <li>
          <label class="flex items-center gap-2 cursor-pointer">
            <input
              type="radio"
              name="theme"
              class="theme-controller radio radio-sm"
              value={theme.value}
            />
            <span>{theme.label}</span>
          </label>
        </li>
      ))
    }
  </ul>
</div>

<script is:inline>
  const EVENT_NAME = "bx-theme-change"
  const SUPPORTED_THEMES = new Set(["light", "midnight", "retro"])
  const DARK_THEMES = new Set(["midnight"])

  const getFallbackTheme = () => {
    const root = document.documentElement
    const mode = root.dataset.colorMode
    if (mode && SUPPORTED_THEMES.has(mode)) return mode
    if (root.dataset.theme === "retro") return "retro"
    return root.dataset.theme === "dark" || root.classList.contains("dark")
      ? "midnight"
      : "light"
  }

  const getActiveTheme = () => {
    const api = window.__BX_THEME__
    if (api && typeof api.get === "function") {
      return api.get()
    }
    return getFallbackTheme()
  }

  const updateThemeRadios = () => {
    const activeTheme = getActiveTheme()
    const radios = document.querySelectorAll('input[type="radio"][name="theme"]')
    radios.forEach((radio) => {
      radio.checked = radio.value === activeTheme
    })
  }

  const handleThemeChangeEvent = (event) => {
    const theme = event?.detail?.theme
    if (typeof theme !== "string" || !SUPPORTED_THEMES.has(theme)) return
    const radios = document.querySelectorAll('input[type="radio"][name="theme"]')
    radios.forEach((radio) => {
      radio.checked = radio.value === theme
    })
  }

  const handleThemeRadioChange = (event) => {
    const target = event.target
    if (!(target instanceof HTMLInputElement)) return
    if (target.type !== "radio" || target.name !== "theme") return

    const nextTheme = target.value
    if (!SUPPORTED_THEMES.has(nextTheme)) return
    const api = window.__BX_THEME__

    if (api && typeof api.set === "function") {
      api.set(nextTheme)
      return
    }

    const root = document.documentElement
    const darkTheme = DARK_THEMES.has(nextTheme)
    root.dataset.theme = nextTheme === "midnight" ? "dark" : nextTheme
    root.dataset.colorMode = nextTheme
    root.classList.toggle("dark", darkTheme)
    root.style.colorScheme = darkTheme ? "dark" : "light"

    try {
      localStorage.setItem("theme", nextTheme)
    } catch {
      // ignore
    }
  }

  const bindThemeSelector = () => {
    if (!window.__BX_THEME_SELECTOR_BOUND__) {
      document.addEventListener("change", handleThemeRadioChange)
      window.addEventListener(EVENT_NAME, handleThemeChangeEvent)
      window.__BX_THEME_SELECTOR_BOUND__ = true
    }
    updateThemeRadios()
  }

  bindThemeSelector()
  if (!window.__BX_THEME_SELECTOR_SWAP_BOUND__) {
    document.addEventListener("astro:after-swap", bindThemeSelector)
    window.__BX_THEME_SELECTOR_SWAP_BOUND__ = true
  }
</script>
