---
import { Icon } from 'astro-icon/components'
import { THEME_OPTIONS } from '@/config/theme'
---

<div class="dropdown dropdown-end">
  <div tabindex="0" role="button" class="btn btn-ghost btn-circle" aria-label="Theme Selector">
    <Icon name="lucide:palette" class="w-5 h-5" />
  </div>
  <ul
    tabindex="0"
    class="dropdown-content menu bg-base-100 rounded-box z-[1] w-52 p-2 shadow-lg"
  >
    {
      THEME_OPTIONS.map((theme) => (
        <li>
          <label class="flex items-center gap-2 cursor-pointer">
            <input
              type="radio"
              name="theme"
              class="theme-controller radio radio-sm"
              value={theme.value}
            />
            <span>{theme.label}</span>
          </label>
        </li>
      ))
    }
  </ul>
</div>

<script>
  import {
    DARK_THEME_NAMES,
    THEME_CHANGE_EVENT,
    THEME_STORAGE_KEY,
    isSupportedTheme,
    sanitizeTheme,
    resolveDaisyTheme,
  } from '@/config/theme'

  const EVENT_NAME = THEME_CHANGE_EVENT
  const DARK_THEMES = new Set(DARK_THEME_NAMES)

  const getFallbackTheme = () => {
    const root = document.documentElement
    const mode = sanitizeTheme(root.dataset.colorMode)
    if (mode) return mode

    const daisyTheme = root.dataset.theme === 'dark' ? 'midnight' : root.dataset.theme
    const mapped = sanitizeTheme(daisyTheme)
    if (mapped) return mapped

    return root.classList.contains('dark') ? 'midnight' : 'light'
  }

  const getActiveTheme = () => {
    const api = window.__BX_THEME__
    if (api && typeof api.get === "function") {
      return api.get()
    }
    return getFallbackTheme()
  }

  const updateThemeRadios = () => {
    const activeTheme = getActiveTheme()
    const radios = document.querySelectorAll<HTMLInputElement>('input[type="radio"][name="theme"]')
    radios.forEach((radio) => {
      radio.checked = radio.value === activeTheme
    })
  }

  const handleThemeChangeEvent = (event: Event) => {
    const detail = (event as CustomEvent<{ theme?: ThemeName }>).detail
    const theme = detail?.theme
    if (!isSupportedTheme(theme)) return
    const radios = document.querySelectorAll<HTMLInputElement>('input[type="radio"][name="theme"]')
    radios.forEach((radio) => {
      radio.checked = radio.value === theme
    })
  }

  const handleThemeRadioChange = (event: Event) => {
    const target = event.target
    if (!(target instanceof HTMLInputElement)) return
    if (target.type !== "radio" || target.name !== "theme") return

    const nextTheme = target.value
    if (!isSupportedTheme(nextTheme)) return
    const api = window.__BX_THEME__

    if (api && typeof api.set === "function") {
      api.set(nextTheme)
      return
    }

    const root = document.documentElement
    const darkTheme = DARK_THEMES.has(nextTheme)
    root.dataset.theme = resolveDaisyTheme(nextTheme)
    root.dataset.colorMode = nextTheme
    root.classList.toggle("dark", darkTheme)
    root.style.colorScheme = darkTheme ? "dark" : "light"

    try {
      localStorage.setItem(THEME_STORAGE_KEY, nextTheme)
    } catch {
      // ignore
    }

    window.dispatchEvent(
      new CustomEvent(EVENT_NAME, {
        detail: {
          theme: nextTheme,
          daisyTheme: resolveDaisyTheme(nextTheme),
          isDark: darkTheme,
        },
      }),
    )
  }

  const bindThemeSelector = () => {
    if (!window.__BX_THEME_SELECTOR_BOUND__) {
      document.addEventListener("change", handleThemeRadioChange)
      window.addEventListener(EVENT_NAME, handleThemeChangeEvent)
      window.__BX_THEME_SELECTOR_BOUND__ = true
    }
    updateThemeRadios()
  }

  bindThemeSelector()
  if (!window.__BX_THEME_SELECTOR_SWAP_BOUND__) {
    document.addEventListener("astro:after-swap", bindThemeSelector)
    window.__BX_THEME_SELECTOR_SWAP_BOUND__ = true
  }
</script>
