---
import { SITE } from '@/consts'
import type { CollectionEntry } from 'astro:content'

interface Props {
  post: CollectionEntry<'blog'>
  slug?: string
  noindex?: boolean
}

const { post, slug, noindex = false } = Astro.props

const title = post.data.title || SITE.title
const description = post.data.description || SITE.description
const resolvedSlug = slug || post.data.slug || post.id.split('/').pop()?.replace(/\.(md|mdx)$/, '') || post.id
const postUrl = new URL(`/blog/${resolvedSlug}/`, SITE.href).toString()
const fallbackImage = new URL('/ogImage.png', SITE.href).toString()
const image = post?.data?.image?.src
  ? new URL(post.data.image.src, SITE.href).toString()
  : new URL(`/image/${resolvedSlug}.png`, SITE.href).toString()
const author = post.data.authors ? post.data.authors.join(', ') : SITE.author
const fullTitle = `${title} - ${SITE.title}`
---

<title>{fullTitle}</title>
<meta name="description" content={description} />
<link rel="canonical" href={postUrl} />
{noindex ? (
  <meta name="robots" content="noindex, nofollow" />
) : (
  <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1" />
)}

<meta name="author" content={author} />
{post?.data.tags && <meta name="keywords" content={post.data.tags.join(', ')} />}

<meta property="og:title" content={fullTitle} />
<meta property="og:description" content={description} />
<meta property="og:image" content={image || fallbackImage} />
<meta property="og:image:alt" content={title} />
<meta property="og:image:width" content="1200" />
<meta property="og:image:height" content="630" />
<meta property="og:type" content="article" />
<meta property="og:locale" content={SITE.locale} />
<meta property="og:site_name" content={SITE.title} />
<meta property="og:url" content={postUrl} />
<meta property="article:published_time" content={post.data.date.toISOString()} />
<meta property="article:modified_time" content={post.data.date.toISOString()} />
<meta property="article:author" content={author} />
<meta property="article:section" content="技术博客" />
{
  post?.data.tags &&
    post.data.tags.map((tag: string) => {
      return <meta property="article:tag" content={tag} />
    })
}

<meta name="twitter:title" content={fullTitle} />
<meta name="twitter:description" content={description} />
<meta property="twitter:image" content={image || fallbackImage} />
<meta name="twitter:image:alt" content={title} />
<meta name="twitter:card" content="summary_large_image" />

<script
  type="application/ld+json"
  is:inline
  set:html={JSON.stringify({
    '@context': 'https://schema.org',
    '@type': 'BlogPosting',
    headline: title,
    description,
    image: {
      '@type': 'ImageObject',
      url: image || fallbackImage,
      width: 1200,
      height: 630,
    },
    author: {
      '@type': 'Person',
      name: author,
      url: SITE.href,
      sameAs: ['https://github.com/bx33661'],
    },
    publisher: {
      '@type': 'Organization',
      name: SITE.title,
      logo: {
        '@type': 'ImageObject',
        url: new URL('/logo.ico', SITE.href).toString(),
      },
    },
    datePublished: post.data.date.toISOString(),
    dateModified: post.data.date.toISOString(),
    mainEntityOfPage: {
      '@type': 'WebPage',
      '@id': postUrl,
    },
    keywords: post?.data.tags ? post.data.tags.join(', ') : '',
    url: postUrl,
    inLanguage: 'zh-CN',
  })}
/>

<link rel="prefetch" href="/blog/" />
{post?.data.tags &&
  post.data.tags.map((tag) => <link rel="prefetch" href={`/tags/${encodeURIComponent(tag)}/`} />)}
