---
import "@pagefind/default-ui/css/ui.css";
---

<!-- ===================================================
     Search Modal Overlay
=================================================== -->
<div
  id="search-modal"
  class="sm-overlay"
  role="dialog"
  aria-modal="true"
  aria-label="站内搜索"
>
  <!-- Backdrop with blur -->
  <div class="sm-backdrop" data-search-close></div>

  <!-- Modal card -->
  <div class="sm-card" data-modal-card>

    <!-- Background effects (aria-hidden) -->
    <div class="sm-bg" aria-hidden="true">
      <div class="sm-orb sm-orb-1"></div>
      <div class="sm-orb sm-orb-2"></div>
      <div class="sm-orb sm-orb-3"></div>
    </div>
    <div class="sm-cursor-glow" data-sm-glow aria-hidden="true"></div>
    <div class="sm-border-spin" aria-hidden="true"></div>
    <div class="sm-shimmer" aria-hidden="true"></div>

    <!-- Sparkles -->
    <div class="sm-sparkles" aria-hidden="true">
      <span class="sm-sp sm-sp-1"></span>
      <span class="sm-sp sm-sp-2"></span>
      <span class="sm-sp sm-sp-3"></span>
      <span class="sm-sp sm-sp-4"></span>
      <span class="sm-sp sm-sp-5"></span>
    </div>

    <!-- ===== Header ===== -->
    <header class="sm-header">
      <div class="sm-header-left">
        <span class="sm-icon-wrap" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"
            class="size-3.5">
            <circle cx="11" cy="11" r="8"></circle>
            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
          </svg>
        </span>
        <span class="sm-title">搜索</span>
      </div>

      <div class="sm-header-right">
        <div class="sm-shortcuts" aria-label="键盘快捷键提示">
          <kbd class="sm-kbd">⌘</kbd>
          <kbd class="sm-kbd">K</kbd>
          <span class="sm-shortcut-sep" aria-hidden="true">·</span>
          <kbd class="sm-kbd sm-kbd-esc">esc</kbd>
          <span class="sm-shortcut-hint">关闭</span>
        </div>
        <button
          class="sm-close"
          data-search-close
          aria-label="关闭搜索"
          type="button"
        >
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
            class="size-4">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
    </header>

    <!-- ===== Search body ===== -->
    <div class="sm-body" role="search">
      <div id="modal-pagefind-search"></div>

      <!-- Empty / idle state -->
      <div class="sm-empty" data-sm-empty aria-live="polite">
        <div class="sm-empty-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"
            class="size-12">
            <circle cx="11" cy="11" r="8"></circle>
            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
          </svg>
          <div class="sm-empty-ring" aria-hidden="true"></div>
        </div>
        <p class="sm-empty-text">输入关键词，快速查找文章、笔记与技术记录</p>
        <div class="sm-empty-tags" aria-label="热门标签建议">
          <span class="sm-tag">Security</span>
          <span class="sm-tag">CTF</span>
          <span class="sm-tag">Tools</span>
          <span class="sm-tag">Notes</span>
        </div>
      </div>
    </div>

    <!-- ===== Footer ===== -->
    <footer class="sm-footer">
      <div class="sm-footer-hints" aria-label="键盘操作提示">
        <span class="sm-hint">
          <kbd class="sm-hint-key" aria-label="回车键">↵</kbd>
          <span>打开</span>
        </span>
        <span class="sm-hint-sep" aria-hidden="true"></span>
        <span class="sm-hint">
          <kbd class="sm-hint-key" aria-label="上下方向键">↑↓</kbd>
          <span>切换</span>
        </span>
        <span class="sm-hint-sep" aria-hidden="true"></span>
        <span class="sm-hint">
          <kbd class="sm-hint-key">Tab</kbd>
          <span>导航</span>
        </span>
      </div>
      <div class="sm-footer-powered" aria-label="搜索技术">
        powered by <strong>pagefind</strong>
      </div>
    </footer>
  </div>
</div>

<!-- ===================================================
     Scripts
=================================================== -->
<script>
  let smCleanup: AbortController | null = null;

  function initSearchModal() {
    if (smCleanup) smCleanup.abort();
    smCleanup = new AbortController();
    const { signal } = smCleanup;

    const modal = document.getElementById("search-modal");
    if (!modal) return;

    const card = modal.querySelector("[data-modal-card]") as HTMLElement | null;
    const glow = modal.querySelector("[data-sm-glow]") as HTMLElement | null;
    const emptyState = modal.querySelector("[data-sm-empty]") as HTMLElement | null;
    let pagefindLoaded = false;

    // --- Cursor-follow glow on card ---
    if (card && glow) {
      card.addEventListener("mousemove", (e: MouseEvent) => {
        requestAnimationFrame(() => {
          const r = card.getBoundingClientRect();
          glow.style.setProperty("--gx", `${e.clientX - r.left}px`);
          glow.style.setProperty("--gy", `${e.clientY - r.top}px`);
          glow.style.opacity = "1";
        });
      }, { signal });

      card.addEventListener("mouseleave", () => {
        glow.style.opacity = "0";
      }, { signal });
    }

    // --- Open / close helpers ---
    function openModal() {
      modal!.classList.add("active");
      document.body.style.overflow = "hidden";

      if (!pagefindLoaded) {
        loadPagefind();
        pagefindLoaded = true;
      }

      // Auto-focus input after animation
      setTimeout(() => {
        modal!.querySelector<HTMLInputElement>(".pagefind-ui__search-input")?.focus();
      }, 120);
    }

    function closeModal() {
      modal!.classList.remove("active");
      document.body.style.overflow = "";
    }

    // --- Keyboard navigation within modal ---
    modal.addEventListener("keydown", (e: KeyboardEvent) => {
      const isInput = document.activeElement?.classList.contains("pagefind-ui__search-input");
      const links = Array.from(modal.querySelectorAll<HTMLElement>(".pagefind-ui__result-link"));
      const current = links.indexOf(document.activeElement as HTMLElement);

      if (e.key === "ArrowDown") {
        e.preventDefault();
        if (isInput && links.length) links[0].focus();
        else if (current >= 0 && current < links.length - 1) links[current + 1].focus();
      } else if (e.key === "ArrowUp") {
        e.preventDefault();
        if (current > 0) links[current - 1].focus();
        else if (current === 0) modal.querySelector<HTMLInputElement>(".pagefind-ui__search-input")?.focus();
      } else if (e.key === "Enter" && current >= 0) {
        links[current].click();
      }
    }, { signal });

    // --- Load pagefind ---
    async function loadPagefind() {
      const container = document.getElementById("modal-pagefind-search");
      if (!container) return;

      if (import.meta.env.DEV) {
        container.innerHTML = `
          <div class="sm-dev-notice">
            <strong>开发模式</strong> — 请先构建站点后再使用搜索。
            <code>npm run build</code>
          </div>`;
      }

      const onIdle = window.requestIdleCallback || ((cb: () => void) => setTimeout(cb, 1));
      onIdle(async () => {
        // @ts-expect-error — Missing types for @pagefind/default-ui
        const { PagefindUI } = await import("@pagefind/default-ui");
        new PagefindUI({ element: "#modal-pagefind-search", showImages: false, showSubResults: true });

        const input = modal!.querySelector<HTMLInputElement>(".pagefind-ui__search-input");
        if (input && emptyState) {
          input.addEventListener("input", () => {
            const hasQuery = input.value.trim().length > 0;
            emptyState.style.display = hasQuery ? "none" : "";
          }, { signal });
        }

        if (modal!.classList.contains("active")) {
          setTimeout(() => input?.focus(), 200);
        }
      });
    }

    // --- Tag click fills search ---
    modal.querySelectorAll(".sm-tag").forEach(tag => {
      tag.addEventListener("click", () => {
        const input = modal!.querySelector<HTMLInputElement>(".pagefind-ui__search-input");
        if (input) {
          input.value = tag.textContent?.trim() ?? "";
          input.dispatchEvent(new Event("input", { bubbles: true }));
          input.focus();
        }
      }, { signal });
    });

    // --- Close triggers ---
    modal.querySelectorAll("[data-search-close]").forEach(el => {
      el.addEventListener("click", closeModal, { signal });
    });

    // --- Global keyboard shortcuts ---
    document.addEventListener("keydown", (e: KeyboardEvent) => {
      if (e.key === "Escape" && modal.classList.contains("active")) {
        e.preventDefault();
        closeModal();
      }
    }, { signal });

    document.addEventListener("keydown", (e: KeyboardEvent) => {
      if ((e.metaKey || e.ctrlKey) && e.key === "k") {
        e.preventDefault();
        modal.classList.contains("active") ? closeModal() : openModal();
      }
    }, { signal });

    // --- External triggers (search-trigger buttons) ---
    document.querySelectorAll("[data-search-trigger]").forEach(el => {
      el.addEventListener("click", (e: Event) => {
        e.preventDefault();
        openModal();
      }, { signal });
    });

    // --- Close on result link click ---
    modal.addEventListener("click", (e: Event) => {
      if ((e.target as HTMLElement).closest(".pagefind-ui__result-link")) {
        closeModal();
      }
    }, { signal });
  }

  initSearchModal();
  document.addEventListener("astro:after-swap", initSearchModal);
</script>

<!-- ===================================================
     Scoped styles
=================================================== -->
<style>
  /* ===== Overlay ===== */
  .sm-overlay {
    position: fixed;
    inset: 0;
    z-index: 100;
    display: flex;
    align-items: flex-start;
    justify-content: center;
    padding: min(10vh, 5rem) 1rem 1rem;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.22s ease, visibility 0.22s ease;
  }
  .sm-overlay.active {
    opacity: 1;
    visibility: visible;
  }

  /* ===== Backdrop ===== */
  .sm-backdrop {
    position: fixed;
    inset: 0;
    background: color-mix(in srgb, var(--background) 75%, transparent);
    backdrop-filter: blur(8px) saturate(1.2);
    -webkit-backdrop-filter: blur(8px) saturate(1.2);
  }

  /* ===== Card ===== */
  .sm-card {
    position: relative;
    width: 100%;
    max-width: 680px;
    max-height: 80vh;
    display: flex;
    flex-direction: column;
    border-radius: 1.375rem;
    border: 1px solid color-mix(in srgb, var(--accent) 18%, transparent);
    background: color-mix(in srgb, var(--foreground) 3%, var(--background));
    overflow: hidden;
    box-shadow:
      0 0 0 1px color-mix(in srgb, var(--accent) 5%, transparent),
      0 4px 16px color-mix(in srgb, var(--background) 50%, transparent),
      0 24px 70px -12px color-mix(in srgb, var(--background) 60%, transparent),
      0 0 120px -20px color-mix(in srgb, var(--accent) 14%, transparent);
    transform: scale(0.94) translateY(-16px);
    transition: transform 0.32s cubic-bezier(0.34, 1.56, 0.64, 1);
  }
  .sm-overlay.active .sm-card {
    transform: scale(1) translateY(0);
  }

  /* ===== Background layer ===== */
  .sm-bg {
    position: absolute;
    inset: 0;
    pointer-events: none;
    overflow: hidden;
    border-radius: inherit;
    z-index: 0;
  }

  /* Aurora orbs */
  .sm-orb {
    position: absolute;
    border-radius: 50%;
    filter: blur(70px);
    will-change: transform;
    opacity: 0.55;
  }
  .sm-orb-1 {
    width: 300px; height: 300px;
    top: -45%; left: -18%;
    background: radial-gradient(circle,
      color-mix(in srgb, var(--accent) 28%, transparent),
      transparent 70%);
    animation: sm-orb1 6.5s ease-in-out infinite alternate;
  }
  .sm-orb-2 {
    width: 230px; height: 230px;
    top: 15%; right: -12%;
    background: radial-gradient(circle,
      color-mix(in srgb, var(--border) 22%, transparent),
      transparent 70%);
    animation: sm-orb2 8.5s ease-in-out infinite alternate;
  }
  .sm-orb-3 {
    width: 190px; height: 190px;
    bottom: -35%; left: 38%;
    background: radial-gradient(circle,
      color-mix(in srgb, var(--accent) 16%, transparent),
      transparent 70%);
    animation: sm-orb3 11s ease-in-out infinite alternate;
  }
  @keyframes sm-orb1 { to { transform: translate(55px, 35px) scale(1.3); } }
  @keyframes sm-orb2 { to { transform: translate(-45px, 25px) scale(1.2); } }
  @keyframes sm-orb3 { to { transform: translate(30px, -22px) scale(1.18); } }

  /* Cursor glow */
  .sm-cursor-glow {
    position: absolute;
    width: 380px; height: 380px;
    border-radius: 50%;
    background: radial-gradient(circle,
      color-mix(in srgb, var(--accent) 14%, transparent),
      color-mix(in srgb, var(--accent) 4%, transparent) 45%,
      transparent 70%);
    filter: blur(45px);
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.4s ease;
    transform: translate(calc(var(--gx, 0px) - 190px), calc(var(--gy, 0px) - 190px));
    will-change: transform;
    z-index: 0;
  }

  /* Spinning conic border */
  .sm-border-spin {
    position: absolute;
    inset: -1px;
    border-radius: inherit;
    pointer-events: none;
    z-index: 0;
    background: conic-gradient(
      from var(--sm-angle, 0deg),
      transparent 0%,
      color-mix(in srgb, var(--accent) 28%, transparent) 8%,
      transparent 16%,
      transparent 84%,
      color-mix(in srgb, var(--border) 18%, transparent) 92%,
      transparent 100%
    );
    mask: linear-gradient(black, black) content-box, linear-gradient(black, black);
    -webkit-mask: linear-gradient(black, black) content-box, linear-gradient(black, black);
    mask-composite: exclude;
    -webkit-mask-composite: xor;
    padding: 1px;
    animation: sm-spin 4.5s linear infinite;
    opacity: 0.75;
  }
  @property --sm-angle {
    syntax: "<angle>"; inherits: false; initial-value: 0deg;
  }
  @keyframes sm-spin { to { --sm-angle: 360deg; } }

  /* Shimmer sweep */
  .sm-shimmer {
    position: absolute;
    inset: 0;
    pointer-events: none;
    z-index: 0;
    background: linear-gradient(
      110deg,
      transparent 35%,
      color-mix(in srgb, var(--accent) 4%, transparent) 48%,
      transparent 62%
    );
    background-size: 250% 100%;
    animation: sm-shimmer 5s ease-in-out infinite;
  }
  @keyframes sm-shimmer {
    0%, 100% { background-position: 250% 0; }
    50%        { background-position: -250% 0; }
  }

  /* Sparkles */
  .sm-sparkles {
    position: absolute;
    inset: 0;
    pointer-events: none;
    z-index: 0;
    overflow: hidden;
    border-radius: inherit;
  }
  .sm-sp {
    position: absolute;
    width: 3px; height: 3px;
    border-radius: 50%;
    background: var(--accent);
    box-shadow: 0 0 7px 1px color-mix(in srgb, var(--accent) 55%, transparent);
    opacity: 0;
    animation: sm-sparkle 3.2s ease-in-out infinite;
  }
  .sm-sp-1 { top: 10%; left: 7%;   animation-delay: 0s; }
  .sm-sp-2 { top: 20%; right: 10%; animation-delay: 0.65s; }
  .sm-sp-3 { bottom: 28%; left: 18%; animation-delay: 1.3s; }
  .sm-sp-4 { top: 6%;  right: 24%; animation-delay: 1.95s; }
  .sm-sp-5 { bottom: 12%; right: 7%; animation-delay: 2.6s; }
  @keyframes sm-sparkle {
    0%, 100% { opacity: 0; transform: scale(0) rotate(0deg); }
    50%       { opacity: 1; transform: scale(1) rotate(180deg); }
  }

  /* ===== Header ===== */
  .sm-header {
    position: relative;
    z-index: 2;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.85rem 1.25rem;
    border-bottom: 1px solid color-mix(in srgb, var(--foreground) 5%, transparent);
    background: color-mix(in srgb, var(--background) 45%, transparent);
    backdrop-filter: blur(16px) saturate(1.5);
    -webkit-backdrop-filter: blur(16px) saturate(1.5);
  }

  .sm-header-left {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .sm-icon-wrap {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 1.625rem; height: 1.625rem;
    border-radius: 0.4rem;
    background: color-mix(in srgb, var(--accent) 12%, transparent);
    color: var(--accent);
    box-shadow: 0 0 10px color-mix(in srgb, var(--accent) 18%, transparent);
    transition: box-shadow 0.2s ease;
  }
  .sm-header:focus-within .sm-icon-wrap {
    box-shadow: 0 0 18px color-mix(in srgb, var(--accent) 30%, transparent);
  }
  .sm-title {
    font-size: 0.82rem;
    font-weight: 700;
    letter-spacing: 0.03em;
    background: linear-gradient(135deg, var(--foreground), var(--accent));
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .sm-header-right {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .sm-shortcuts {
    display: flex;
    align-items: center;
    gap: 0.2rem;
    font-size: 0.68rem;
    color: color-mix(in srgb, var(--foreground) 30%, transparent);
  }
  .sm-kbd {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 1.2rem;
    padding: 0.05rem 0.28rem;
    font-size: 0.58rem;
    font-family: inherit;
    border-radius: 0.22rem;
    border: 1px solid color-mix(in srgb, var(--foreground) 10%, transparent);
    background: color-mix(in srgb, var(--foreground) 5%, transparent);
    color: color-mix(in srgb, var(--foreground) 40%, transparent);
    box-shadow: 0 1px 2px color-mix(in srgb, var(--background) 25%, transparent);
  }
  .sm-kbd-esc { padding: 0.05rem 0.4rem; }
  .sm-shortcut-sep { margin: 0 0.15rem; opacity: 0.3; }
  .sm-shortcut-hint { margin-left: 0.1rem; }

  .sm-close {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 1.7rem; height: 1.7rem;
    border-radius: 0.4rem;
    color: color-mix(in srgb, var(--foreground) 38%, transparent);
    transition: all 0.2s ease;
  }
  .sm-close:hover {
    color: var(--accent);
    background: color-mix(in srgb, var(--accent) 10%, transparent);
    box-shadow: 0 0 12px color-mix(in srgb, var(--accent) 15%, transparent);
  }

  /* ===== Body ===== */
  .sm-body {
    position: relative;
    z-index: 2;
    flex: 1;
    overflow-y: auto;
    padding: 1.25rem 1.5rem 1.5rem;
    scrollbar-width: thin;
    scrollbar-color: color-mix(in srgb, var(--accent) 20%, transparent) transparent;
  }
  .sm-body::-webkit-scrollbar { width: 4px; }
  .sm-body::-webkit-scrollbar-track { background: transparent; }
  .sm-body::-webkit-scrollbar-thumb {
    background: color-mix(in srgb, var(--accent) 22%, transparent);
    border-radius: 10px;
  }

  /* ===== Empty state ===== */
  .sm-empty {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
    padding: 2.25rem 1rem 1rem;
    text-align: center;
  }
  .sm-empty-icon {
    position: relative;
    color: color-mix(in srgb, var(--accent) 30%, transparent);
    animation: sm-float 3.5s ease-in-out infinite;
  }
  @keyframes sm-float {
    0%, 100% { transform: translateY(0); }
    50%       { transform: translateY(-7px); }
  }
  .sm-empty-ring {
    position: absolute;
    inset: -6px;
    border-radius: 50%;
    border: 1px solid color-mix(in srgb, var(--accent) 12%, transparent);
    animation: sm-ring-pulse 3.5s ease-in-out infinite;
  }
  @keyframes sm-ring-pulse {
    0%, 100% { transform: scale(1); opacity: 0.6; }
    50%       { transform: scale(1.08); opacity: 1; }
  }
  .sm-empty-text {
    font-size: 0.83rem;
    color: color-mix(in srgb, var(--foreground) 38%, transparent);
    max-width: 260px;
    line-height: 1.6;
  }
  .sm-empty-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
    justify-content: center;
    margin-top: 0.25rem;
  }
  .sm-tag {
    display: inline-flex;
    align-items: center;
    padding: 0.25rem 0.7rem;
    border-radius: 99px;
    font-size: 0.72rem;
    font-weight: 500;
    color: color-mix(in srgb, var(--accent) 80%, var(--foreground));
    background: color-mix(in srgb, var(--accent) 8%, transparent);
    border: 1px solid color-mix(in srgb, var(--accent) 14%, transparent);
    cursor: pointer;
    transition: all 0.2s ease;
    user-select: none;
  }
  .sm-tag:hover {
    background: color-mix(in srgb, var(--accent) 16%, transparent);
    border-color: color-mix(in srgb, var(--accent) 28%, transparent);
    box-shadow: 0 0 12px color-mix(in srgb, var(--accent) 12%, transparent);
    transform: translateY(-1px);
  }

  /* ===== Footer ===== */
  .sm-footer {
    position: relative;
    z-index: 2;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.6rem 1.25rem;
    border-top: 1px solid color-mix(in srgb, var(--foreground) 5%, transparent);
    background: color-mix(in srgb, var(--background) 50%, transparent);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
  }
  .sm-footer-hints {
    display: flex;
    align-items: center;
    gap: 0.65rem;
  }
  .sm-hint {
    display: flex;
    align-items: center;
    gap: 0.3rem;
    font-size: 0.65rem;
    color: color-mix(in srgb, var(--foreground) 30%, transparent);
  }
  .sm-hint-key {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 1.15rem;
    padding: 0.05rem 0.22rem;
    font-size: 0.6rem;
    font-family: inherit;
    border-radius: 0.2rem;
    border: 1px solid color-mix(in srgb, var(--foreground) 9%, transparent);
    background: color-mix(in srgb, var(--foreground) 4%, transparent);
    color: color-mix(in srgb, var(--foreground) 38%, transparent);
  }
  .sm-hint-sep {
    width: 1px; height: 12px;
    background: color-mix(in srgb, var(--foreground) 8%, transparent);
  }
  .sm-footer-powered {
    font-size: 0.65rem;
    color: color-mix(in srgb, var(--foreground) 28%, transparent);
  }
  .sm-footer-powered strong {
    color: var(--accent);
    font-weight: 600;
  }

  /* Dev notice */
  .sm-dev-notice {
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
    padding: 0.875rem 1rem;
    border-radius: 0.75rem;
    background: color-mix(in srgb, var(--foreground) 4%, transparent);
    border: 1px solid color-mix(in srgb, var(--accent) 10%, transparent);
    font-size: 0.85rem;
    margin-bottom: 0.75rem;
  }
  .sm-dev-notice code {
    display: block;
    padding: 0.3rem 0.6rem;
    border-radius: 0.4rem;
    background: color-mix(in srgb, var(--foreground) 7%, transparent);
    font-size: 0.78rem;
  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .sm-orb, .sm-sp, .sm-border-spin, .sm-shimmer,
    .sm-empty-icon, .sm-empty-ring { animation: none !important; }
    .sm-cursor-glow { display: none; }
    .sm-card { transition: opacity 0.2s ease; }
  }
</style>

<!-- ===== Modal-specific pagefind overrides ===== -->
<style is:global>
  #modal-pagefind-search {
    --pagefind-ui-font: var(--font-app);
    --pagefind-ui-text: var(--foreground);
    --pagefind-ui-background: transparent;
    --pagefind-ui-border: color-mix(in srgb, var(--border) 35%, transparent);
    --pagefind-ui-primary: var(--accent);
    --pagefind-ui-tag: var(--background);
    --pagefind-ui-border-radius: 0.875rem;
    --pagefind-ui-border-width: 1px;
    --pagefind-ui-scale: 0.9;
  }

  /* Search icon colour follows accent */
  #modal-pagefind-search form::before {
    background-color: var(--accent);
    opacity: 0.6;
    transition: opacity 0.2s ease;
  }
  #modal-pagefind-search form:focus-within::before { opacity: 1; }

  /* Input */
  #modal-pagefind-search input.pagefind-ui__search-input {
    font-weight: 400;
    border: 1px solid color-mix(in srgb, var(--accent) 14%, color-mix(in srgb, var(--border) 25%, transparent));
    border-radius: 0.875rem;
    background: color-mix(in srgb, var(--foreground) 3%, var(--background));
    padding: 0.9rem 1rem 0.9rem 3.25rem;
    transition: border-color 0.25s ease, box-shadow 0.25s ease, background 0.25s ease;
  }
  #modal-pagefind-search input.pagefind-ui__search-input:focus-visible {
    outline: none;
    border-color: color-mix(in srgb, var(--accent) 55%, transparent);
    box-shadow:
      0 0 0 3px color-mix(in srgb, var(--accent) 10%, transparent),
      0 0 28px -4px color-mix(in srgb, var(--accent) 14%, transparent),
      inset 0 1px 2px color-mix(in srgb, var(--accent) 4%, transparent);
    background: color-mix(in srgb, var(--accent) 3%, var(--background));
  }
  #modal-pagefind-search input.pagefind-ui__search-input::placeholder {
    color: color-mix(in srgb, var(--foreground) 28%, transparent);
  }

  /* Clear */
  #modal-pagefind-search .pagefind-ui__search-clear {
    border-radius: 0.5rem;
    transition: all 0.2s ease;
  }
  #modal-pagefind-search .pagefind-ui__search-clear:hover {
    background: color-mix(in srgb, var(--accent) 10%, transparent);
    color: var(--accent);
    box-shadow: 0 0 10px color-mix(in srgb, var(--accent) 10%, transparent);
  }
  #modal-pagefind-search .pagefind-ui__search-clear:focus-visible {
    outline-width: 2px;
    outline-style: dashed;
  }

  /* Results area */
  #modal-pagefind-search .pagefind-ui__results-area { margin-top: 1.25rem; }
  #modal-pagefind-search .pagefind-ui__message {
    font-style: italic;
    opacity: 0.45;
    padding: 0.75rem 0;
    font-size: 0.82rem;
  }

  /* Individual result */
  #modal-pagefind-search .pagefind-ui__result {
    padding: 0.9rem 0.875rem;
    margin: 0.2rem -0.875rem;
    border-radius: 0.875rem;
    border-bottom: none;
    transition: background 0.2s ease, box-shadow 0.2s ease, transform 0.2s ease;
  }
  #modal-pagefind-search .pagefind-ui__result:hover {
    background: color-mix(in srgb, var(--accent) 5%, transparent);
    box-shadow:
      0 4px 18px -8px color-mix(in srgb, var(--accent) 12%, transparent),
      inset 0 0 0 1px color-mix(in srgb, var(--accent) 7%, transparent);
    transform: translateX(2px);
  }
  #modal-pagefind-search .pagefind-ui__result + .pagefind-ui__result {
    border-top: 1px solid color-mix(in srgb, var(--foreground) 4%, transparent);
  }

  /* Title */
  #modal-pagefind-search .pagefind-ui__result-title a {
    color: var(--accent);
    font-weight: 600;
    text-decoration: none;
    outline-offset: 2px;
    outline-color: var(--accent);
    transition: text-shadow 0.22s ease;
  }
  #modal-pagefind-search .pagefind-ui__result-title a:hover {
    text-shadow: 0 0 22px color-mix(in srgb, var(--accent) 38%, transparent);
  }
  #modal-pagefind-search .pagefind-ui__result-title a:focus-visible {
    text-decoration-line: none;
    outline-width: 2px;
    outline-style: dashed;
  }

  /* Excerpt */
  #modal-pagefind-search .pagefind-ui__result-excerpt {
    opacity: 0.52;
    font-size: 0.81rem;
    line-height: 1.68;
  }
  #modal-pagefind-search .pagefind-ui__result-excerpt mark {
    background: color-mix(in srgb, var(--accent) 18%, transparent);
    color: var(--accent);
    border-radius: 3px;
    padding: 0.04em 0.22em;
    font-weight: 600;
    box-shadow: 0 0 8px color-mix(in srgb, var(--accent) 10%, transparent);
  }

  /* Nested */
  #modal-pagefind-search .pagefind-ui__result-nested {
    padding-left: 1.5rem;
    border-left: 2px solid color-mix(in srgb, var(--accent) 14%, transparent);
  }
  #modal-pagefind-search .pagefind-ui__result-nested .pagefind-ui__result-link:before {
    font-family: system-ui;
  }

  /* Load more */
  #modal-pagefind-search .pagefind-ui__button {
    border-radius: 0.875rem;
    border: 1px solid color-mix(in srgb, var(--accent) 20%, transparent);
    background: color-mix(in srgb, var(--accent) 5%, transparent);
    color: var(--accent);
    font-weight: 600;
    transition: all 0.25s ease;
  }
  #modal-pagefind-search .pagefind-ui__button:hover {
    background: color-mix(in srgb, var(--accent) 13%, transparent);
    border-color: color-mix(in srgb, var(--accent) 38%, transparent);
    box-shadow:
      0 4px 22px color-mix(in srgb, var(--accent) 15%, transparent),
      0 0 0 1px color-mix(in srgb, var(--accent) 8%, transparent);
    transform: translateY(-1px);
  }
  #modal-pagefind-search .pagefind-ui__button:active { transform: translateY(0); }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    #modal-pagefind-search .pagefind-ui__result,
    #modal-pagefind-search .pagefind-ui__button { transition: none; }
  }
</style>
