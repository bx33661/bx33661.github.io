---
import { Button } from '@/components/ui/button'
import { Icon } from 'astro-icon/components'
---

<Button
  id="theme-toggle"
  variant="secondary"
  size="icon"
  title="Toggle theme"
  aria-pressed="false"
>
  <Icon
    name="lucide:sun"
    class="size-4 scale-100 rotate-0 transition-all dark:scale-0 dark:-rotate-90"
  />
  <Icon
    name="lucide:moon"
    class="absolute size-4 scale-0 rotate-90 transition-all dark:scale-100 dark:rotate-0"
  />
  <span class="sr-only">Toggle theme</span>
</Button>

<script>
  import { THEME_CHANGE_EVENT, THEME_RUNTIME_COLORS, isDarkTheme, sanitizeTheme, resolveDaisyTheme } from '@/config/theme'

  const EVENT_NAME = THEME_CHANGE_EVENT
  let toggleButton: HTMLButtonElement | null = null

  const getActiveTheme = () => {
    const api = window.__BX_THEME__
    if (api && typeof api.get === 'function') {
      return api.get()
    }

    const root = document.documentElement
    const colorMode = sanitizeTheme(root.dataset.colorMode)
    if (colorMode) return colorMode

    return root.classList.contains('dark') ? 'midnight' : 'light'
  }

  const updateAriaState = (theme: ThemeName) => {
    if (!toggleButton) return
    toggleButton.setAttribute('aria-pressed', isDarkTheme(theme) ? 'true' : 'false')
  }

  const handleThemeChange = (event: Event) => {
    const detail = (event as CustomEvent<{ theme?: ThemeName }>).detail
    const theme = detail?.theme
    if (theme) {
      updateAriaState(theme)
    }
  }

  const handleToggleClick = () => {
    const api = window.__BX_THEME__
    if (api && typeof api.toggle === 'function') {
      const next = api.toggle()
      updateAriaState(next)
    } else {
      const nextIsDark = !document.documentElement.classList.contains('dark')
      const nextTheme: ThemeName = nextIsDark ? 'midnight' : 'light'
      const element = document.documentElement

      element.classList.toggle('dark', nextIsDark)
      element.dataset.theme = resolveDaisyTheme(nextTheme)
      element.dataset.colorMode = nextTheme
      element.style.colorScheme = nextIsDark ? 'dark' : 'light'
      element.style.backgroundColor = THEME_RUNTIME_COLORS[nextTheme]

      window.dispatchEvent(
        new CustomEvent(EVENT_NAME, {
          detail: {
            theme: nextTheme,
            daisyTheme: resolveDaisyTheme(nextTheme),
            isDark: nextIsDark,
          },
        }),
      )
      updateAriaState(nextTheme)
    }
  }

  const setup = () => {
    const candidate = document.getElementById('theme-toggle') as HTMLButtonElement | null
    if (!candidate) {
      return
    }

    toggleButton = candidate
    if (candidate.dataset.bxThemeToggleBound !== 'true') {
      candidate.addEventListener('click', handleToggleClick)
      candidate.dataset.bxThemeToggleBound = 'true'
    }

    updateAriaState(getActiveTheme())
  }

  if (!window.__BX_THEME_TOGGLE_EVENT_BOUND__) {
    window.addEventListener(EVENT_NAME, handleThemeChange)
    window.__BX_THEME_TOGGLE_EVENT_BOUND__ = true
  }

  setup()
  if (!window.__BX_THEME_TOGGLE_SWAP_BOUND__) {
    document.addEventListener('astro:after-swap', setup)
    window.__BX_THEME_TOGGLE_SWAP_BOUND__ = true
  }
</script>
