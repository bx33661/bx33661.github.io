---
import TerminalPostCard from '@/components/terminal/TerminalPostCard.astro'
import PageHead from '@/components/PageHead.astro'
import TerminalLayout from '@/layouts/TerminalLayout.astro'
import { getAllPostSlugs } from '@/lib/data-utils'
import type { PaginateFunction } from 'astro'

export async function getStaticPaths({
  paginate,
}: {
  paginate: PaginateFunction
}) {
  const allPostSlugs = await getAllPostSlugs()
  return paginate(allPostSlugs, { pageSize: 10 })
}

const { page } = Astro.props
const currentUrl = Astro.url
const pageTitle = page.currentPage === 1 ? '博客' : `博客 - 第 ${page.currentPage} 页`
const pageDescription = '安全研究、开发实践与日常技术记录。'
const pageNumbers = Array.from({ length: page.lastPage }, (_, index) => index + 1)
const pageEntries = page.data as Array<{ post: Awaited<ReturnType<typeof getAllPostSlugs>>[number]['post']; slug: string }>

const buildPageLink = (pageNumber: number) => {
  if (pageNumber <= 1) {
    return '/blog/'
  }
  return `/blog/${pageNumber}/`
}
---

<TerminalLayout canonicalUrl={currentUrl}>
  <PageHead slot="head" title={pageTitle} description={pageDescription} canonicalURL={currentUrl.toString()} />

  <div class="posts">
    <h1 class="posts-title">博客文章</h1>

    {page.data.length === 0 ? (
      <p>暂无文章，稍后再来看看。</p>
    ) : (
      pageEntries.map(({ post, slug }) => (
        <TerminalPostCard post={post} slug={slug} />
      ))
    )}
  </div>

  {page.lastPage > 1 && (
    <div class="pagination">
      <div class="pagination__title">
        <span class="pagination__title-h">Page {page.currentPage} / {page.lastPage}</span>
        <hr />
      </div>
      <div class="pagination__buttons">
        {page.url.prev && (
          <a href={page.url.prev} class="button inline prev">&lt; [上一页]</a>
        )}

        {pageNumbers.map((pageNumber) => (
          <a
            href={buildPageLink(pageNumber)}
            class={`button number ${pageNumber === page.currentPage ? 'active' : ''}`}
          >
            {pageNumber}
          </a>
        ))}

        {page.url.next && (
          <a href={page.url.next} class="button inline next">[下一页] &gt;</a>
        )}
      </div>
    </div>
  )}
</TerminalLayout>
