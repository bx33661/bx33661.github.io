---
import PostHead from '@/components/PostHead.astro'
import PasswordProtect from '@/components/react/password-protect'
import TerminalLayout from '@/layouts/TerminalLayout.astro'
import { getAdjacentPosts, getAllPostSlugs } from '@/lib/data-utils'
import { formatDate, readingTime } from '@/lib/utils'
import { render } from 'astro:content'
import { pbkdf2Sync } from 'node:crypto'

export async function getStaticPaths() {
  const postSlugs = await getAllPostSlugs()
  return postSlugs.map(({ slug, post }) => ({
    params: { id: slug },
    props: { post, slug },
  }))
}

const { post, slug } = Astro.props
const currentSlug = slug || Astro.params.id
const { Content } = await render(post)
const { next, prev } = await getAdjacentPosts(currentSlug)

const isPasswordProtected = !!post.data.password
const currentUrl = Astro.url
const authorLabel = post.data.authors?.length ? post.data.authors.join(' & ') : 'BX'
const wordCount = (post.body || '').replace(/\s+/g, '').length
const coverImage = post.data.image?.src
const passwordSalt = `bx-article:${post.id}`
const passwordIterations = 120_000
const passwordVerifier = isPasswordProtected
  ? pbkdf2Sync(post.data.password!, passwordSalt, passwordIterations, 32, 'sha256').toString('hex')
  : ''
---

<TerminalLayout canonicalUrl={currentUrl} title={post.data.title} description={post.data.description}>
  <PostHead slot="head" post={post} slug={currentSlug} noindex={isPasswordProtected} />

  <article class="post">
    <h1 class="post-title">{post.data.title}</h1>

    <div class="post-meta">
      <time datetime={post.data.date.toISOString()}>{formatDate(post.data.date)}</time>
      <span class="post-author">{authorLabel}</span>
      <span class="post-author">{readingTime(post.body || '')}</span>
      <span class="post-author">约 {wordCount.toLocaleString()} 字</span>
    </div>

    {post.data.tags && post.data.tags.length > 0 && (
      <span class="post-tags">
        {post.data.tags.map((tag) => <a href={`/tags/${encodeURIComponent(tag)}/`}>{tag}</a>)}
      </span>
    )}

    {coverImage && (
      <figure class="post-cover">
        <img src={coverImage} alt={post.data.title} loading="lazy" decoding="async" />
      </figure>
    )}

    {isPasswordProtected ? (
      <PasswordProtect
        client:load
        articleId={post.id}
        passwordSalt={passwordSalt}
        passwordIterations={passwordIterations}
        passwordVerifier={passwordVerifier}
      >
        <div class="post-content">
          <Content />
        </div>
      </PasswordProtect>
    ) : (
      <div class="post-content">
        <Content />
      </div>
    )}
  </article>

  <div class="pagination">
    <div class="pagination__title">
      <span class="pagination__title-h">Read other posts</span>
      <hr />
    </div>
    <div class="pagination__buttons">
      {prev && (
        <a href={`/blog/${prev.slug}/`} class="button inline prev">
          &lt; [<span class="button__text">{prev.post.data.title}</span>]
        </a>
      )}
      {prev && next && <span>::</span>}
      {next && (
        <a href={`/blog/${next.slug}/`} class="button inline next">
          [<span class="button__text">{next.post.data.title}</span>] &gt;
        </a>
      )}
    </div>
  </div>

  <script>
    document.addEventListener('astro:page-load', () => {
      const codeBlocks = document.querySelectorAll('pre.astro-code')

      codeBlocks.forEach((block) => {
        if (block.parentElement?.classList.contains('highlight')) {
          return
        }

        const wrapper = document.createElement('div')
        wrapper.className = 'highlight'
        block.parentNode?.insertBefore(wrapper, block)
        wrapper.appendChild(block)

        const lang = block.getAttribute('data-language') || 'text'
        const titleDiv = document.createElement('div')
        titleDiv.className = 'code-title'
        titleDiv.textContent = lang

        if (navigator.clipboard) {
          const button = document.createElement('button')
          button.className = 'copy-button'
          button.textContent = 'Copy'

          button.addEventListener('click', async () => {
            const code = block.textContent || ''
            try {
              await navigator.clipboard.writeText(code)
              button.textContent = 'Copied'
              setTimeout(() => {
                button.textContent = 'Copy'
              }, 1000)
            } catch {
              button.textContent = 'Copy failed'
              setTimeout(() => {
                button.textContent = 'Copy'
              }, 1000)
            }
          })

          titleDiv.appendChild(button)
        }

        wrapper.insertBefore(titleDiv, block)
      })
    })
  </script>
</TerminalLayout>
