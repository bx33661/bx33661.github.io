---
import { SITE } from "@/config.ts";
import { getCollection } from "astro:content";
import Header from "@/components/Header.astro";
import ArtGallerySlider from "@/components/react/art-gallery-slider";
import { GALLERY_IMAGES, buildGalleryImageSources } from "@/data/gallery";
import Layout from "@/layouts/Layout.astro";
import "@/styles/art-gallery-slider.css";

// Build image sources with optimized paths
const galleryImages = GALLERY_IMAGES.map((item) => {
  const sources = buildGalleryImageSources(item);
  return {
    src: sources.optimizedSrc,
    alt: item.alt,
    title: item.title,
    date: item.date,
    width: item.width,
    height: item.height,
  };
});

const toGallerySlug = (id: string) =>
  id
    .replace(/\\/g, "/")
    .replace(/\/index\.(md|mdx)$/, "")
    .replace(/\.(md|mdx)$/, "");

const galleries = await getCollection("galleries", ({ data }) => !data.draft);
const galleryLinks = galleries
  .map((gallery) => ({
    slug: toGallerySlug(gallery.id),
    title: gallery.data.title,
  }))
  .filter((gallery) => gallery.slug.length > 0);
---

<Layout
  title={`画廊 | ${SITE.title}`}
  description="收录项目记录与日常瞬间的图像集合"
  canonicalURL={Astro.url.toString()}
>
  <div class="gallery-page-wrapper">
    <Header />
    <div class="gallery-fullscreen-container">
      {
        galleryImages.length > 0 ? (
          <ArtGallerySlider images={galleryImages} client:load />
        ) : (
          <div class="gallery-empty-state">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="48"
              height="48"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="1.5"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
              <circle cx="9" cy="9" r="2" />
              <path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21" />
            </svg>
            <p>暂时还没有图片</p>
          </div>
        )
      }

      {
        galleryLinks.length > 0 && (
          <nav class="gallery-detail-links" aria-label="图集详情入口">
            {galleryLinks.map((gallery) => (
              <a class="gallery-detail-link" href={`/galleries/${gallery.slug}/`}>
                {gallery.title}
              </a>
            ))}
          </nav>
        )
      }
    </div>
  </div>
</Layout>

<style>
  .gallery-page-wrapper {
    position: relative;
    width: 100vw;
    height: 100vh;
    overflow: hidden;
    background: #000000;
  }

  /* Make header darker and more transparent for gallery */
  .gallery-page-wrapper :global(.header-glass) {
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-bottom: 1px solid rgba(255, 255, 255, 0.08);
  }

  .gallery-page-wrapper :global(.nav-logo-word),
  .gallery-page-wrapper :global(.nav-link),
  .gallery-page-wrapper :global(.nav-icon-btn) {
    color: rgba(255, 255, 255, 0.85);
  }

  .gallery-page-wrapper :global(.nav-link:hover),
  .gallery-page-wrapper :global(.nav-icon-btn:hover) {
    color: rgba(255, 255, 255, 1);
    background: rgba(255, 255, 255, 0.1);
  }

  .gallery-page-wrapper :global(.nav-active) {
    color: rgba(255, 255, 255, 1);
    background: rgba(255, 255, 255, 0.12);
  }

  .gallery-page-wrapper :global(.site-brand-logo) {
    border-color: rgba(255, 255, 255, 0.2);
  }

  .gallery-page-wrapper :global(.nav-quick-btn) {
    border-color: rgba(255, 255, 255, 0.15);
    background: rgba(255, 255, 255, 0.08);
    color: rgba(255, 255, 255, 0.7);
  }

  .gallery-page-wrapper :global(.nav-quick-btn:hover) {
    background: rgba(255, 255, 255, 0.15);
    color: rgba(255, 255, 255, 1);
  }

  .gallery-page-wrapper :global(.nav-quick-btn.active) {
    background: rgba(255, 255, 255, 0.2);
    color: rgba(255, 255, 255, 1);
  }

  .gallery-page-wrapper :global(.nav-search-btn) {
    border-color: rgba(255, 255, 255, 0.15);
    background: rgba(255, 255, 255, 0.08);
    color: rgba(255, 255, 255, 0.7);
  }

  .gallery-page-wrapper :global(.nav-search-btn:hover) {
    border-color: rgba(255, 255, 255, 0.25);
    background: rgba(255, 255, 255, 0.15);
    color: rgba(255, 255, 255, 1);
  }

  .gallery-page-wrapper :global(.nav-kbd) {
    border-color: rgba(255, 255, 255, 0.15);
    background: rgba(0, 0, 0, 0.3);
    color: rgba(255, 255, 255, 0.6);
  }

  .gallery-page-wrapper :global(.hamburger-line) {
    background: rgba(255, 255, 255, 0.85);
  }

  .gallery-page-wrapper :global(.hamburger-btn[aria-expanded="true"] .hamburger-line) {
    background: rgba(255, 255, 255, 1);
  }

  .gallery-fullscreen-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;
  }

  .gallery-empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: rgba(255, 255, 255, 0.6);
  }

  .gallery-empty-state svg {
    opacity: 0.5;
    margin-bottom: 1rem;
  }

  .gallery-empty-state p {
    font-size: 1.125rem;
    margin: 0;
  }

  .gallery-detail-links {
    position: absolute;
    right: 1rem;
    bottom: 1rem;
    z-index: 4;
    display: flex;
    flex-wrap: wrap;
    justify-content: flex-end;
    gap: 0.5rem;
    max-width: min(90vw, 36rem);
  }

  .gallery-detail-link {
    border-radius: 999px;
    border: 1px solid rgba(255, 255, 255, 0.28);
    background: rgba(0, 0, 0, 0.45);
    color: rgba(255, 255, 255, 0.9);
    padding: 0.4rem 0.85rem;
    font-size: 0.78rem;
    text-decoration: none;
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    transition: background 0.2s ease, border-color 0.2s ease, color 0.2s ease;
  }

  .gallery-detail-link:hover {
    border-color: rgba(255, 255, 255, 0.48);
    background: rgba(255, 255, 255, 0.16);
    color: rgba(255, 255, 255, 1);
  }

  @media (max-width: 640px) {
    .gallery-detail-links {
      right: 0.75rem;
      left: 0.75rem;
      justify-content: center;
    }
  }
</style>
