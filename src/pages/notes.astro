---
import Breadcrumbs from '@/components/Breadcrumbs.astro'
import PageHead from '@/components/PageHead.astro'
import Layout from '@/layouts/Layout.astro'
import { getAllNotes, getAllNoteCategories, getAllNoteTags } from '@/lib/data-utils'
import { Icon } from 'astro-icon/components'
import type { CollectionEntry } from 'astro:content'

const allNotes = await getAllNotes()
const categories = await getAllNoteCategories()
const tags = await getAllNoteTags()

// 按分类组织笔记
const notesByCategory = new Map()
for (const note of allNotes) {
  const category = note.data.category || '未分类'
  if (!notesByCategory.has(category)) {
    notesByCategory.set(category, [])
  }
  notesByCategory.get(category).push(note)
}

const currentUrl = Astro.url
---

<Layout canonicalUrl={currentUrl}>
  <PageHead slot="head" title="其他 - 学习笔记" />
  
  <Breadcrumbs
    items={[
      { label: '其他', href: '/notes', icon: 'lucide:book-open' },
    ]}
  />
  
  <section class="max-screen mt-12 px-4 md:px-6">
    <div class="flex w-fit items-center gap-2 text-primary">
      <Icon class="h-4 w-4 text-secondary-foreground animate-pulse" name="lucide:book-open" />
      <p class="shimmer word-spacing font-mono text-sm uppercase leading-none text-secondary-foreground">
        Learning Notes
      </p>
    </div>
    <h2
      id="notes-title"
      class="font-custom text-foreground text-4xl font-bold mt-2"
    >
      学习笔记
    </h2>
    <p class="text-muted-foreground text-md max-w-2xl mt-3">
      这里记录了我的学习历程和知识积累。包含各种技术学习笔记、日常思考和经验总结。希望这些内容能够帮助到有需要的朋友，也欢迎大家一起交流学习！
    </p>

    <!-- 统计信息 -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 my-8">
      <div class="bg-card border rounded-lg p-4">
        <div class="flex items-center gap-2">
          <Icon class="h-5 w-5 text-primary" name="lucide:file-text" />
          <h3 class="font-semibold">总笔记数</h3>
        </div>
        <p class="text-2xl font-bold text-primary mt-2">{allNotes.length}</p>
      </div>
      <div class="bg-card border rounded-lg p-4">
        <div class="flex items-center gap-2">
          <Icon class="h-5 w-5 text-primary" name="lucide:folder" />
          <h3 class="font-semibold">分类数</h3>
        </div>
        <p class="text-2xl font-bold text-primary mt-2">{categories.size}</p>
      </div>
      <div class="bg-card border rounded-lg p-4">
        <div class="flex items-center gap-2">
          <Icon class="h-5 w-5 text-primary" name="lucide:tag" />
          <h3 class="font-semibold">标签数</h3>
        </div>
        <p class="text-2xl font-bold text-primary mt-2">{tags.size}</p>
      </div>
    </div>

    <!-- 分类展示 -->
    <div class="space-y-8">
      {Array.from(notesByCategory.entries()).map(([category, notes]) => (
        <div class="bg-card border rounded-lg p-6">
          <div class="flex items-center gap-2 mb-4">
            <Icon class="h-5 w-5 text-primary" name="lucide:folder-open" />
            <h3 class="text-xl font-bold">{category}</h3>
            <span class="bg-primary/10 text-primary px-2 py-1 rounded-full text-sm">
              {notes.length} 篇
            </span>
          </div>
          
          <div class="grid gap-4">
            {notes.map((note: CollectionEntry<'notes'>) => (
              <article class="border-l-4 border-primary/20 pl-4 hover:border-primary/50 transition-colors">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
                  <div class="flex-1">
                    <h4 class="font-semibold text-lg hover:text-primary transition-colors">
                      <a href={`/notes/${note.data.slug || note.id}`}>
                        {note.data.title}
                      </a>
                    </h4>
                    <p class="text-muted-foreground text-sm mt-1">
                      {note.data.description}
                    </p>
                    {note.data.tags && note.data.tags.length > 0 && (
                      <div class="flex flex-wrap gap-1 mt-2">
                        {note.data.tags.map((tag: string) => (
                          <span class="bg-secondary text-secondary-foreground px-2 py-1 rounded text-xs">
                            #{tag}
                          </span>
                        ))}
                      </div>
                    )}
                  </div>
                  <div class="flex items-center gap-2 text-sm text-muted-foreground">
                    <Icon class="h-4 w-4" name="lucide:calendar" />
                    <time datetime={note.data.date.toISOString()}>
                      {note.data.date.toLocaleDateString('zh-CN')}
                    </time>
                  </div>
                </div>
              </article>
            ))}
          </div>
        </div>
      ))}
    </div>

    <!-- 如果没有笔记 -->
    {allNotes.length === 0 && (
      <div class="text-center py-12">
        <Icon class="h-16 w-16 text-muted-foreground mx-auto mb-4" name="lucide:book-open" />
        <h3 class="text-xl font-semibold mb-2">暂无学习笔记</h3>
        <p class="text-muted-foreground">
          还没有发布任何学习笔记，敬请期待！
        </p>
      </div>
    )}
  </section>
</Layout>

<style>
  .shimmer {
    background: linear-gradient(90deg, 
      hsl(var(--muted-foreground)) 0%, 
      hsl(var(--primary)) 50%, 
      hsl(var(--muted-foreground)) 100%);
    background-size: 200% 100%;
    background-clip: text;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: shimmer 2s ease-in-out infinite;
  }

  @keyframes shimmer {
    0% { background-position: -200% 0; }
    100% { background-position: 200% 0; }
  }

  .word-spacing {
    letter-spacing: 0.1em;
  }
</style>