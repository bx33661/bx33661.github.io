---
import Layout from '@/layouts/Layout.astro'
import Header from '@/components/Header.astro'
import Footer from '@/components/Footer.astro'

const currentUrl = Astro.url.toString()

const toolItems = [
  {
    id: 'jsoncrack',
    title: 'JSON Crack',
    href: '/tools/jsoncrack/',
    description: '交互式 JSON 可视化编辑器，适合快速看结构、调试和分享。',
    state: 'available',
  },
  {
    id: 'cyberchef',
    title: 'CyberChef',
    href: '/tools/cyberchef/',
    description: '编码/解码、哈希、加解密、取证预处理的一体化工具。',
    state: 'available',
  },
  {
    id: 'more',
    title: '更多工具',
    href: '',
    description: '后续会持续加入常用安全与效率工具入口。',
    state: 'coming-soon',
  },
] as const

const availableCount = toolItems.filter((item) => item.state === 'available').length
const plannedCount = toolItems.filter((item) => item.state === 'coming-soon').length
---

<Layout title="Tools" description="BX 工具箱，集中管理常用在线工具入口。" canonicalURL={currentUrl}>
  <Header />

  <main id="main-content" class="app-layout pb-10">

  <div class="page">
    <h1>Tools</h1>
    <p>常用工具统一收口在这里，保持简洁直接。</p>
    <div class="tools-meta">
      <span class="tools-chip">总数 {toolItems.length}</span>
      <span class="tools-chip">可用 {availableCount}</span>
      <span class="tools-chip">计划中 {plannedCount}</span>
    </div>
  </div>

  <div class="posts tools-grid">
    {toolItems.map((tool, index) => (
      <article class={`tool-card ${tool.state === 'coming-soon' ? 'tool-card--muted' : ''}`}>
        <div class="tool-card__head">
          <h2>
            <small>{String(index + 1).padStart(2, '0')}</small>
            {tool.title}
          </h2>
          {tool.id === 'cyberchef' ? (
            <span class="tool-status" id="cyberchef-status" data-ready-label="已就绪" data-missing-label="未同步">
              检查中
            </span>
          ) : tool.id === 'jsoncrack' ? (
            <span class="tool-status is-ready">在线</span>
          ) : (
            <span class="tool-status">计划中</span>
          )}
        </div>
        <p>{tool.description}</p>

        {tool.state === 'available' ? (
          <p class="tool-card__actions">
            <a class="tool-link" href={tool.href}>打开工具 -&gt;</a>
          </p>
        ) : (
          <p class="tool-card__actions"><span class="tool-placeholder">敬请期待</span></p>
        )}
      </article>
    ))}
  </div>

  <script is:inline>
    ;(() => {
      const statusEl = document.getElementById('cyberchef-status')
      if (!statusEl) return

      const readyLabel = statusEl.getAttribute('data-ready-label') || '已就绪'
      const missingLabel = statusEl.getAttribute('data-missing-label') || '未同步'

      fetch('/vendor/cyberchef/bx-version.json', { cache: 'no-store' })
        .then((response) => {
          if (!response.ok) throw new Error('missing')
          return response.json()
        })
        .then((meta) => {
          if (!meta || typeof meta.version !== 'string') throw new Error('invalid')
          statusEl.textContent = `${readyLabel} · ${meta.version}`
          statusEl.classList.add('is-ready')
        })
        .catch(() => {
          statusEl.textContent = missingLabel
          statusEl.classList.add('is-missing')
        })
    })()
  </script>
  </main>

  <Footer />
</Layout>

<style>
  .tools-meta {
    margin-top: 10px;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .tools-chip {
    border: 1px solid color-mix(in srgb, var(--accent) 55%, transparent);
    background: color-mix(in srgb, var(--accent) 10%, var(--background));
    padding: 1px 8px;
    font-size: 0.78rem;
    color: color-mix(in srgb, var(--foreground) 82%, transparent);
  }

  .tools-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 14px;
    margin-top: 12px;
  }

  .tool-card {
    position: relative;
    margin: 0;
    border: 2px solid color-mix(in srgb, var(--accent) 48%, transparent);
    background:
      linear-gradient(
        160deg,
        color-mix(in srgb, var(--accent) 13%, transparent) 0%,
        transparent 42%
      ),
      color-mix(in srgb, var(--background) 95%, var(--accent));
    padding: 12px 12px 10px;
    transition: transform 0.2s ease, border-color 0.2s ease;
  }

  .tool-card:hover {
    transform: translateY(-2px);
    border-color: color-mix(in srgb, var(--accent) 78%, transparent);
  }

  .tool-card--muted {
    border-style: dashed;
    opacity: 0.92;
  }

  .tool-card__head {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    margin-bottom: 6px;
  }

  .tool-card__head h2 {
    margin: 0;
    font-size: 1.04rem;
    display: flex;
    align-items: baseline;
    gap: 7px;
  }

  .tool-card__head h2 small {
    font-size: 0.72rem;
    color: color-mix(in srgb, var(--foreground) 52%, transparent);
  }

  .tool-card p {
    margin: 0;
    line-height: 1.55;
    color: color-mix(in srgb, var(--foreground) 78%, transparent);
  }

  .tool-card__actions {
    margin-top: 10px !important;
  }

  .tool-link {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    border: 1px solid color-mix(in srgb, var(--accent) 68%, transparent);
    background: color-mix(in srgb, var(--accent) 14%, var(--background));
    padding: 2px 8px;
    font-size: 0.86rem;
    color: inherit;
    text-decoration: none;
  }

  .tool-link:hover {
    border-color: var(--accent);
    background: color-mix(in srgb, var(--accent) 18%, var(--background));
  }

  .tool-status {
    border: 1px solid color-mix(in srgb, var(--accent) 60%, transparent);
    padding: 1px 7px;
    font-size: 0.72rem;
    white-space: nowrap;
  }

  .tool-status.is-ready {
    border-color: color-mix(in srgb, #2f9e44 50%, transparent);
    color: color-mix(in srgb, #2f9e44 75%, var(--foreground));
  }

  .tool-status.is-missing {
    border-color: color-mix(in srgb, #cc2a2a 44%, transparent);
    color: color-mix(in srgb, #cc2a2a 76%, var(--foreground));
  }

  .tool-placeholder {
    display: inline-block;
    border: 1px dashed color-mix(in srgb, var(--accent) 45%, transparent);
    padding: 2px 8px;
    font-size: 0.86rem;
  }

  @media (max-width: 640px) {
    .tools-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
