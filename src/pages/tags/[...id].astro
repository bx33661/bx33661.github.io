---
import TerminalPostCard from '@/components/terminal/TerminalPostCard.astro'
import PageHead from '@/components/PageHead.astro'
import TerminalLayout from '@/layouts/TerminalLayout.astro'
import { getAllTags, getAllPostSlugs } from '@/lib/data-utils'

export async function getStaticPaths() {
  const tagMap = await getAllTags()
  const uniqueTags = Array.from(tagMap.keys())
  const allPostSlugs = await getAllPostSlugs()

  return uniqueTags.map((tag) => {
    const posts = allPostSlugs
      .filter(({ post }) => post.data.tags?.includes(tag))
      .map(({ post, slug }) => ({ post, slug }))

    return {
      params: { id: tag },
      props: {
        tag,
        posts,
      },
    }
  })
}

const { tag, posts } = Astro.props
const currentUrl = Astro.url
const description = `标签 ${tag} 下的所有文章。`
const tagPosts = posts as Array<{ post: Awaited<ReturnType<typeof getAllPostSlugs>>[number]['post']; slug: string }>
---

<TerminalLayout canonicalUrl={currentUrl}>
  <PageHead
    slot="head"
    title={`标签: ${tag}`}
    description={description}
    canonicalURL={currentUrl.toString()}
  />

  <div class="posts">
    <h1 class="posts-title">Tag: #{tag}</h1>

    {tagPosts.length === 0 ? (
      <p>该标签下暂无文章。</p>
    ) : (
      tagPosts.map(({ post, slug }) => (
        <TerminalPostCard post={post} slug={slug} />
      ))
    )}
  </div>
</TerminalLayout>
