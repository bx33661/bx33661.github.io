---
import PageHead from '@/components/PageHead.astro'
import TagOrbitSphere from '@/components/react/tag-orbit-sphere'
import TerminalLayout from '@/layouts/TerminalLayout.astro'
import { getAllPosts, getSortedTags } from '@/lib/data-utils'

const sortedTags = await getSortedTags()
const orbitTags = sortedTags.slice(0, 120)
const orbitTagSet = new Set(orbitTags.map(({ tag }) => tag))
const allPosts = await getAllPosts()

const relationCountMap = new Map<string, number>()
for (const post of allPosts) {
  const postTags = Array.from(new Set((post.data.tags || []).filter((tag) => orbitTagSet.has(tag))))
  if (postTags.length < 2) continue

  for (let i = 0; i < postTags.length; i += 1) {
    for (let j = i + 1; j < postTags.length; j += 1) {
      const a = postTags[i]
      const b = postTags[j]
      const key = a < b ? `${a}|||${b}` : `${b}|||${a}`
      relationCountMap.set(key, (relationCountMap.get(key) || 0) + 1)
    }
  }
}

const orbitRelations = Array.from(relationCountMap.entries())
  .map(([key, weight]) => {
    const [source, target] = key.split('|||')
    return { source, target, weight }
  })
  .filter((item) => item.weight >= 1)
  .sort((a, b) => b.weight - a.weight)
  .slice(0, 900)

const currentUrl = Astro.url
---

<TerminalLayout canonicalUrl={currentUrl}>
  <PageHead
    slot="head"
    title="标签"
    description="按标签浏览博客文章。"
    canonicalURL={currentUrl.toString()}
  />

  <div class="page">
    <h1 class="posts-title">标签</h1>

    {sortedTags.length === 0 ? (
      <p>暂无标签。</p>
    ) : (
      <>
        <div class="tags-list">
          {sortedTags.map(({ tag, count }) => (
            <a href={`/tags/${encodeURIComponent(tag)}/`} class="tag-item">
              <span class="tag-name">#{tag}</span>
              <span class="tag-count">({count})</span>
            </a>
          ))}
        </div>

        <TagOrbitSphere client:visible tags={orbitTags} relations={orbitRelations} />
      </>
    )}
  </div>
</TerminalLayout>

<style>
  .tags-list {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    margin-top: 40px;
  }

  .tag-item {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    border: 2px solid var(--accent);
    text-decoration: none;
    transition: all 0.15s linear;
  }

  .tag-item:hover {
    background: color-mix(in srgb, var(--accent) 15%, transparent);
  }

  .tag-name {
    color: var(--accent);
    font-weight: 600;
  }

  .tag-count {
    color: color-mix(in srgb, var(--foreground) 65%, transparent);
    font-size: calc(var(--font-size) * 0.9);
  }
</style>
