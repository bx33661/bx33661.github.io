---
import { FRIEND_LINKS, ORGANIZATION_LINKS } from '@/consts'
import Layout from '@/layouts/Layout.astro'
import Header from '@/components/Header.astro'
import Footer from '@/components/Footer.astro'

const currentUrl = Astro.url.toString()

const info = {
  name: 'BX的博客',
  address: 'https://www.bx33661.com',
  desc: '专注于安全研究和技术分享的个人博客',
  avatar: '/logonew.jpg',
}

const getHost = (url: string) => {
  try {
    return new URL(url).hostname.replace(/^www\./, '')
  } catch {
    return url
  }
}

const getFallbackText = (name: string) => name.trim().slice(0, 1).toUpperCase() || '?'

const friendCards = FRIEND_LINKS.map((item) => ({
  ...item,
  host: getHost(item.url),
  fallback: getFallbackText(item.name),
}))

const organizationCards = ORGANIZATION_LINKS.map((item) => ({
  ...item,
  host: getHost(item.url),
  fallback: getFallbackText(item.name),
}))

const totalLinks = friendCards.length + organizationCards.length
---

<Layout title="友情链接" description="技术站点与安全社区链接集合。" canonicalURL={currentUrl}>
  <Header />

  <main id="main-content" class="friends-main app-layout">
    <!-- Top bar -->
    <div class="fp-topbar">
      <h1 class="fp-heading">Friends <span class="fp-total">{totalLinks}</span></h1>
      <a href="mailto:bx33661@gmail.com" class="fp-apply-btn" aria-label="邮件申请互链">
        <svg width="14" height="14" viewBox="0 0 14 14" fill="none" aria-hidden="true">
          <path d="M1.75 3.5L7 7.875L12.25 3.5" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
          <rect x="1.75" y="2.625" width="10.5" height="8.75" rx="1.5" stroke="currentColor" stroke-width="1.2"/>
        </svg>
        Apply Link
      </a>
    </div>

    <!-- Blog cards -->
    <section aria-label="技术博客">
      <h2 class="fp-section-label">技术博客 <span class="fp-count">{friendCards.length}</span></h2>
      <div class="fp-grid">
        {friendCards.map((friend, index) => (
          <a
            class="fc"
            href={friend.url}
            target="_blank"
            rel="noopener noreferrer"
            aria-label={`访问 ${friend.name}`}
            style={`--i:${index}`}
          >
            <div class="fc-back" aria-hidden="true">
              <div class="fc-avatar-area">
                {friend.avatar ? (
                  <img class="fc-avatar" src={friend.avatar} alt="" loading="lazy" decoding="async" referrerpolicy="no-referrer" />
                ) : (
                  <span class="fc-avatar-fb">{friend.fallback}</span>
                )}
              </div>
            </div>
            <div class="fc-front">
              <div class="fc-body">
                <h3 class="fc-name">{friend.name}</h3>
                <p class="fc-desc">{friend.description}</p>
              </div>
              <div class="fc-foot">
                <span class="fc-host-pill">
                  <img class="fc-favicon" src={`https://www.google.com/s2/favicons?domain=${friend.host}&sz=32`} alt="" width="14" height="14" loading="lazy" />
                  {friend.host}
                </span>
                <span class="fc-arrow" aria-hidden="true">
                  <svg width="12" height="12" viewBox="0 0 12 12" fill="none"><path d="M3.5 8.5L8.5 3.5M8.5 3.5H4.5M8.5 3.5V7.5" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </span>
              </div>
            </div>
          </a>
        ))}
      </div>
    </section>

    <!-- Organizations -->
    <section aria-label="组织与社区">
      <h2 class="fp-section-label">组织与社区 <span class="fp-count">{organizationCards.length}</span></h2>
      <div class="fp-grid">
        {organizationCards.map((org, index) => (
          <a
            class="fc fc--org"
            href={org.url}
            target="_blank"
            rel="noopener noreferrer"
            aria-label={`访问 ${org.name}`}
            style={`--i:${index}`}
          >
            <div class="fc-back" aria-hidden="true">
              <div class="fc-avatar-area">
                {org.avatar ? (
                  <img class="fc-avatar" src={org.avatar} alt="" loading="lazy" decoding="async" referrerpolicy="no-referrer" />
                ) : (
                  <span class="fc-avatar-fb">{org.fallback}</span>
                )}
              </div>
            </div>
            <div class="fc-front">
              <div class="fc-body">
                <h3 class="fc-name">{org.name}</h3>
                <div class="fc-tag-row">
                  {org.tags?.map((tag) => <span class="fc-tag">{tag}</span>)}
                </div>
              </div>
              <div class="fc-foot">
                <span class="fc-host-pill">
                  <img class="fc-favicon" src={`https://www.google.com/s2/favicons?domain=${org.host}&sz=32`} alt="" width="14" height="14" loading="lazy" />
                  {org.host}
                </span>
                <span class="fc-arrow" aria-hidden="true">
                  <svg width="12" height="12" viewBox="0 0 12 12" fill="none"><path d="M3.5 8.5L8.5 3.5M8.5 3.5H4.5M8.5 3.5V7.5" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </span>
              </div>
            </div>
          </a>
        ))}
      </div>
    </section>

    <!-- Self info — horizontal banner -->
    <section aria-label="本站信息">
      <h2 class="fp-section-label">本站信息</h2>
      <a class="self-banner" href={info.address} target="_blank" rel="noopener noreferrer">
        <div class="self-banner-glow" aria-hidden="true"></div>
        <img class="self-banner-avatar" src={info.avatar} alt={`${info.name} 头像`} loading="eager" decoding="async" />
        <div class="self-banner-content">
          <h3 class="self-banner-name">{info.name}</h3>
          <p class="self-banner-desc">{info.desc}</p>
        </div>
        <div class="self-banner-link">
          <span class="fc-host-pill">
            <img class="fc-favicon" src={`https://www.google.com/s2/favicons?domain=${getHost(info.address)}&sz=32`} alt="" width="14" height="14" loading="lazy" />
            {getHost(info.address)}
          </span>
          <span class="self-banner-arrow" aria-hidden="true">
            <svg width="14" height="14" viewBox="0 0 14 14" fill="none"><path d="M4 10L10 4M10 4H5.5M10 4V8.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </span>
        </div>
      </a>
    </section>
  </main>

  <Footer />
</Layout>

<style>
  /*
   * Friends page — theme-aware design
   * Uses project CSS vars: --background, --foreground, --accent, --muted, --border
   * Adapts automatically via data-theme="light" / data-theme="dark"
   */

  /* ===== Semantic tokens ===== */
  .friends-main {
    --fc-bg:       color-mix(in srgb, var(--foreground) 4%, var(--background));
    --fc-bg-hover: color-mix(in srgb, var(--foreground) 7%, var(--background));
    --fc-border:   color-mix(in srgb, var(--foreground) 8%, transparent);
    --fc-border-h: color-mix(in srgb, var(--accent) 30%, transparent);
    --fc-glass:    color-mix(in srgb, var(--background) 85%, transparent);
    --fc-glass-h:  color-mix(in srgb, var(--background) 90%, transparent);
    --fc-text-1:   color-mix(in srgb, var(--foreground) 88%, transparent);
    --fc-text-2:   color-mix(in srgb, var(--foreground) 55%, transparent);
    --fc-text-3:   color-mix(in srgb, var(--foreground) 40%, transparent);
    --fc-text-4:   color-mix(in srgb, var(--foreground) 28%, transparent);
    --fc-sep:      color-mix(in srgb, var(--foreground) 7%, transparent);
    --fc-pill-bg:  color-mix(in srgb, var(--accent) 8%, var(--background));
    --fc-pill-bd:  color-mix(in srgb, var(--accent) 20%, transparent);
    --fc-pill-fg:  color-mix(in srgb, var(--accent) 85%, var(--foreground));
    --fc-glow:     color-mix(in srgb, var(--accent) 10%, transparent);
    --fc-shadow:   color-mix(in srgb, var(--foreground) 8%, transparent);
  }

  /* ===== Layout ===== */
  .friends-main {
    padding-top: 0.5rem;
    padding-bottom: 5rem;
  }

  /* ===== Top bar ===== */
  .fp-topbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 2rem;
  }

  .fp-heading {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--foreground);
    letter-spacing: -0.02em;
  }

  .fp-total {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    vertical-align: middle;
    min-width: 1.5rem;
    height: 1.5rem;
    padding: 0 0.375rem;
    border-radius: 9999px;
    background: color-mix(in srgb, var(--accent) 12%, transparent);
    color: var(--accent);
    font-size: 0.75rem;
    font-weight: 700;
    margin-left: 0.375rem;
  }

  .fp-apply-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    height: 2.125rem;
    padding: 0 1rem;
    border-radius: 9999px;
    border: 1px solid var(--fc-border);
    background: var(--fc-bg);
    color: var(--fc-text-2);
    font-size: 0.8125rem;
    font-weight: 500;
    text-decoration: none;
    transition: all 0.2s ease;
    white-space: nowrap;
  }

  .fp-apply-btn:hover {
    background: var(--fc-bg-hover);
    border-color: var(--fc-border-h);
    color: var(--accent);
  }

  /* ===== Section labels ===== */
  .fp-section-label {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin: 3rem 0 1.25rem;
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--fc-text-3);
    letter-spacing: 0.06em;
    text-transform: uppercase;
  }

  .fp-count {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 1.25rem;
    height: 1.25rem;
    padding: 0 0.375rem;
    border-radius: 9999px;
    background: color-mix(in srgb, var(--accent) 12%, transparent);
    color: var(--fc-pill-fg);
    font-size: 0.6875rem;
    font-weight: 700;
    letter-spacing: 0;
  }

  .fp-section-label::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--fc-sep);
  }

  section:first-of-type .fp-section-label {
    margin-top: 0;
  }

  /* ===== Grid ===== */
  .fp-grid {
    display: grid;
    gap: 1rem;
    grid-template-columns: 1fr;
  }
  @media (min-width: 560px) {
    .fp-grid { grid-template-columns: repeat(2, 1fr); }
  }
  @media (min-width: 900px) {
    .fp-grid { grid-template-columns: repeat(3, 1fr); }
  }
  /* (self-banner replaces fp-grid--single) */

  /* ===== Card ===== */
  @keyframes cardIn {
    from { opacity: 0; transform: translateY(10px) scale(0.97); }
    to   { opacity: 1; transform: translateY(0)    scale(1); }
  }

  .fc {
    position: relative;
    display: flex;
    flex-direction: column;
    text-decoration: none;
    color: inherit;
    border-radius: 1rem;
    overflow: hidden;
    border: 1px solid var(--fc-border);
    background: var(--fc-bg);
    animation: cardIn 0.3s ease-out backwards;
    animation-delay: calc(var(--i, 0) * 35ms);
    transition:
      border-color 0.3s ease,
      box-shadow 0.3s ease,
      transform 0.3s ease;
  }

  .fc:hover {
    border-color: var(--fc-border-h);
    box-shadow:
      0 4px 24px -4px var(--fc-shadow),
      0 0 0 1px var(--fc-border-h);
    transform: translateY(-2px);
  }

  /* -- Back panel: avatar area ---------------------------------- */
  .fc-back {
    position: relative;
    height: 120px;
    flex-shrink: 0;
    background: var(--fc-bg);
    overflow: hidden;
  }

  /* Hover glow behind avatar */
  .fc-back::after {
    content: '';
    position: absolute;
    inset: 0;
    opacity: 0;
    transition: opacity 0.4s ease;
    background: radial-gradient(
      ellipse 70% 80% at 50% 50%,
      var(--fc-glow),
      transparent 70%
    );
    pointer-events: none;
  }
  .fc:hover .fc-back::after {
    opacity: 1;
  }

  .fc-avatar-area {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .fc-avatar {
    width: 72px;
    height: 72px;
    border-radius: 50%;
    object-fit: cover;
    border: 2.5px solid var(--fc-border);
    box-shadow: 0 6px 20px var(--fc-shadow);
    transition:
      transform 0.35s cubic-bezier(0.23, 1, 0.32, 1),
      border-color 0.3s ease;
    margin: 0 !important;
    padding: 0 !important;
  }

  .fc:hover .fc-avatar {
    transform: scale(1.08);
    border-color: var(--fc-border-h);
  }

  .fc-avatar-fb {
    width: 72px;
    height: 72px;
    border-radius: 50%;
    display: grid;
    place-items: center;
    background: var(--fc-bg-hover);
    border: 2.5px solid var(--fc-border);
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--fc-text-3);
    box-shadow: 0 6px 20px var(--fc-shadow);
  }

  /* -- Front panel ---------------------------------------------- */
  .fc-front {
    position: relative;
    z-index: 2;
    flex: 1;
    display: flex;
    flex-direction: column;
    background: var(--fc-glass);
    backdrop-filter: blur(16px) saturate(1.1);
    -webkit-backdrop-filter: blur(16px) saturate(1.1);
    border-top: 1px solid var(--fc-sep);
  }

  .fc-body {
    padding: 0.75rem 1rem 0.5rem;
    flex: 1;
  }

  .fc-name {
    margin: 0;
    font-size: 0.9375rem;
    font-weight: 600;
    line-height: 1.35;
    color: var(--fc-text-1);
    transition: color 0.2s ease;
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .fc:hover .fc-name {
    color: var(--foreground);
  }

  .fc-desc {
    margin: 0.2rem 0 0;
    font-size: 0.8125rem;
    line-height: 1.4;
    color: var(--fc-text-3);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    transition: color 0.2s ease;
  }

  .fc:hover .fc-desc {
    color: var(--fc-text-2);
  }

  .fc-tag-row {
    display: flex;
    gap: 0.375rem;
    margin-top: 0.375rem;
    overflow: hidden;
  }

  .fc-tag {
    display: inline-block;
    padding: 0.125rem 0.5rem;
    border-radius: 9999px;
    background: color-mix(in srgb, var(--accent) 8%, transparent);
    border: 1px solid color-mix(in srgb, var(--accent) 12%, transparent);
    font-size: 0.6875rem;
    color: var(--fc-pill-fg);
    white-space: nowrap;
    transition: all 0.2s ease;
  }

  .fc:hover .fc-tag {
    background: color-mix(in srgb, var(--accent) 12%, transparent);
    border-color: color-mix(in srgb, var(--accent) 20%, transparent);
  }

  /* -- Footer with host pill ------------------------------------ */
  .fc-foot {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.5rem;
    height: 38px;
    padding: 0 0.75rem;
    border-top: 1px solid var(--fc-sep);
  }

  .fc-host-pill {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    height: 1.5rem;
    padding: 0 0.625rem;
    border-radius: 9999px;
    border: 1px solid var(--fc-pill-bd);
    background: var(--fc-pill-bg);
    font-size: 0.6875rem;
    font-weight: 500;
    color: var(--fc-pill-fg);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
    transition: all 0.2s ease;
  }

  .fc:hover .fc-host-pill {
    border-color: color-mix(in srgb, var(--accent) 35%, transparent);
    background: color-mix(in srgb, var(--accent) 12%, var(--background));
  }

  .fc-favicon {
    width: 14px;
    height: 14px;
    border-radius: 2px;
    flex-shrink: 0;
    object-fit: contain;
    margin: 0 !important;
    padding: 0 !important;
    border: none !important;
    opacity: 0.8;
  }

  .fc-arrow {
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    width: 22px;
    height: 22px;
    border-radius: 6px;
    color: var(--fc-text-4);
    background: transparent;
    transition: all 0.2s ease;
  }

  .fc:hover .fc-arrow {
    color: var(--accent);
    background: color-mix(in srgb, var(--accent) 10%, transparent);
    transform: translate(1px, -1px);
  }

  /* -- Variant: org --------------------------------------------- */
  .fc--org {
    border-color: color-mix(in srgb, var(--accent) 12%, transparent);
  }
  .fc--org:hover {
    border-color: color-mix(in srgb, var(--accent) 30%, transparent);
  }

  /* ===== Self-info banner ======================================= */
  .self-banner {
    display: flex;
    align-items: center;
    gap: 1.25rem;
    position: relative;
    padding: 1.25rem 1.5rem;
    border-radius: 1rem;
    border: 1px solid color-mix(in srgb, var(--accent) 18%, transparent);
    background:
      linear-gradient(
        135deg,
        color-mix(in srgb, var(--accent) 6%, var(--background)),
        color-mix(in srgb, var(--accent) 2%, var(--background))
      );
    text-decoration: none;
    color: inherit;
    overflow: hidden;
    transition:
      border-color 0.3s ease,
      box-shadow 0.3s ease,
      transform 0.3s ease;
  }

  .self-banner:hover {
    border-color: color-mix(in srgb, var(--accent) 40%, transparent);
    box-shadow:
      0 4px 24px -4px var(--fc-shadow),
      0 0 0 1px color-mix(in srgb, var(--accent) 20%, transparent);
    transform: translateY(-2px);
  }

  .self-banner-glow {
    position: absolute;
    top: -40%;
    left: -10%;
    width: 50%;
    height: 180%;
    background: radial-gradient(
      ellipse at center,
      color-mix(in srgb, var(--accent) 8%, transparent),
      transparent 70%
    );
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.4s ease;
  }

  .self-banner:hover .self-banner-glow {
    opacity: 1;
  }

  .self-banner-avatar {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    object-fit: cover;
    flex-shrink: 0;
    border: 2px solid color-mix(in srgb, var(--accent) 25%, transparent);
    box-shadow: 0 4px 16px var(--fc-shadow);
    transition:
      transform 0.3s cubic-bezier(0.23, 1, 0.32, 1),
      border-color 0.3s ease;
    margin: 0 !important;
    padding: 0 !important;
  }

  .self-banner:hover .self-banner-avatar {
    transform: scale(1.08);
    border-color: color-mix(in srgb, var(--accent) 50%, transparent);
  }

  .self-banner-content {
    flex: 1;
    min-width: 0;
    position: relative;
    z-index: 1;
  }

  .self-banner-name {
    margin: 0;
    font-size: 1rem;
    font-weight: 600;
    color: var(--fc-text-1);
    transition: color 0.2s ease;
  }

  .self-banner:hover .self-banner-name {
    color: var(--foreground);
  }

  .self-banner-desc {
    margin: 0.125rem 0 0;
    font-size: 0.8125rem;
    line-height: 1.4;
    color: var(--fc-text-3);
    transition: color 0.2s ease;
  }

  .self-banner:hover .self-banner-desc {
    color: var(--fc-text-2);
  }

  .self-banner-link {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-shrink: 0;
    position: relative;
    z-index: 1;
  }

  .self-banner-arrow {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    border-radius: 8px;
    color: var(--fc-text-4);
    background: transparent;
    transition: all 0.2s ease;
  }

  .self-banner:hover .self-banner-arrow {
    color: var(--accent);
    background: color-mix(in srgb, var(--accent) 10%, transparent);
    transform: translate(1px, -1px);
  }

  @media (max-width: 559px) {
    .self-banner {
      flex-wrap: wrap;
      gap: 0.75rem;
      padding: 1rem;
    }

    .self-banner-avatar {
      width: 48px;
      height: 48px;
    }

    .self-banner-content {
      flex-basis: calc(100% - 60px);
    }

    .self-banner-link {
      width: 100%;
      padding-top: 0.5rem;
      border-top: 1px solid var(--fc-sep);
    }
  }

  /* ===== Mobile ===== */
  @media (max-width: 559px) {
    .fp-heading {
      font-size: 1.25rem;
    }
    .fc-back {
      height: 100px;
    }
    .fc-avatar,
    .fc-avatar-fb {
      width: 60px;
      height: 60px;
    }
    .fc-avatar-fb {
      font-size: 1.375rem;
    }
    .fc-body {
      padding: 0.625rem 0.75rem 0.375rem;
    }
    .fc-foot {
      padding: 0 0.625rem;
      height: 34px;
    }
  }

  /* ===== Reduced motion ===== */
  @media (prefers-reduced-motion: reduce) {
    .fc {
      animation: none !important;
      transition: none !important;
    }
    .fc-avatar {
      transition: none !important;
    }
  }
</style>
