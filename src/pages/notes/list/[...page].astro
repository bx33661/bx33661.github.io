---
import TerminalNoteCard from '@/components/terminal/TerminalNoteCard.astro'
import PageHead from '@/components/PageHead.astro'
import Layout from '@/layouts/Layout.astro'
import { getAllNoteSlugs } from '@/lib/data-utils'
import type { PaginateFunction } from 'astro'

export async function getStaticPaths({
  paginate,
}: {
  paginate: PaginateFunction
}) {
  const allNoteSlugs = await getAllNoteSlugs()
  return paginate(allNoteSlugs, { pageSize: 10 })
}

const { page } = Astro.props
const currentUrl = Astro.url
const pageTitle = page.currentPage === 1 ? '学习笔记' : `学习笔记 - 第 ${page.currentPage} 页`
const pageNumbers = Array.from({ length: page.lastPage }, (_, index) => index + 1)
const noteEntries = page.data as Awaited<ReturnType<typeof getAllNoteSlugs>>

const buildPageLink = (pageNumber: number) => {
  if (pageNumber <= 1) return '/notes/list/'
  return `/notes/list/${pageNumber}/`
}
---

<Layout canonicalUrl={currentUrl}>
  <PageHead slot="head" title={pageTitle} description="学习笔记分页列表。" canonicalURL={currentUrl.toString()} />

  <div class="posts">
    <h1 class="posts-title">学习笔记列表</h1>
    {noteEntries.map(({ note, slug }) => (
      <TerminalNoteCard note={note} slug={slug} />
    ))}
  </div>

  {page.lastPage > 1 && (
    <div class="pagination">
      <div class="pagination__title">
        <span class="pagination__title-h">Page {page.currentPage} / {page.lastPage}</span>
        <hr />
      </div>
      <div class="pagination__buttons">
        {page.url.prev && <a href={page.url.prev} class="button inline prev">&lt; [上一页]</a>}
        {pageNumbers.map((pageNumber) => (
          <a href={buildPageLink(pageNumber)} class={`button number ${pageNumber === page.currentPage ? 'active' : ''}`}>
            {pageNumber}
          </a>
        ))}
        {page.url.next && <a href={page.url.next} class="button inline next">[下一页] &gt;</a>}
      </div>
    </div>
  )}
</Layout>
