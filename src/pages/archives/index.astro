---
import { getCollection } from "astro:content";
import Breadcrumb from "@/components/Breadcrumb.astro";
import Footer from "@/components/Footer.astro";
import Header from "@/components/Header.astro";
import { SITE } from "@/config.ts";
import Layout from "@/layouts/Layout.astro";
import { resolveLegacyPostSlug } from "@/utils/legacySlug";

const posts = await getCollection("blog", ({ data }) => !data.draft);
const sortedPosts = posts
  .slice()
  .sort((a, b) => b.data.pubDatetime.valueOf() - a.data.pubDatetime.valueOf());

const monthFormatter = new Intl.DateTimeFormat("zh-CN", { month: "long" });
const dayFormatter = new Intl.DateTimeFormat("zh-CN", { month: "2-digit", day: "2-digit" });

const postMap = new Map<number, Map<number, typeof sortedPosts>>();

for (const post of sortedPosts) {
  const year = post.data.pubDatetime.getFullYear();
  const month = post.data.pubDatetime.getMonth();

  if (!postMap.has(year)) {
    postMap.set(year, new Map());
  }

  const monthMap = postMap.get(year)!;
  const monthPosts = monthMap.get(month) ?? [];
  monthPosts.push(post);
  monthMap.set(month, monthPosts);
}

const archiveYears = Array.from(postMap.entries())
  .sort((a, b) => b[0] - a[0])
  .map(([year, monthMap]) => {
    const months = Array.from(monthMap.entries())
      .sort((a, b) => b[0] - a[0])
      .map(([month, monthPosts]) => ({
        month,
        label: monthFormatter.format(new Date(year, month, 1)),
        posts: monthPosts,
      }));

    return {
      year,
      months,
      total: months.reduce((acc, monthItem) => acc + monthItem.posts.length, 0),
    };
  });

const yearCount = archiveYears.length;
---

<Layout
  title={`归档 | ${SITE.title}`}
  description="按时间整理的全部文章与更新记录。"
  canonicalURL={Astro.url.toString()}
>
  <Header />
  <Breadcrumb />

  <main id="main-content" class="app-layout arc-main">

    <!-- ===== Hero ===== -->
    <div class="arc-hero" data-arc-hero>
      <div class="arc-orb arc-orb-1" aria-hidden="true"></div>
      <div class="arc-orb arc-orb-2" aria-hidden="true"></div>
      <div class="arc-mouse-follow" data-arc-mouse aria-hidden="true"></div>

      <div class="arc-hero-inner">
        <div class="arc-hero-left">
          <span class="arc-eyebrow">Archive</span>
          <h1 class="arc-title">归档</h1>
          <p class="arc-subtitle">
            按时间整理我发布过的内容，<br class="hidden sm:block" />方便回看与检索。
          </p>
        </div>
        <div class="arc-stats">
          <div class="arc-stat">
            <span class="arc-stat-value">{sortedPosts.length}</span>
            <span class="arc-stat-label">篇文章</span>
          </div>
          <div class="arc-stat-sep" aria-hidden="true"></div>
          <div class="arc-stat">
            <span class="arc-stat-value">{yearCount}</span>
            <span class="arc-stat-label">年</span>
          </div>
          <div class="arc-stat-sep" aria-hidden="true"></div>
          <div class="arc-stat">
            <span class="arc-stat-value">
              {archiveYears.reduce((a, y) => a + y.months.length, 0)}
            </span>
            <span class="arc-stat-label">月份</span>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== Jump bar ===== -->
    <nav class="arc-jumpbar" aria-label="按年份快速跳转">
      {archiveYears.map(y => (
        <a href={`#year-${y.year}`} class="arc-jump-pill">
          {y.year}
          <span class="arc-jump-count">{y.total}</span>
        </a>
      ))}
    </nav>

    <!-- ===== Timeline ===== -->
    <div class="arc-timeline">
      {archiveYears.map((yearItem, yi) => (
        <section class="arc-year-block" id={`year-${yearItem.year}`} style={`--yi:${yi}`}>

          <!-- Year anchor -->
          <div class="arc-year-anchor" aria-hidden="true">
            <div class="arc-year-line"></div>
            <div class="arc-year-badge">
              <span>{yearItem.year}</span>
            </div>
          </div>

          <!-- Months -->
          <div class="arc-months">
            {yearItem.months.map((monthItem, mi) => (
              <div class="arc-month-group" style={`--mi:${mi}`}>

                <!-- Month header -->
                <div class="arc-month-head">
                  <span class="arc-month-label">{monthItem.label}</span>
                  <span class="arc-month-count">{monthItem.posts.length}</span>
                  <div class="arc-month-rule" aria-hidden="true"></div>
                </div>

                <!-- Post list -->
                <ul class="arc-post-list" role="list">
                  {monthItem.posts.map((post, pi) => (
                    <li class="arc-post-item" style={`--pi:${pi}`}>
                      <a href={`/blog/${resolveLegacyPostSlug(post)}/`} class="arc-post-link" data-arc-card>
                        <div class="arc-post-glow" aria-hidden="true"></div>
                        <div class="arc-post-date" aria-label={`发布日期 ${post.data.pubDatetime.getDate()}`}>
                          <span class="arc-post-day">{post.data.pubDatetime.getDate().toString().padStart(2, "0")}</span>
                          <span class="arc-post-dow">
                            {["日","一","二","三","四","五","六"][post.data.pubDatetime.getDay()]}
                          </span>
                        </div>
                        <div class="arc-post-divider" aria-hidden="true"></div>
                        <div class="arc-post-body">
                          <h3 class="arc-post-title">{post.data.title}</h3>
                          {post.data.description && (
                            <p class="arc-post-desc">{post.data.description}</p>
                          )}
                          {post.data.tags && post.data.tags.length > 0 && (
                            <div class="arc-post-tags" aria-label="标签">
                              {post.data.tags.slice(0, 3).map((tag: string) => (
                                <span class="arc-tag">{tag}</span>
                              ))}
                            </div>
                          )}
                        </div>
                        <div class="arc-post-arrow" aria-hidden="true">
                          <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
                            <path d="M3.5 10.5L10.5 3.5M10.5 3.5H5M10.5 3.5V9" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
                          </svg>
                        </div>
                      </a>
                    </li>
                  ))}
                </ul>

              </div>
            ))}
          </div>
        </section>
      ))}
    </div>

  </main>

  <Footer />
</Layout>

<script>
  let arcCleanup: AbortController | null = null;

  document.addEventListener("astro:page-load", () => {
    if (arcCleanup) arcCleanup.abort();
    arcCleanup = new AbortController();
    const { signal } = arcCleanup;

    // Hero mouse-follow
    const hero = document.querySelector("[data-arc-hero]") as HTMLElement;
    const heroMouse = document.querySelector("[data-arc-mouse]") as HTMLElement;
    if (hero && heroMouse) {
      hero.addEventListener("mousemove", e => {
        requestAnimationFrame(() => {
          const rect = hero.getBoundingClientRect();
          heroMouse.style.setProperty("--mx", `${e.clientX - rect.left}px`);
          heroMouse.style.setProperty("--my", `${e.clientY - rect.top}px`);
          heroMouse.style.opacity = "1";
        });
      }, { signal });
      hero.addEventListener("mouseleave", () => {
        heroMouse.style.opacity = "0";
      }, { signal });
    }

    // Card mouse-glow
    const cards = document.querySelectorAll("[data-arc-card]");
    cards.forEach(card => {
      const glow = card.querySelector(".arc-post-glow") as HTMLElement;
      if (!glow) return;
      card.addEventListener("mousemove", e => {
        requestAnimationFrame(() => {
          const rect = (card as HTMLElement).getBoundingClientRect();
          glow.style.setProperty("--mx", `${(e as MouseEvent).clientX - rect.left}px`);
          glow.style.setProperty("--my", `${(e as MouseEvent).clientY - rect.top}px`);
          glow.style.opacity = "1";
        });
      }, { signal });
      card.addEventListener("mouseleave", () => {
        glow.style.opacity = "0";
      }, { signal });
    });
  });
</script>

<style>
  /* ===========================
     Main Layout
  =========================== */
  .arc-main {
    padding-top: 0.25rem;
    padding-bottom: 5rem;
  }

  /* ===========================
     Hero
  =========================== */
  .arc-hero {
    position: relative;
    overflow: hidden;
    border-radius: 1.5rem;
    border: 1px solid color-mix(in srgb, var(--accent) 14%, transparent);
    background: color-mix(in srgb, var(--foreground) 3%, var(--background));
    padding: 2.5rem 2rem;
    margin-bottom: 1.25rem;
    isolation: isolate;
  }

  @media (min-width: 640px) {
    .arc-hero { padding: 3rem 2.5rem; }
  }

  /* aurora orbs */
  .arc-orb {
    position: absolute;
    border-radius: 50%;
    filter: blur(70px);
    pointer-events: none;
    will-change: transform;
  }

  .arc-orb-1 {
    width: 340px; height: 340px;
    top: -30%; left: -8%;
    background: radial-gradient(circle,
      color-mix(in srgb, var(--accent) 28%, transparent),
      transparent 70%
    );
    animation: arc-drift-a 8s ease-in-out infinite alternate;
  }

  .arc-orb-2 {
    width: 260px; height: 260px;
    top: 10%; right: -6%;
    background: radial-gradient(circle,
      color-mix(in srgb, var(--border) 22%, transparent),
      transparent 70%
    );
    animation: arc-drift-b 10s ease-in-out infinite alternate;
  }

  @keyframes arc-drift-a {
    to { transform: translate(35px, 18px) scale(1.18); }
  }
  @keyframes arc-drift-b {
    to { transform: translate(-25px, 28px) scale(1.12); }
  }

  /* mouse follower */
  .arc-mouse-follow {
    position: absolute;
    width: 360px; height: 360px;
    border-radius: 50%;
    background: radial-gradient(circle,
      color-mix(in srgb, var(--accent) 20%, transparent),
      color-mix(in srgb, var(--border) 8%, transparent) 40%,
      transparent 70%
    );
    filter: blur(55px);
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.4s ease;
    transform: translate(calc(var(--mx, 0px) - 180px), calc(var(--my, 0px) - 180px));
    will-change: transform;
    z-index: 0;
  }

  .arc-hero-inner {
    position: relative;
    z-index: 1;
    display: flex;
    flex-wrap: wrap;
    align-items: flex-end;
    justify-content: space-between;
    gap: 2rem;
  }

  .arc-eyebrow {
    display: inline-flex;
    align-items: center;
    height: 26px;
    padding: 0 12px;
    border-radius: 999px;
    border: 1px solid color-mix(in srgb, var(--accent) 30%, transparent);
    background: color-mix(in srgb, var(--accent) 9%, transparent);
    font-size: 0.72rem;
    font-weight: 700;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: color-mix(in srgb, var(--accent) 85%, var(--foreground));
  }

  .arc-title {
    margin: 0.7rem 0 0;
    font-size: clamp(2.2rem, 4vw, 3.2rem);
    font-weight: 800;
    line-height: 1.06;
    letter-spacing: -0.025em;
    background: linear-gradient(135deg, var(--foreground), color-mix(in srgb, var(--accent) 70%, var(--foreground)));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .arc-subtitle {
    margin: 0.75rem 0 0;
    font-size: 0.97rem;
    line-height: 1.65;
    color: color-mix(in srgb, var(--foreground) 68%, transparent);
    max-width: 38ch;
  }

  /* Stats row */
  .arc-stats {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    padding: 1.1rem 1.5rem;
    border-radius: 1rem;
    border: 1px solid color-mix(in srgb, var(--foreground) 10%, transparent);
    background: color-mix(in srgb, var(--background) 88%, transparent);
    backdrop-filter: blur(12px);
    flex-shrink: 0;
  }

  .arc-stat {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.18rem;
  }

  .arc-stat-value {
    font-size: 1.7rem;
    font-weight: 800;
    line-height: 1;
    color: var(--accent);
    font-variant-numeric: tabular-nums;
  }

  .arc-stat-label {
    font-size: 0.73rem;
    font-weight: 600;
    letter-spacing: 0.04em;
    color: color-mix(in srgb, var(--foreground) 52%, transparent);
    text-transform: uppercase;
  }

  .arc-stat-sep {
    width: 1px;
    height: 2.2rem;
    background: color-mix(in srgb, var(--foreground) 12%, transparent);
    border-radius: 999px;
  }

  /* ===========================
     Jump bar
  =========================== */
  .arc-jumpbar {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 2.5rem;
  }

  .arc-jump-pill {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    height: 2rem;
    padding: 0 0.85rem;
    border-radius: 999px;
    border: 1px solid color-mix(in srgb, var(--foreground) 10%, transparent);
    background: color-mix(in srgb, var(--foreground) 4%, var(--background));
    font-size: 0.82rem;
    font-weight: 600;
    color: color-mix(in srgb, var(--foreground) 72%, transparent);
    text-decoration: none;
    transition: border-color 0.2s ease, color 0.2s ease, background 0.2s ease;
  }

  .arc-jump-pill:hover {
    border-color: color-mix(in srgb, var(--accent) 38%, transparent);
    color: var(--accent);
    background: color-mix(in srgb, var(--accent) 8%, var(--background));
  }

  .arc-jump-count {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 1.2rem;
    height: 1.2rem;
    padding: 0 0.3rem;
    border-radius: 999px;
    background: color-mix(in srgb, var(--accent) 12%, transparent);
    color: var(--accent);
    font-size: 0.68rem;
    font-weight: 700;
  }

  /* ===========================
     Timeline
  =========================== */
  .arc-timeline {
    display: grid;
    gap: 3.5rem;
  }

  /* Year block */
  .arc-year-block {
    display: grid;
    grid-template-columns: 5.5rem 1fr;
    gap: 0 2rem;
    animation: arc-fade-up 0.5s ease-out backwards;
    animation-delay: calc(var(--yi, 0) * 80ms);
  }

  @keyframes arc-fade-up {
    from { opacity: 0; transform: translateY(16px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  /* Year anchor column */
  .arc-year-anchor {
    position: relative;
    padding-top: 0.15rem;
  }

  .arc-year-line {
    position: absolute;
    top: 2.8rem;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 1px;
    background: linear-gradient(
      to bottom,
      color-mix(in srgb, var(--accent) 22%, transparent),
      color-mix(in srgb, var(--foreground) 6%, transparent) 80%,
      transparent 100%
    );
  }

  .arc-year-badge {
    position: sticky;
    top: 4.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 5rem;
    height: 5rem;
    border-radius: 1.1rem;
    border: 1px solid color-mix(in srgb, var(--accent) 22%, transparent);
    background: color-mix(in srgb, var(--accent) 8%, var(--background));
    font-size: 1.35rem;
    font-weight: 800;
    color: color-mix(in srgb, var(--accent) 78%, var(--foreground));
    letter-spacing: -0.03em;
    writing-mode: horizontal-tb;
  }

  /* Month groups */
  .arc-months {
    display: grid;
    gap: 2rem;
  }

  .arc-month-group {
    animation: arc-fade-up 0.45s ease-out backwards;
    animation-delay: calc(var(--mi, 0) * 60ms + 0.08s);
  }

  /* Month header */
  .arc-month-head {
    display: flex;
    align-items: center;
    gap: 0.65rem;
    margin-bottom: 0.85rem;
  }

  .arc-month-label {
    font-size: 0.8rem;
    font-weight: 700;
    letter-spacing: 0.07em;
    text-transform: uppercase;
    color: color-mix(in srgb, var(--accent) 82%, var(--foreground));
    white-space: nowrap;
  }

  .arc-month-count {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 1.35rem;
    height: 1.35rem;
    padding: 0 0.38rem;
    border-radius: 999px;
    background: color-mix(in srgb, var(--accent) 10%, transparent);
    border: 1px solid color-mix(in srgb, var(--accent) 18%, transparent);
    font-size: 0.7rem;
    font-weight: 700;
    color: var(--accent);
  }

  .arc-month-rule {
    flex: 1;
    height: 1px;
    background: color-mix(in srgb, var(--foreground) 9%, transparent);
    border-radius: 999px;
  }

  /* Post list */
  .arc-post-list {
    list-style: none;
    margin: 0;
    padding: 0;
    display: grid;
    gap: 0.6rem;
  }

  .arc-post-item {
    animation: arc-fade-up 0.4s ease-out backwards;
    animation-delay: calc(var(--pi, 0) * 40ms + 0.1s);
  }

  /* Post card */
  .arc-post-link {
    position: relative;
    display: grid;
    grid-template-columns: 3.2rem 1px 1fr auto;
    align-items: center;
    gap: 0 1rem;
    padding: 0.9rem 1rem;
    border-radius: 1rem;
    border: 1px solid color-mix(in srgb, var(--foreground) 7%, transparent);
    background: color-mix(in srgb, var(--foreground) 2%, var(--background));
    text-decoration: none;
    color: inherit;
    overflow: hidden;
    isolation: isolate;
    transition:
      border-color 0.25s ease,
      transform 0.25s cubic-bezier(0.23, 1, 0.32, 1),
      box-shadow 0.25s ease;
  }

  .arc-post-link:hover {
    border-color: color-mix(in srgb, var(--accent) 28%, transparent);
    transform: translateY(-2px);
    box-shadow:
      0 8px 32px -8px color-mix(in srgb, var(--accent) 14%, transparent),
      0 0 0 1px color-mix(in srgb, var(--accent) 8%, transparent);
  }

  /* mouse glow inside card */
  .arc-post-glow {
    position: absolute;
    inset: 0;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.35s ease;
    background: radial-gradient(
      180px circle at var(--mx, 50%) var(--my, 50%),
      color-mix(in srgb, var(--accent) 14%, transparent),
      transparent 70%
    );
    z-index: -1;
  }

  /* Date column */
  .arc-post-date {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.1rem;
    flex-shrink: 0;
  }

  .arc-post-day {
    font-size: 1.55rem;
    font-weight: 800;
    line-height: 1;
    font-variant-numeric: tabular-nums;
    color: color-mix(in srgb, var(--accent) 55%, var(--foreground));
    transition: color 0.2s ease;
  }

  .arc-post-link:hover .arc-post-day {
    color: var(--accent);
  }

  .arc-post-dow {
    font-size: 0.68rem;
    font-weight: 600;
    letter-spacing: 0.05em;
    color: color-mix(in srgb, var(--foreground) 38%, transparent);
    text-transform: uppercase;
  }

  /* Vertical divider */
  .arc-post-divider {
    height: 2.8rem;
    width: 1px;
    background: color-mix(in srgb, var(--foreground) 8%, transparent);
    border-radius: 999px;
    flex-shrink: 0;
    align-self: center;
    transition: background 0.2s ease;
  }

  .arc-post-link:hover .arc-post-divider {
    background: color-mix(in srgb, var(--accent) 22%, transparent);
  }

  /* Body */
  .arc-post-body {
    min-width: 0;
  }

  .arc-post-title {
    margin: 0;
    font-size: 1rem;
    font-weight: 600;
    line-height: 1.35;
    color: color-mix(in srgb, var(--foreground) 94%, transparent);
    transition: color 0.2s ease;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .arc-post-link:hover .arc-post-title {
    color: var(--foreground);
  }

  .arc-post-desc {
    margin: 0.28rem 0 0;
    font-size: 0.84rem;
    line-height: 1.5;
    color: color-mix(in srgb, var(--foreground) 52%, transparent);
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* Tags */
  .arc-post-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.35rem;
    margin-top: 0.55rem;
  }

  .arc-tag {
    display: inline-block;
    padding: 0.12rem 0.55rem;
    border-radius: 999px;
    border: 1px solid color-mix(in srgb, var(--accent) 14%, transparent);
    background: color-mix(in srgb, var(--accent) 7%, transparent);
    font-size: 0.68rem;
    font-weight: 600;
    color: color-mix(in srgb, var(--accent) 80%, var(--foreground));
    transition: background 0.2s ease, border-color 0.2s ease;
  }

  .arc-post-link:hover .arc-tag {
    background: color-mix(in srgb, var(--accent) 13%, transparent);
    border-color: color-mix(in srgb, var(--accent) 25%, transparent);
  }

  /* Arrow */
  .arc-post-arrow {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    border-radius: 8px;
    flex-shrink: 0;
    color: color-mix(in srgb, var(--foreground) 30%, transparent);
    background: transparent;
    transition: color 0.2s ease, background 0.2s ease, transform 0.2s ease;
  }

  .arc-post-link:hover .arc-post-arrow {
    color: var(--accent);
    background: color-mix(in srgb, var(--accent) 10%, transparent);
    transform: translate(2px, -2px);
  }

  /* ===========================
     Responsive
  =========================== */
  @media (max-width: 680px) {
    .arc-hero { padding: 1.75rem 1.25rem; }

    .arc-stats {
      gap: 1rem;
      padding: 0.85rem 1rem;
    }

    .arc-stat-value { font-size: 1.35rem; }

    .arc-year-block {
      grid-template-columns: 4rem 1fr;
      gap: 0 1.25rem;
    }

    .arc-year-badge {
      width: 4rem;
      height: 4rem;
      font-size: 1.05rem;
      border-radius: 0.85rem;
    }

    .arc-post-link {
      grid-template-columns: 2.6rem 1px 1fr auto;
      gap: 0 0.75rem;
      padding: 0.75rem 0.8rem;
    }

    .arc-post-day { font-size: 1.25rem; }

    .arc-post-divider { height: 2.2rem; }

    .arc-post-title { font-size: 0.92rem; }

    .arc-post-desc { display: none; }
  }

  @media (max-width: 420px) {
    .arc-year-block {
      grid-template-columns: 3.2rem 1fr;
      gap: 0 0.9rem;
    }

    .arc-year-badge {
      width: 3.2rem;
      height: 3.2rem;
      font-size: 0.9rem;
      border-radius: 0.7rem;
    }

    .arc-post-arrow { display: none; }
  }

  @media (prefers-reduced-motion: reduce) {
    .arc-year-block,
    .arc-month-group,
    .arc-post-item {
      animation: none !important;
    }

    .arc-post-link {
      transition: none !important;
    }

    .arc-orb-1, .arc-orb-2 {
      animation: none !important;
    }
  }
</style>
